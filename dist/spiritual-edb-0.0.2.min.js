/*
 * Spiritual EDB 0.0.2
 * (c) 2013 Wunderbyte
 * Spiritual is freely distributable under the MIT license.
 */
window.edb=gui.namespace("edb",{toString:function(){return"[namespace edb]"},BROADCAST_GETTER:"edb-broadcast-getter",BROADCAST_SETTER:"edb-broadcast-setter",BROADCAST_OUTPUT:"edb-broadcast-output",BROADCAST_FUNCTION_LOADED:"edb-broadcast-function-loaded",BROADCAST_TAG_LOADED:"edb-broadcast-tag-loaded",BROADCAST_SCRIPT_INVOKE:"edb-broadcast-script-invoke",LIFE_SCRIPT_WILL_RUN:"edb-life-script-will-run",LIFE_SCRIPT_DID_RUN:"edb-life-script-did-run",TICK_SCRIPT_UPDATE:"edb-tick-script-update",TICK_COLLECT_INPUT:"edb-tick-collect-input"}),edb.Type=function(){},edb.Type.prototype={$primarykey:"id",_instanceid:null,onconstruct:function(){},$stringify:function(filter,tabber){return JSON.stringify(this.$normalize(),filter,tabber)}},edb.Type.getter=gui.Combo.before(function(){gui.Broadcast.dispatchGlobal(this,edb.BROADCAST_GETTER,this._instanceid)}),edb.Type.setter=gui.Combo.after(function(){gui.Broadcast.dispatchGlobal(this,edb.BROADCAST_SETTER,this._instanceid)}),edb.Type.decorateGetters=function(proto,methods){return methods.forEach(function(method){proto[method]=edb.Type.getter(proto[method])}),proto},edb.Type.decorateSetters=function(proto,methods){return methods.forEach(function(method){proto[method]=edb.Type.setter(proto[method])}),proto},edb.Type.underscoreinstanceid=function(instance){Object.defineProperty(instance,"_instanceid",{value:instance.$instanceid})},edb.Type.isInstance=function(o){return gui.Type.isComplex(o)?o instanceof edb.Object||o instanceof edb.Array:!1},edb.Type.lookup=function(context,arg){var type=null;switch(gui.Type.of(arg)){case"function":type=arg;break;case"string":type=gui.Object.lookup(arg,context);break;case"object":console.error(this+": expected edb.Type constructor (not an object)")}if(!type)throw new TypeError('The type "'+arg+'" does not exist');return type},edb.Object=gui.Class.create("edb.Object",Object.prototype,{$onconstruct:function(data){switch(edb.Type.underscoreinstanceid(this),gui.Type.of(data)){case"object":case"undefined":edb.Object.approximate(this,data||Object.create(null));break;default:throw new TypeError("Unexpected argument of type "+gui.Type.of(data))}this.onconstruct.apply(this,arguments)},$normalize:function(){var c,o=Object.create(null);return gui.Object.each(this,function(key,value){c=key[0],"$"!==c&&"_"!==c&&edb.Type.isInstance(value)&&(value=value.$normalize()),o[key]=value}),o}},{},{approximate:function(handler,proxy){var def,Def,instances=Object.create(null);this._definitions(handler).forEach(function(key){def=handler[key],gui.Type.isComplex(def)?gui.Type.isConstructor(def)&&(Def=def,instances[key]=new Def(proxy[key])):gui.Type.isDefined(proxy[key])||(proxy[key]=handler[key])}),gui.Object.nonmethods(proxy).forEach(function(key){switch(gui.Type.of(def=proxy[key])){case"object":handler[key]=new edb.Object(def);break;case"array":handler[key]=new edb.Array(def);break;default:gui.Property.accessor(handler,key,{getter:edb.Type.getter(function(){return instances[key]||proxy[key]}),setter:edb.Type.setter(function(value){var target=instances[key]?instances:proxy;target[key]=value})})}})},_definitions:function(handler){var keys=[];return gui.Object.all(handler,function(key){gui.Type.isDefined(Object.prototype[key])||gui.Type.isDefined(edb.Type.prototype[key])||key.startsWith("_")||keys.push(key)}),keys}}),function(){gui.Object.extend(edb.Object.prototype,edb.Type.prototype)}(),edb.Array=gui.Class.create("edb.Array",Array.prototype,{$of:null,$onconstruct:function(){if(edb.Type.underscoreinstanceid(this),arguments.length){var args=[];gui.Type.isArray(arguments[0])?args=arguments[0]:Array.forEach(arguments,function(arg){args.push(arg)});var type=this.$of;gui.Type.isFunction(type)&&(args=args.map(function(o){if(void 0!==o&&!o._instanceid){var Type=type;gui.Type.isConstructor(Type)||(Type=type(o)),o=new Type(o)}return o})),args.forEach(function(arg){Array.prototype.push.call(this,arg)},this)}edb.Array.approximate(this),this.onconstruct.call(this,arguments)},$normalize:function(){return Array.map(this,function(thing){return edb.Type.isInstance(thing)?thing.$normalize():thing})}},{},{approximate:function(handler,proxy){var def=null;proxy=proxy||Object.create(null),this._definitions(handler).forEach(function(key){switch(def=handler[key],gui.Type.of(def)){case"function":break;case"object":case"array":console.warn("TODO: complex stuff on edb.Array :)");break;default:gui.Type.isDefined(proxy[key])||(proxy[key]=handler[key])}}),gui.Object.nonmethods(proxy).forEach(function(key){Object.defineProperty(handler,key,{enumerable:!0,configurable:!0,get:edb.Type.getter(function(){return proxy[key]}),set:edb.Type.setter(function(value){proxy[key]=value})})})},_definitions:function(handler){var keys=[];for(var key in handler)this._define(key)&&keys.push(key);return keys},_define:function(key){return gui.Type.isNumber(gui.Type.cast(key))||gui.Type.isDefined(Array.prototype[key])||gui.Type.isDefined(edb.Type.prototype[key])||key.startsWith("_")?!1:!0}}),function(proto){"use strict";gui.Object.extend(proto,edb.Type.prototype),edb.Type.decorateGetters(proto,["filter","forEach","every","map","some","indexOf","lastIndexOf"]),edb.Type.decorateSetters(proto,["push","pop","shift","unshift","splice","reverse"]),proto.concat=function(other){var clone=new this.constructor;return this.forEach(function(o){clone.push(o)}),other.forEach(function(o){clone.push(o)}),clone}}(edb.Array.prototype),edb.Output={toString:function(){return"[object edb.Output]"},dispatch:function(context,data,Type){var input=edb.Input.format(context,data,Type);if(!(input instanceof edb.Input))throw new TypeError("Not an instance of edb.Input: "+input);if(!input.type)throw Error("edb.Input type is "+input.type);input.type.output=input,gui.Broadcast.dispatch(null,edb.BROADCAST_OUTPUT,input,context.gui.$contextid)}},edb.OutputPlugin=gui.Plugin.extend("edb.OutputPlugin",{dispatch:function(data,Type){edb.Output.dispatch(this.context,data,Type)},_format:function(data,Type){if(data instanceof edb.Input==!1){if(Type)Type=this._lookup(Type),data instanceof Type==!1&&(data=new Type(data));else if(data._instanceid)Type=data.constructor;else{switch(gui.Type.of(data)){case"object":Type=edb.Object.extend();break;case"array":Type=edb.Array.extend()}data=this._format(data,Type)}data=new edb.Input(Type,data)}return data},_lookup:function(arg){var type=null;switch(gui.Type.of(arg)){case"function":type=arg;break;case"string":type=gui.Object.lookup(arg,this.context);break;case"object":console.error(this+": expected edb.Type constructor (not an object)")}if(!type)throw new TypeError('The type "'+arg+'" does not exist');return type}}),edb.Input=function(type,data){this.type=type||null,this.data=data||null},edb.Input.prototype={type:null,data:null,toString:function(){return"[object edb.Input]"}},edb.Input.format=function(context,data,Type){if(data instanceof edb.Input==!1){if(Type)Type=edb.Type.lookup(context,Type),data instanceof Type==!1&&(data=new Type(data));else if(data._instanceid)Type=data.constructor;else{switch(gui.Type.of(data)){case"object":Type=edb.Object.extend();break;case"array":Type=edb.Array.extend()}data=this.format(data,Type)}data=new edb.Input(Type,data)}return data},edb.InputPlugin=gui.Tracker.extend("edb.InputPlugin",{done:!0,onconstruct:function(){this._super.onconstruct(),this._watches=[],this._matches=[]},add:gui.Combo.chained(function(arg,handler){this.done=!1,handler=handler?handler:this.spirit,arg=edb.InputPlugin._breakdown(arg,this.context),this._add(arg,handler),gui.Broadcast.add(edb.BROADCAST_OUTPUT,this,this.context.gui.$contextid)}),remove:gui.Combo.chained(function(arg,handler){handler=handler?handler:this.spirit,arg=edb.InputPlugin._breakdown(arg,this.context),this._remove(arg,handler),(this.done=this._matches.length===this._watches.length)&&gui.Broadcast.remove(edb.BROADCAST_OUTPUT,this,this.context.gui.$contextid)}),get:function(type){var types=this._matches.map(function(input){return input.data.constructor}),best=edb.InputPlugin._bestmatch(type,types),input=best?this._matches.filter(function(input){return input.type===best}).shift():null;return input?input.data:null},onbroadcast:function(b){b.type===edb.BROADCAST_OUTPUT&&this.match(b.data)},match:function(input){this._maybeinput(input)},_watches:null,_matches:null,_add:function(types,handler){types.forEach(function(type){this._watches.push(type),this._addchecks(type.$classid,[handler]),type.output&&gui.Tick.next(function(){this._todoname()},this)},this)},_remove:function(types,handler){types.forEach(function(type){var index=this._watches.indexOf(type);index>-1&&(this._watches.remove(index),this._removechecks(type.$classid,[handler]))},this)},_todoname:function(){this._watches.forEach(function(type){type.output instanceof edb.Input&&this._maybeinput(type.output)},this)},_maybeinput:function(input){var best=edb.InputPlugin._bestmatch(input.type,this._watches);best&&(this._updatematch(input),this.done=this._matches.length===this._watches.length,this._updatehandlers(input))},_updatematch:function(newinput){var matches=this._matches,types=matches.map(function(input){return input.type}),best=edb.InputPlugin._bestmatch(newinput.type,types);if(best){var oldinput=matches.filter(function(input){return input.type===best})[0],index=matches.indexOf(oldinput);matches[index]=newinput}else matches.push(newinput)},_updatehandlers:function(input){gui.Class.ancestorsAndSelf(input.type,function(Type){var list=this._trackedtypes[Type.$classid];list&&list.forEach(function(checks){var handler=checks[0];handler.oninput(input)})},this)}},{},{_breakdown:function(arg,context){switch(gui.Type.of(arg)){case"array":return this._breakarray(arg,context);default:return this._breakother(arg,context)}},_breakarray:function(array,context){return array.map(function(o){switch(gui.Type.of(o)){case"function":return o;case"string":return gui.Object.lookup(o,context);case"object":console.error("Expected function. Got object.")}},this)},_breakother:function(arg,context){switch(gui.Type.of(arg)){case"function":return[arg];case"string":return this._breakarray(arg.split(" "),context);case"object":console.error("Expected function. Got object.")}},_bestmatch:function(target,types){var best=null,rating=Number.MAX_VALUE;return this._rateall(target,types,function(type,rate){rate>-1&&rating>rate&&(best=type)}),best},_rateall:function(target,types,action){types.forEach(function(type){action(type,this._rateone(target,type))},this)},_rateone:function(target,type){if(target===type)return 0;var tops=gui.Class.ancestorsAndSelf(target),subs=gui.Class.descendantsAndSelf(target),itop=tops.indexOf(type),isub=subs.indexOf(type);return 0>itop?isub:itop}}),edb.ScriptPlugin=gui.Plugin.extend("edb.ScriptPlugin",{type:"text/edbml",src:null,loaded:!1,autorun:!0,ran:!1,diff:!0,debug:!1,extras:null,onconstruct:function(){this._super.onconstruct();var spirit=this.spirit;this.inputs=this.inputs.bind(this),spirit instanceof edb.ScriptSpirit?this.autorun=!1:this.diff&&(this._updater=new edb.UpdateManager(spirit)),this.src&&spirit.life.add(gui.LIFE_ENTER,this)},onlife:function(life){life.type===gui.LIFE_ENTER&&this.load(this.src)},inputs:function(type){return this._script.input.get(type)},load:function(src,type){edb.Template.load(this.context,src,type||this.type,function(script){this._onreadystatechange(script)},this)},compile:function(source,type,directives){edb.Template.compile(this.context,source,type||this.type,directives,function(script){this._onreadystatechange(script)},this)},run:function(){this.loaded?(this._script.pointer=this.spirit,this.write(this._script.run.apply(this._script,arguments))):console.error("Running uncompiled script")},input:function(data,Type){var input=edb.Input.format(this.context,data,Type);this._script?this._script.input.match(input):(this._doinput=this._doinput||[],this._doinput.push(input))},write:function(html){if(this.diff?this._updater.update(html):this.spirit.dom.html(html),this.ran=!0,this.spirit.life.dispatch(edb.LIFE_SCRIPT_DID_RUN,(this._latest=html)!==this._latest),this.context.gui.hosted){var temptick="temptick",sig=this.context.gui.$contextid;gui.Tick.one(temptick,this,sig).dispatch(temptick,0,sig)}},ontick:function(tick){"temptick"===tick.type&&this.spirit.action.dispatchGlobal(gui.ACTION_DOC_FIT)},_script:null,_updater:null,_doinput:null,_onreadystatechange:function(script){switch(this._script=this._script||script,script.readyState){case edb.Template.WAITING:if(this._doinput){for(;this._doinput.length;)this.input(this._doinput.shift());this._doinput=null}break;case edb.Template.READY:this.loaded||(this.loaded=!0,this.debug&&script.debug()),this.autorun&&this.run()}}},{lazy:!1}),edb.ScriptSpirit=gui.Spirit.infuse("edb.ScriptSpirit",{debug:!1,onconfigure:function(){this._super.onconfigure(),this.att.add("debug")},onatt:function(att){this._super.onatt(att),"debug"===att.name&&(this.debug=att.value)},onenter:function(){this._super.onenter(),this._plainscript()||this.dom.parent(gui.Spirit)&&this._initplugin()},_plainscript:function(){var is=!1;switch(this.att.get("type")){case null:case"text/ecmacript":case"text/javascript":case"application/javascript":case"application/x-javascript":is=!0}return is},_initplugin:function(){var src=this.att.get("src")||this.src,type=this.att.get("type")||this.type,parent=this.dom.parent(),extras=this.att.getmap(),plugin=parent.spirit.script;plugin.extras=extras,plugin.debug=this.debug,src?plugin.load(src,type,extras):plugin.compile(this.dom.text(),type,extras)}}),edb.ServiceSpirit=gui.Spirit.infuse("edb.ServiceSpirit",{onconstruct:function(){this._super.onconstruct();var type=this.att.get("type");if(!type)throw Error("TODO: formalize missing type somehow");var Type=gui.Object.lookup(type,this.window);this.att.get("href")?new gui.Request(this.element.href).acceptJSON().get(function(status,data){this.output.dispatch(new Type(data))},this):this.output.dispatch(new Type)}}),edb.Instruction=function(pi){this.atts=Object.create(null),this.type=pi.split("<?")[1].split(" ")[0];for(var hit,atexp=edb.Instruction._ATEXP;hit=atexp.exec(pi);){var n=hit[1],v=hit[2];this.atts[n]=gui.Type.cast(v)}},edb.Instruction.prototype={type:null,atts:null,toString:function(){return"[object edb.Instruction]"}},edb.Instruction.from=function(source){for(var pis=[],hit=null;hit=this._PIEXP.exec(source);)pis.push(new edb.Instruction(hit[0]));return pis},edb.Instruction.clean=function(source){return source.replace(this._PIEXP,"")},edb.Instruction._PIEXP=/<\?.[^>?]+\?>/g,edb.Instruction._ATEXP=/(\S+)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g,edb.Runner=function(){},edb.Runner.prototype={firstline:!1,lastline:!1,firstchar:!1,lastchar:!1,run:function(compiler,script,status,result){this._runlines(compiler,script.split("\n"),status,result)},ahead:function(string){var line=this._line,index=this._index,i=index+1,l=string.length;return line.length>index+l&&line.substring(i,i+l)===string},behind:function(string){var line=this._line,index=this._index,length=string.length,start=index-length;return start>=0&&line.substr(start,length)===string},lineahead:function(){return this._line.substring(this._index+1)},skipahead:function(){console.error("TODO")},_line:null,_index:-1,_runlines:function(compiler,lines,status,result){var stop=lines.length-1;lines.forEach(function(line,index){this.firstline=0===index,this.lastline=index===stop,this._runline(line,index,compiler,status,result)},this)},_runline:function(line,index,compiler,status,result){line=this._line=line.trim(),line.length&&(compiler.newline(line,this,status,result),this._runchars(compiler,line.split(""),status,result),compiler.endline(line,this,status,result))},_runchars:function(compiler,chars,status,result){var stop=chars.length-1;chars.forEach(function(c,i){this._index=i,this.firstchar=0===i,this.lastchar=i===stop,compiler.nextchar(c,this,status,result)},this)}},edb.Status=function(){this.conf=[]},edb.Status.MODE_JS="js",edb.Status.MODE_HTML="html",edb.Status.MODE_TAG="tag",edb.Status.prototype={mode:edb.Status.MODE_JS,peek:!1,poke:!1,cont:!1,adds:!1,func:null,conf:null,skip:0,last:0,spot:0,indx:0,refs:!1,isjs:function(){return this.mode===edb.Status.MODE_JS},ishtml:function(){return this.mode===edb.Status.MODE_HTML},istag:function(){return this.mode===edb.Status.MODE_TAG},gojs:function(){this.mode=edb.Status.MODE_JS},gohtml:function(){this.mode=edb.Status.MODE_HTML},gotag:function(){this.mode=edb.Status.MODE_TAG}},edb.Result=function(body){this.body=body||""},edb.Result.prototype={body:null,temp:null,format:function(){return edb.Result.format(this.body)}},edb.Result.format=function(body){var result="",tabs="	",init=null,last=null,fixt=null,hack=null;return body.split("\n").forEach(function(line){line=line.trim(),init=line.charAt(0),last=line.charAt(line.length-1),fixt=line.split("//")[0].trim(),hack=fixt.charAt(fixt.length-1),"}"!==init&&"]"!==init||""===tabs||(tabs=tabs.slice(0,-1)),result+=tabs+line+"\n",("{"===last||"["===last||"{"===hack||"["===hack)&&(tabs+="	")}),result},edb.Template=gui.Class.create("edb.Template",Object.prototype,{readyState:null,onreadystatechange:null,context:null,spirit:null,toString:function(){return"[object edb.Template]"},onconstruct:function(spirit,window,handler){this.spirit=spirit||null,this.context=window||null,this.onreadystatechange=handler||null},compile:function(){},run:function(){},_gostate:function(state){state!==this.readyState&&(this.readyState=state,gui.Type.isFunction(this.onreadystatechange)&&this.onreadystatechange())}},{},{LOADING:"loading",WAITING:"waiting",WORKING:"working",READY:"ready",setImplementation:function(){var args=gui.Object.toArray(arguments),impl=args.shift();args.forEach(function(type){this._implementations.set(type,impl)},this)},getImplementation:function(type){var impl=this._implementations.get(type);if(!impl)throw Error("No implementation for: "+type);return impl},load:function(context,src,type,callback,thisp){new edb.TemplateLoader(context.document).load(src,function(source){var url=new gui.URL(context.document,src),script=edb.Script.get(url.href);script?callback.call(thisp,script):this.compile(context,source,type,null,function(script){edb.Script.set(url.href,script),callback.call(thisp,script)},this)},this)},compile:function(context,source,type,directives,callback,thisp){var Script=this.getImplementation(type),script=new Script(null,context,function(){callback.call(thisp,this)});script.compile(source,directives)},_implementations:new Map}),edb.TemplateLoader=gui.FileLoader.extend({directives:null,load:function(src,callback,thisp){var url=new gui.URL(this._document,src);this._cache.has(url.location)?this._cached(url,callback,thisp):url.external?this._request(url,callback,thisp):url.hash?this._lookup(url,callback,thisp):console.error("Now what?")},onload:function(text,url,callback,thisp){url.external&&(text=this._extract(text,url)),callback.call(thisp,text,this.directives),this.directives=null},_lookup:function(url,callback,thisp){var script=this._document.querySelector(url.hash);this.directives=gui.AttPlugin.getmap(script),this.onload(script.textContent,url,callback,thisp)},_extract:function(text,url){var doc=gui.HTMLParser.parseToDocument(text),script=doc.querySelector(url.hash||"script");return script?(this.directives=gui.AttPlugin.getmap(script),script.textContent):(console.error("No such script: "+url.location+url.hash||""),void 0)}},{},{_loaders:new Map,set:function(){var args=gui.Object.toArray(arguments),impl=args.shift();args.forEach(function(type){this._loaders.set(type,impl)},this)},get:function(type){var impl=edb.BaseLoader;if(type&&(impl=this._loaders.get(type),!impl))throw Error("No script loader registered for type: "+type);return impl}}),edb.Compiler=gui.Class.create("edb.Compiler",Object.prototype,{newline:function(line,runner,status){status.last=line.length-1,status.adds="+"===line[0],status.cont=status.cont||status.ishtml()&&status.adds},endline:function(line,runner,status,result){status.ishtml()?status.cont||(result.body+="';\n",status.gojs()):result.body+="\n",status.cont=!1},nextchar:function(c,runner,status,result){switch(status.mode){case edb.Status.MODE_JS:this._compilejs(c,runner,status,result);break;case edb.Status.MODE_HTML:this._compilehtml(c,runner,status,result);break;case edb.Status.MODE_TAG:this._compiletag(c,runner,status,result)}0>=status.skip--&&(status.poke?result.temp+=c:status.istag()||(result.body+=c))},_compile:function(script){var runner=new edb.Runner,status=new edb.Status,result=new edb.Result('"use strict";\n');return runner.run(this,script,status,result),result.body+=(status.ishtml()?"';":"")+"\nreturn out.write ();",result.format()},_compilejs:function(c,runner,status,result){switch(c){case"<":if(runner.firstchar){status.gohtml(),status.spot=result.body.length-1,result.body+="out.html += '"}break;case"@":this._scriptatt(runner,status,result)}},_compilehtml:function(c,runner,status,result){switch(c){case"{":status.peek||status.poke;break;case"}":status.peek&&(status.peek=!1,status.skip=1,result.body+=") + '"),status.poke&&(this._poke(status,result),status.poke=!1,result.temp=null,status.spot=-1,status.skip=1);break;case"$":status.peek||status.poke||!runner.ahead("{")||(status.peek=!0,status.skip=2,result.body+="' + (");break;case"#":status.peek||status.poke||!runner.ahead("{")||(status.poke=!0,status.skip=2,result.temp="");break;case"+":runner.firstchar?status.skip=status.adds?1:0:runner.lastchar&&(status.cont=!0,status.skip=1);break;case"'":status.peek||status.poke||(result.body+="\\");break;case"@":this._htmlatt(runner,status,result)}},_compiletag:function(status,c,i,line){switch(c){case"$":this._ahead(line,i,"{")&&(status.refs=!0,status.skip=2);break;case">":status.gojs(),status.skip=1}},_scriptatt:function(runner,status,result){var rest,name,attr=edb.Compiler._ATTREXP;if(runner.behind("@"));else if(runner.ahead("@"))result.body+="var att = new edb.Att ();",status.skip=2;else{if(rest=runner.lineahead(),name=attr.exec(rest)[0],!name)throw"Bad @name: "+rest;result.body+=rest.replace(name,"att['"+name+"']"),status.skip=rest.length}},_htmlatt:function(runner,status,result){var rest,name,dels,what,attr=edb.Compiler._ATTREXP;runner.behind("@")||(runner.behind("#{")?console.error("todo"):runner.ahead("@")?(result.body+="' + att._all () + '",status.skip=2):(rest=runner.lineahead(),name=attr.exec(rest)[0],dels=runner.behind("-"),what=dels?"att._pop":"att._out",result.body=dels?result.body.substring(0,result.body.length-1):result.body,result.body+="' + "+what+" ( '"+name+"' ) + '",status.skip=name.length+1))},_poke:function(status,result){var sig=this._$contextid?", &quot;"+this._$contextid+"&quot;":"",body=result.body,temp=result.temp,spot=status.spot,prev=body.substring(0,spot),next=body.substring(spot),name=gui.KeyMaster.generateKey("poke");result.body=prev+"\n"+"var "+name+" = edb.Script.assign ( function ( value, checked ) { \n"+temp+";\n}, this );"+next+"edb.Script.register ( event ).invoke ( &quot;' + "+name+" + '&quot;"+sig+" );"}},{},{_ATTREXP:/^[^\d][a-zA-Z0-9-_\.]+/}),edb.FunctionCompiler=edb.Compiler.extend("edb.FunctionCompiler",{source:null,params:null,dependencies:null,directives:null,sequence:null,onconstruct:function(source,directives){this.directives=directives||Object.create(null),this.source=source,this.sequence=["_validate","_extract","_direct","_declare","_define","_compile"]},compile:function(context){var result=null;this.dependencies=[],this.params=[],this._context=context,this._vars=[];var head={declarations:Object.create(null),functiondefs:[]};this.sequence.forEach(function(step){this.source=this[step](this.source,head)},this);try{result=this._convert(this.source,this.params),this.source=this._source(this.source,this.params)}catch(exception){result=this._fail(exception)}return result},sign:function($contextid){return this._$contextid=$contextid,this},_context:null,_$contextid:null,_instructions:null,_failed:!1,_validate:function(script){if(edb.FunctionCompiler._NESTEXP.test(script))throw"Nested EDBML dysfunction";return script},_direct:function(script){return script},_extract:function(script){return edb.Instruction.from(script).forEach(function(pi){this._instruct(pi)},this),edb.Instruction.clean(script)},_instruct:function(pi){var type=pi.type,atts=pi.atts,href=atts.src,name=atts.name,cont=this._context;switch(type){case"param":this.params.push(name);break;case"function":case"tag":if(type===edb.Dependency.TYPE_TAG){if(!href.contains("#"))throw Error("Missing tag #identifier: "+href);name=href.split("#")[1]}this.dependencies.push(new edb.Dependency(cont,type,name,href))}},_declare:function(script,head){var funcs=[];return this.dependencies.forEach(function(dep){head.declarations[dep.name]=!0,funcs.push(dep.name+" = functions ( self, '"+dep.href+"' );\n")},this),funcs[0]&&head.functiondefs.push("( function lookup ( functions ) {\n"+funcs.join("")+"}( edb.Function.get ));"),script},_define:function(script,head){var vars="";Object.keys(head.declarations).forEach(function(name){vars+=", "+name});var html="var Out = edb.Out, Att = edb.Att, Tag = edb.Tag, out = new Out (), att = new Att ()"+vars+";\n";return head.functiondefs.forEach(function(def){html+=def+"\n"}),html+script},_convert:function(script,params){var args="",context=this._context;return gui.Type.isArray(params)&&(args=params.join(",")),new context.Function(args,script)},_fail:function(exception){var context=this._context;if(this._failed)throw exception;return this._failed=!0,this._debug(edb.Result.format(this.source)),this.source='<p class="error">'+exception.message+"</p>",this.compile(context,!0)},_debug:function(source){var context=this._context;if(window.btoa){source=context.btoa("function debug () {\n"+source+"\n}");var script=context.document.createElement("script");script.src="data:text/javascript;base64,"+source,context.document.querySelector("head").appendChild(script),script.onload=function(){this.parentNode.removeChild(this)}}},_source:function(source,params){var lines=source.split("\n");lines.pop();var args=params.length?"( "+params.join(", ")+" )":"()";return"function "+args+" {\n"+lines.join("\n")+"\n}"}},{},{_NESTEXP:/<script.*type=["']?text\/edbml["']?.*>([\s\S]+?)/g}),edb.ScriptCompiler=edb.FunctionCompiler.extend({inputs:null,_instruct:function(pi){this._super._instruct(pi);var atts=pi.atts;switch(pi.type){case"input":this.inputs[atts.name]=atts.type}},compile:function(scope,fallback){return this.inputs=Object.create(null),this._super.compile(scope,fallback)},_declare:function(script,head){return this._super._declare(script,head),this._declareinputs(script,head)},_declareinputs:function(script,head){var defs=[];return gui.Object.each(this.inputs,function(name,type){head.declarations[name]=!0,defs.push(name+" = inputs ( "+type+" );\n")},this),defs[0]&&head.functiondefs.push("( function lookup ( inputs ) {\n"+defs.join("")+"})( this.script.inputs );"),script}}),edb.TagCompiler=edb.FunctionCompiler.extend("edb.TagCompiler",{_direct:function(script){if(this.directives.tag){var content=edb.TagCompiler._CONTENT;this.params.push("content"),this.params.push("attribs"),this.params.push("COMPILED_AS_TAG"),script="att = new Att ( attribs );\n"+script,script=script.replace(content,"content ( out );")}return this._super._direct(script)}},{},{_CONTENT:/<content(.*)>(.*)<\/content>|<content(.*)(\/?)>/}),edb.Dependency=function(context,type,name,href){this.href=gui.URL.absolute(context.document,href),this.type=type,this.name=name,this._context=context},edb.Dependency.prototype={type:null,name:null,href:null,resolve:function(){var res=this._source().get(this._context,this.href),then=this._then=new gui.Then;return res?then.now(res):gui.Broadcast.add(edb.BROADCAST_FUNCTION_LOADED,this,this._context.gui.$contextid),then},onbroadcast:function(b){switch(b.type){case edb.BROADCAST_FUNCTION_LOADED:b.data===this.href&&(this._then.now(this._source().get(this._context,this.href)),gui.Broadcast.remove(b.type,this,b.$contextid),this._context=null,this._then=null)}},_source:function(){switch(this.type){case edb.Dependency.TYPE_FUNCTION:return edb.Function;case edb.Dependency.TYPE_TAG:return edb.Tag}},_context:null,_then:null},edb.Dependency.TYPE_FUNCTION="function",edb.Dependency.TYPE_TAG="tag",edb.Function=edb.Template.extend("edb.Function",{context:null,pointer:null,params:null,functions:null,onconstruct:function(pointer,context,handler){this._super.onconstruct(pointer,context,handler),this.functions=Object.create(null),this.pointer=this.spirit,this.context=context,this.spirit=null},compile:function(source,directives){if(null!==this._function)throw Error("TODO: recompile the script :)");var compiler=this._compiler=new this._Compiler(source,directives);return this._$contextid&&compiler.sign(this._$contextid),this._function=compiler.compile(this.context),this._source=compiler.source,this.params=compiler.params,this._dependencies(compiler),this._oncompiled()},debug:function(){this._debugt&&console.error("WHY TWICE?"),this._debugt=!0,console.debug(this._source)},_dependencies:function(compiler){compiler.dependencies.filter(function(){return!0}).map(function(dep){return this.functions[dep.name]=null,dep},this).forEach(function(dep){dep.resolve().then(function(resolved){this.functions[dep.name]=resolved,this._maybeready()},this)},this)},sign:function($contextid){return this._$contextid=$contextid,this},run:function(){var result=null;if(!this._function)throw Error("Script not compiled");try{this._subscribe(!0),result=this._function.apply(this.pointer,arguments),this._subscribe(!1)}catch(exception){console.error(exception.message+":\n\n"+this._source)}return result},onbroadcast:function(b){switch(b.type){case edb.BROADCAST_FUNCTION_LOADED:this._functionloaded(b.data)}},_function:null,_$contextid:null,_Compiler:edb.FunctionCompiler,_compiler:null,_oncompiled:function(){try{this._useblob()?this._loadblob():this._maybeready()}catch(workerexception){this._maybeready()}return this},_useblob:function(){return edb.Function.useblob&&this.context.gui.debug&&gui.Client.hasBlob&&!gui.Client.isExplorer&&!gui.Client.isOpera},_loadblob:function(){var win=this.context,doc=win.document,key=gui.KeyMaster.generateKey("function"),src=this._compiler.source.replace("function","function "+key);this._gostate(edb.Template.LOADING),gui.BlobLoader.loadScript(doc,src,function(){this._gostate(edb.Template.WORKING),this._function=win[key],this._maybeready()},this)},_maybeready:function(){this.readyState!==edb.Template.LOADING&&(this._gostate(edb.Template.WORKING),this._done()?this._gostate(edb.Template.READY):this._gostate(edb.Template.WAITING))},_done:function(){return Object.keys(this.functions).every(function(name){return null!==this.functions[name]},this)},_subscribe:function(isBuilding){gui.Broadcast[isBuilding?"addGlobal":"removeGlobal"](edb.BROADCAST_GETTER,this),gui.Broadcast[isBuilding?"removeGlobal":"addGlobal"](edb.BROADCAST_SETTER,this)}},{get:function(win,src){return gui.Type.isWindow(win)&&console.debug("TODO: use $contextid"),src=new gui.URL(win.document,src).href,gui.Type.isFunction(this._map[src])?this._map[src]||null:this._load(src,win)},_broadcast:edb.BROADCAST_FUNCTION_LOADED,_map:Object.create(null),_load:function(src,win){var func=null,Implementation=this,cast=this._broadcast,sig=win.gui.$contextid;return new edb.TemplateLoader(win.document).load(src,function(source,directives){source&&new Implementation(null,win,function(){this.readyState===edb.Template.READY&&(func=Implementation._map[src]=this._function,directives.debug&&this.debug(),gui.Broadcast.dispatch(null,cast,src,sig))}).compile(source,directives)}),func}},{useblob:!0}),function(){edb.Function.get=edb.Function.get.bind(edb.Function)}(),edb.Script=edb.Function.extend("edb.Script",{input:null,onconstruct:function(pointer,context,handler){this._super.onconstruct(pointer,context,handler),this.input=new edb.InputPlugin,this.input.context=this.context,this.input.onconstruct(),console.warn("Bad: onconstruct should autoinvoke"),this._keys=new Set,gui.Broadcast.addGlobal(edb.BROADCAST_SETTER,this)},onbroadcast:function(b){switch(this._super.onbroadcast(b),b.type){case edb.BROADCAST_GETTER:this._keys.add(b.data);
break;case edb.BROADCAST_SETTER:if(this._keys.has(b.data)&&this.readyState!==edb.Template.WAITING){var tick=edb.TICK_SCRIPT_UPDATE,sig=this.context.gui.$contextid;gui.Tick.one(tick,this,sig).dispatch(tick,0,sig),this._gostate(edb.Template.WAITING)}}},ontick:function(tick){switch(tick.type){case edb.TICK_SCRIPT_UPDATE:this._gostate(edb.Template.READY)}},oninput:function(){this._maybeready()},run:function(){if(this._keys=new Set,this.input.done)return this._super.run.apply(this,arguments);throw Error("Script awaits input")},_Compiler:edb.ScriptCompiler,_keys:null,_resolved:!1,_oncompiled:function(){return gui.Object.each(this._compiler.inputs,function(name,type){this.input.add(type,this)},this),this._super._oncompiled()},_done:function(){return this.input.done&&this._super._done()}},{_invokables:new Map,_log:null,assign:function(func,thisp){var key=gui.KeyMaster.generateKey();return edb.Script._invokables.set(key,function(value,checked){func.apply(thisp,[gui.Type.cast(value),checked])}),key},invoke:function(key,sig,log){var func=null;if(log=log||this._log,sig)gui.Broadcast.dispatchGlobal(this,edb.BROADCAST_SCRIPT_INVOKE,{key:key,sig:sig,log:log});else{if(!(func=this._invokables.get(key)))throw Error("Invokable does not exist: "+key);"click"===log.type?setImmediate(function(){func(log.value,log.checked)}):func(log.value,log.checked)}},register:function(e){return this._log={type:e.type,value:e.target.value,checked:e.target.checked},this},get:function(key){return this._scripts[key]},set:function(key,script){this._scripts[key]=script},_scripts:Object.create(null)}),edb.Tag=edb.Function.extend("edb.Tag",{compile:function(source,directives){return directives.tag=!0,this._super.compile(source,directives)},_Compiler:edb.TagCompiler},{}),edb.Att=function(atts){atts&&gui.Object.extend(this,atts)},edb.Att.prototype=gui.Object.create(null,{toString:function(){return"[object edb.Att]"},_out:function(att){var val,html="";return gui.Type.isDefined(this[att])&&(val=edb.Att.encode(this[att]),html+=att+'="'+val+'" '),html},_pop:function(att){var html=this._out(att);return delete this[att],html},_all:function(){var html="";return gui.Object.nonmethods(this).forEach(function(att){html+=this._out(att)},this),html}}),edb.Att.encode=function(data){var type=gui.Type.of(data);switch(type){case"string":break;case"number":case"boolean":data+="";break;case"object":case"array":try{data=encodeURIComponent(JSON.stringify(data))}catch(jsonex){throw Error("Could not create HTML attribute: "+jsonex)}break;case"date":throw Error("TODO: edb.Att.encode standard date format?");default:throw Error("Could not create HTML attribute for "+type)}return data},edb.Out=function(){this.html=""},edb.Out.prototype={html:null,write:function(){return this.html}},edb.UpdateAssistant={id:function(element){return gui.Type.isDefined(element.id)?element.id||null:element.getAttribute("id")||null},parse:function(doc,markup,id,element){return element=doc.createElement(element.localName),element.innerHTML=markup,element.id=id,Array.forEach(element.querySelectorAll("option"),function(option){switch(option.getAttribute("selected")){case"true":option.setAttribute("selected","selected");break;case"false":option.removeAttribute("selected")}}),Array.forEach(element.querySelectorAll("input[type=checkbox],input[type=radio]"),function(option){switch(option.getAttribute("checked")){case"true":option.setAttribute("checked","checked");break;case"false":option.removeAttribute("checked")}}),element},order:function(nodes){var order=new Map;return Array.forEach(nodes,function(node,index){node.nodeType===Node.ELEMENT_NODE&&order.set(this.id(node),index)},this),order},index:function(nodes){var result=Object.create(null);return Array.forEach(nodes,function(node){node.nodeType===Node.ELEMENT_NODE&&(result[this.id(node)]=node)},this),result}},edb.UpdateManager=function(spirit){this._keyid=spirit.dom.id()||spirit.$instanceid,this._spirit=spirit,this._doc=spirit.document},edb.UpdateManager.prototype={update:function(html){this._updates=new edb.UpdateCollector,null===this._olddom?this._first(html):this._next(html),this._updates.eachRelevant(function(update){update.update(),update.dispose()}),this._updates.dispose(),delete this._updates},_keyid:null,_doc:null,_spirit:null,_olddom:null,_nedwdom:null,_updates:null,_assistant:edb.UpdateAssistant,_first:function(html){this._olddom=this._parse(html),this._updates.collect(new edb.HardUpdate(this._doc).setup(this._keyid,this._olddom))},_next:function(html){this._newdom=this._parse(html),this._crawl(this._newdom,this._olddom,this._newdom,this._keyid,{},null),this._olddom=this._newdom},_parse:function(html){return this._assistant.parse(this._doc,html,this._keyid,this._spirit.element)},_crawl:function(newchild,oldchild,lastnode,id,ids,css){for(var result=!0,n=1;newchild&&oldchild&&!this._updates.hardupdates(id);){switch(newchild.nodeType){case Node.TEXT_NODE:result=this._check(newchild,oldchild,lastnode,id,ids,css,n);break;case Node.ELEMENT_NODE:result=this._scan(newchild,oldchild,lastnode,id,ids,css,n),n++}newchild=newchild.nextSibling,oldchild=oldchild.nextSibling}return result},_scan:function(newnode,oldnode,lastnode,id,ids,css,n){var result=!0,oldid=this._assistant.id(oldnode);return css=css?oldid?"#"+oldid:css+">"+oldnode.localName+":nth-child("+n+")":"this",(result=this._check(newnode,oldnode,lastnode,id,ids,css,n))&&(oldid&&(ids=gui.Object.copy(ids),lastnode=newnode,ids[oldid]=!0,id=oldid),result=this._crawl(newnode.firstChild,oldnode.firstChild,lastnode,id,ids,css)),result},_check:function(newnode,oldnode,lastnode,id,ids,css,n){var result=!0,isSoftUpdate=!1,isPluginUpdate=!1;if(newnode&&!oldnode||!newnode&&oldnode)result=!1;else if(result=newnode.nodeType===oldnode.nodeType)switch(oldnode.nodeType){case Node.TEXT_NODE:newnode.data!==oldnode.data&&(result=!1);break;case Node.ELEMENT_NODE:(result=this._familiar(newnode,oldnode))&&(result=this._checkatts(newnode,oldnode,ids,css))&&(this._maybesoft(newnode,oldnode)?(this._confirmsoft(newnode,oldnode)&&(this._updatesoft(newnode,oldnode,ids,css,n),isSoftUpdate=!0),result=!1):"textarea"!==oldnode.localName&&(result=newnode.childNodes.length===oldnode.childNodes.length))}return result||isSoftUpdate||isPluginUpdate||this._updates.collect(new edb.HardUpdate(this._doc).setup(id,lastnode)),result},_familiar:function(newnode,oldnode){return["namespaceURI","localName"].every(function(prop){return newnode[prop]===oldnode[prop]})},_checkatts:function(newnode,oldnode,ids,css){var result=!0,update=null;if(this._attschanged(newnode.attributes,oldnode.attributes,ids,css)){var newid=this._assistant.id(newnode),oldid=this._assistant.id(oldnode);newid&&newid===oldid?(update=new edb.AttsUpdate(this._doc).setup(oldid,newnode,oldnode),this._updates.collect(update,ids)):result=!1}return result},_attschanged:function(newatts,oldatts){return newatts.length!==oldatts.length||!Array.every(newatts,function(newatt){var oldatt=oldatts.getNamedItem(newatt.name);return oldatt&&oldatt.value===newatt.value})},_maybesoft:function(newnode,oldnode){return newnode&&oldnode?this._maybesoft(newnode)&&this._maybesoft(oldnode):Array.every(newnode.childNodes,function(node){var res=!0;switch(node.nodeType){case Node.TEXT_NODE:res=""===node.data.trim();break;case Node.ELEMENT_NODE:res=null!==this._assistant.id(node)}return res},this)},_confirmsoft:function(newnode,oldnode){var res=!0,prev=null,oldorder=this._assistant.order(oldnode.childNodes);return Array.every(newnode.childNodes,function(node){if(node.nodeType===Node.ELEMENT_NODE){var id=this._assistant.id(node);oldorder.has(id)&&oldorder.has(prev)&&(res=oldorder.get(id)>oldorder.get(prev)),prev=id}return res},this)},_updatesoft:function(newnode,oldnode,ids,css,n){for(var updates=[],news=this._assistant.index(newnode.childNodes),olds=this._assistant.index(oldnode.childNodes),child=newnode.lastElementChild,topid=this._assistant.id(oldnode),oldid=null,newid=null;child;)newid=this._assistant.id(child),olds[newid]?oldid=newid:oldid?updates.push(new edb.InsertUpdate(this._doc).setup(oldid,child)):updates.push(new edb.AppendUpdate(this._doc).setup(topid,child)),child=child.previousElementSibling;Object.keys(olds).forEach(function(id){if(news[id]){var n1=news[id],n2=olds[id];this._scan(n1,n2,n1,id,ids,css,n)}else updates.push(new edb.RemoveUpdate(this._doc).setup(id))},this),updates.reverse().forEach(function(update){this._updates.collect(update,ids)},this)}},edb.UpdateCollector=function(){this._updates=[],this._hardupdates=new Set},edb.UpdateCollector.prototype={_updates:null,_hardupdates:null,toString:function(){return"[object edb.UpdateCollector]"},collect:function(update,ids){this._updates.push(update),update.type===edb.Update.TYPE_HARD?this._hardupdates.add(update.id):update.ids=ids},hardupdates:function(id){return this._hardupdates.has(id)},eachRelevant:function(action){this._updates.filter(function(update){return update.type===edb.Update.TYPE_HARD||Object.keys(update.ids).every(function(id){return!this.hardupdates(id)},this)},this).forEach(function(update){action(update)})},dispose:function(){delete this._hardupdates,delete this._updates}},edb.Update=gui.Class.create("edb.Update",Object.prototype,{type:null,id:null,window:null,document:null,onconstruct:function(doc){this.window=doc.defaultView,this.document=doc},setup:function(){return this},update:function(){},element:function(){var element=null;if(element=gui.KeyMaster.isKey(this.id)?this.window.gui.get(this.id).element:this.document.getElementById(this.id),!element)throw Error("No element to match: "+this.id);return element},dispose:function(){delete this.window,delete this.document},_beforeUpdate:function(element){var event="x-beforeupdate-"+this.type;return this._dispatch(element,event)},_afterUpdate:function(element){var event="x-aftrerupdate-"+this.type;return this._dispatch(element,event)},_dispatch:function(element,name){var event=this.document.createEvent("UIEvents");return event.initEvent(name,!0,!0),element.dispatchEvent(event)},_report:function(report){this.window.gui.debug&&(gui.KeyMaster.isKey(this.id)&&(report=report.replace(this.id,"(anonymous)")),console.debug(report))}},{},{TYPE_HARD:"hard",TYPE_ATTS:"atts",TYPE_INSERT:"insert",TYPE_APPEND:"append",TYPE_REMOVE:"remove"}),edb.AttsUpdate=edb.Update.extend("edb.AttsUpdate",{type:edb.Update.TYPE_ATTS,_xold:null,_xnew:null,_summary:null,onconstruct:function(doc){this._super.onconstruct(doc),this._summary=[]},setup:function(id,xnew,xold){return this._super.setup(),this.id=id,this._xnew=xnew,this._xold=xold,this},update:function(){this._super.update();var element=this.element();this._beforeUpdate(element)&&(this._update(element),this._afterUpdate(element),this._report())},dispose:function(){this._super.dispose(),delete this._xold,delete this._xnew},_update:function(element){Array.forEach(this._xnew.attributes,function(newatt){var oldatt=this._xold.getAttribute(newatt.name);(null===oldatt||oldatt!==newatt.value)&&(this._set(element,newatt.name,newatt.value),this._summary.push("@"+newatt.name))},this),Array.forEach(this._xold.attributes,function(oldatt){this._xnew.hasAttribute(oldatt.name)||(this._del(element,oldatt.name,null),this._summary.push("@"+oldatt.value))},this)},_set:function(element,name,value){var spirit=element.spirit;if(spirit)spirit.att.set(name,value);else switch(element.setAttribute(name,value),name){case"checked":element.checked||(element.checked=!0);break;case"value":element.value!==value&&(element.value=value+"")}},_del:function(element,name){var spirit=element.spirit;if(spirit)spirit.att.del(name);else switch(name){case"checked":element.checked=!1;break;default:element.removeAttribute(name)}},_report:function(){this._super._report('edb.AttsUpdate "#'+this.id+'" '+this._summary.join(", "))}}),edb.HardUpdate=edb.Update.extend("edb.HardUpdate",{type:edb.Update.TYPE_HARD,xelement:null,setup:function(id,xelement){return this._super.setup(),this.id=id,this.xelement=xelement,this},update:function(){this._super.update();var element=this.element();this._beforeUpdate(element)&&(gui.DOMPlugin.html(element,this._serialize()),this._afterUpdate(element),this._report())},dispose:function(){this._super.dispose(),delete this.xelement},_serialize:function(){var xhtml=(new XMLSerializer).serializeToString(this.xelement);return xhtml.contains("</")&&(xhtml=xhtml.slice(xhtml.indexOf(">")+1,xhtml.lastIndexOf("<"))),xhtml},_report:function(){this._super._report("edb.HardUpdate #"+this.id)}}),edb.SoftUpdate=edb.Update.extend("edb.SoftUpdate",{xelement:null,type:null,dispose:function(){this._super.dispose(),delete this.xelement},_import:function(parent){var temp=this.document.createElement(parent.nodeName);return temp.innerHTML=(new XMLSerializer).serializeToString(this.xelement),temp.firstChild}}),edb.InsertUpdate=edb.SoftUpdate.extend("edb.InsertUpdate",{type:edb.Update.TYPE_INSERT,xelement:null,setup:function(id,xelement){return this.id=id,this.xelement=xelement,this},update:function(){var sibling=this.element(),parent=sibling.parentNode,child=this._import(parent);this._beforeUpdate(parent)&&(parent.insertBefore(child,sibling),this._afterUpdate(child),this._report())},_report:function(){this._super._report("edb.InsertUpdate #"+this.xelement.getAttribute("id"))}}),edb.AppendUpdate=edb.SoftUpdate.extend("edb.AppendUpdate",{type:edb.Update.TYPE_APPEND,setup:function(id,xelement){return this.id=id,this.xelement=xelement,this},update:function(){var parent=this.element(),child=this._import(parent);this._beforeUpdate(parent)&&(parent.appendChild(child),this._afterUpdate(child),this._report())},_report:function(){this._super._report("edb.AppendUpdate #"+this.xelement.getAttribute("id"))}}),edb.RemoveUpdate=edb.SoftUpdate.extend("edb.RemoveUpdate",{type:edb.Update.TYPE_REMOVE,setup:function(id){return this.id=id,this},update:function(){var element=this.element(),parent=element.parentNode;this._beforeUpdate(element)&&(parent.removeChild(element),this._afterUpdate(parent),this._report())},_report:function(){this._super._report("edb.RemoveUpdate #"+this.id)}}),edb.ScriptUpdate=edb.Update.extend("edb.ScriptUpdate",{type:"edbscript",onconstruct:function(doc){this._super.onconstruct(doc),this._summary=[]},setup:function(spirit,selector,name,value,key){return this._super.setup(),this._spirit=spirit,this._selector=selector,this._name=name,this._value=value,this._key=key,this},update:function(){this._super.update();var element=null;try{element=this._spirit.dom.q(this._selector)}catch(domexception){throw Error("Bad selector: "+this._selector)}finally{if(!element)throw Error("No such element: "+this._selector);this._beforeUpdate(element)&&(this._update(element),this._afterUpdate(element),this._report())}},_spirit:null,_selector:null,_name:null,_value:null,_key:null,_update:function(element){var current=element.getAttribute(this._name);current&&current.contains(this._key)?element.setAttribute(this._name,this._value):console.warn("Softupdate dysfunction? "+this._key+" not found in "+current)},_report:function(){this._super._report("edb.ScriptUpdate "+this._selector)}}),function(){var method=edb.UpdateManager.prototype._attschanged;edb.UpdateManager.prototype._attschanged=function(newatts,oldatts,ids,css){return method.apply(this,arguments)?!Array.every(newatts,function(newatt){var oldatt=oldatts.getNamedItem(newatt.name),newhit=gui.KeyMaster.extractKey(newatt.value);if("oninput"===newatt.name&&console.error(oldatt.value+"\n "+newatt.value+"\n"+(null!==oldatt&&oldatt.value===newatt.value)),newhit){var oldhit=gui.KeyMaster.extractKey(oldatt.value),update=new edb.ScriptUpdate(this._doc).setup(this._spirit,css,oldatt.name,newatt.value,oldhit[0]);return this._updates.collect(update,ids),!0}return!1},this):!1}}(),gui.module("edb",{mixins:{oninput:function(){}},plugins:{script:edb.ScriptPlugin,input:edb.InputPlugin,output:edb.OutputPlugin},channels:[["script[type='text/edbml']","edb.ScriptSpirit"],["link[rel='service']","edb.ServiceSpirit"]],oncontextinitialize:function(context){context===gui.context&&edb.Template&&edb.TemplateLoader&&edb.Template.setImplementation(edb.Script,"application/x-edbml","application/edbml","text/edbml","edbml")}});