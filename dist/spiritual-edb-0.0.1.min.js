/*
 * Spiritual EDB 0.0.1
 * (c) 2013 Wunderbyte
 * Spiritual is freely distributable under the MIT license.
 */
var edb={BROADCAST_FUNCTION_LOADED:"broadcast-edb-function-loaded"};gui.namespace("edb"),edb.Model=function(){},edb.Model.prototype={$primaryKey:"id",_instanceKey:null,onconstruct:function(){},$init:function(){},$sub:function(){gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_DATA_SUB,this._instanceKey)},$pub:function(){gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_DATA_PUB,this._instanceKey)},$serialize:function(e){var t=JSON.parse(JSON.stringify(this));return Object.keys(t).forEach(function(e){switch(e.charAt(0)){case"$":case"_":delete t[e]}}),JSON.stringify(t,null,e?"	":"")},toString:function(){return"edb.Model#toString :)"}},edb.ObjectModel=gui.Exemplar.create(edb.Model.prototype,{__construct__:function(e){this._instanceKey=gui.KeyMaster.generateKey();var t=gui.Type.of(e);switch(t){case"object":case"undefined":edb.ObjectModel.approximate(this,e),this.onconstruct();break;default:throw new TypeError("Unexpected argument of type "+t.toUpperCase()+":\n"+e)}}},{__name__:"DataObject",__data__:!0},{approximate:function(e,t){var n=null;t=t||{};var r={};this._definitions(e).forEach(function(i){n=e[i];switch(gui.Type.of(n)){case"function":if(gui.Type.isConstructor(n)){var s=n;r[i]=new s(t[i])}break;case"object":console.warn("TODO: approximate object: "+i),console.warn(JSON.stringify(n));break;case"array":console.warn("TODO: approximate array: "+i),console.warn(JSON.stringify(n));break;default:gui.Type.isDefined(t[i])||(t[i]=e[i])}}),gui.Object.nonmethods(t).forEach(function(n){Object.defineProperty(e,n,{enumerable:!0,configurable:!0,get:function(){return this.$sub(),r[n]||t[n]},set:function(e){var i=r[n]?r:t;i[n]=e,this.$pub()}})})},_definitions:function(e){function n(e){gui.Type.isDefined(Object.prototype[e])||gui.Type.isDefined(edb.Model.prototype[e])||e.startsWith("_")||t.push(e)}var t=[];for(var r in e)n(r);return t}}),edb.ArrayModel=gui.Exemplar.create(Array.prototype,{$content:null,__construct__:function(){this._instanceKey=gui.KeyMaster.generateKey();var e=this.constructor;e.__content__&&(this.$content=e.__content__,e.__content__=null);if(gui.Type.isDefined(arguments[0])){var t=[];gui.Type.isArray(arguments[0])?t=arguments[0]:Array.forEach(arguments,function(e){t.push(e)});var n=this.$content;gui.Type.isFunction(n)&&t.forEach(function(e,t){if(e!==undefined){if(!e._instanceKey){var r=n;gui.Type.isConstructor(r)||(r=n(e)),e=new r(e)}Array.prototype.push.call(this,e)}},this)}edb.ArrayModel.approximate(this,{}),this.onconstruct()}},{__name__:"DataList",__data__:!0,__content__:null},{approximate:function(e,t){var n=null;t=t||{},this._definitions(e).forEach(function(r){n=e[r];switch(gui.Type.of(n)){case"function":break;case"object":case"array":console.warn("TODO: complex stuff on edb.ArrayModel :)");break;default:gui.Type.isDefined(t[r])||(t[r]=e[r])}}),gui.Object.nonmethods(t).forEach(function(n){Object.defineProperty(e,n,{enumerable:!0,configurable:!0,get:function(){return this.$sub(),t[n]},set:function(e){t[n]=e,this.$pub()}})})},_definitions:function(e){function n(e){gui.Type.isNumber(gui.Type.cast(e))||gui.Type.isDefined(Array.prototype[e])||gui.Type.isDefined(edb.Model.prototype[e])||e.startsWith("_")||t.push(e)}var t=[];for(var r in e)n(r);return t}}),function(){"use strict";Object.keys(edb.Model.prototype).forEach(function(e){this[e]=edb.Model.prototype[e]},this),["filter","forEach","every","map","some","indexOf","lastIndexOf"].forEach(function(e){this[e]=function(){var t=Array.prototype[e].apply(this,arguments);return this.$sub(),t}},this),["push","pop","shift","unshift","splice","reverse"].forEach(function(e){this[e]=function(){var t=Array.prototype[e].apply(this,arguments);return this.$pub(),t}},this),this.concat=function(e){var t=new this.constructor;return this.forEach(function(e){t.push(e)}),e.forEach(function(e){t.push(e)}),t}}.call(edb.ArrayModel.prototype),edb.SpiritView=gui.Plugin.extend("edb.SpiritView",{script:null,rendered:!1,updating:!0,onconstruct:function(){this._super.onconstruct(),this.updating&&(this._updater=new edb.UpdateManager(this.spirit))},compile:function(e,t,n,r){var i=edb.GenericScript.get(t);if(!!this.script)throw new Error("not supported: recompile edb.SpiritView");var s=this;this.script=new i(this.spirit,this.spirit.window,function(){this.readyState===edb.GenericScript.READY&&s.render()}),this.script.compile(e,n,r)},render:function(){this.script?this.write(this.script.run.apply(this.script,arguments)):console.warn("Running uncompiled script")},write:function(e){this.updating?this._updater.update(e):this.spirit.dom.html(e),this.rendered=!0,this.spirit.life.dispatch("spirit-view-rendered"),console.warn("TODO: life event fired apart from first time???"),this.spirit.action.dispatchGlobal(gui.ACTION_DOCUMENT_FIT)},_updater:null}),edb.Input=function(t,n){this.type=t||null,this.data=n||null},edb.Input.prototype={type:null,data:null,toString:function(){return"[object edb.Input]"}},edb.Input.add=function(e){gui.Broadcast.addGlobal(gui.BROADCAST_OUTPUT,e)},edb.Input.remove=function(e){gui.Broadcast.removeGlobal(gui.BROADCAST_OUTPUT,e)},edb.Output=gui.Plugin.extend("edb.Output",{dispatch:function(e,t){var n=this._format(e,t);if(!(n instanceof edb.Input))throw new TypeError("Not an instance of edb.Input: "+n);if(!n.type)throw new Error("edb.Input type is "+n.type);n.type.output=n,gui.Broadcast.dispatchGlobal(this.sandboxed?null:this.spirit,gui.BROADCAST_OUTPUT,n)},type:function(){throw new Error("deprecated")},_format:function(e,t){var n=e;if(e instanceof edb.Input==0){if(t)t=this._lookup(t),e instanceof t==0&&(n=new t(e));else if(!e._instanceKey){switch(gui.Type.of(e)){case"object":t=Object.model();break;case"array":t=Array.model()}n=this._format(e,t)}else t=e.constructor;n=new edb.Input(t,e)}return n},_lookup:function(e){var t=null;switch(gui.Type.of(e)){case"function":t=e;break;case"string":t=gui.Object.lookup(e,this.context);break;case"object":console.error(this+": expected edb.Model constructor (not an object)")}if(!t)throw new TypeError('The type "'+e+'" does not exist');return t}}),edb.InputTracker=gui.Tracker.extend("edb.InputTracker",{done:!0,latest:null,_weakmap:null,_types:null,add:function(e,t){this.done=!1,this.latest=this.latest||[],this._types=this._types||[],this._weakmap=this._weakmap||new WeakMap,t=t?t:this.spirit;var n=[],r=this._breakdown(e);return r.forEach(function(e,n){this._weakmap.get(e)||this._weakmap.set(e,[]),this._weakmap.get(e).push(t);if(this._types.indexOf(e)===-1){this._types.push(e),this._types.length===1&&edb.Input.add(this);if(e.output instanceof edb.Input)if(!this.spirit||this.spirit.life.ready){var r=gui.TICK_COLLECT_INPUT,i=this.context.gui.signature;gui.Tick.one(r,this,i).dispatch(r,0,i)}else this.spirit.life.add(gui.LIFE_READY,this)}},this),this.spirit},remove:function(e,t){return t=t?t:this,this._breakdown(e).forEach(function(e){var n=this._types.indexOf(e);if(n>-1){this._types.remove(n);if(t!==this)throw"not implemented"}},this),this.spirit},get:function(e){var t;return this.latest&&this.latest.every(function(n){return n.type===e&&(t=n.data),t===undefined}),t},onbroadcast:function(e){e.type===gui.BROADCAST_OUTPUT&&this._maybeinput(e.data)},onlife:function(e){e.type===gui.LIFE_READY&&this._todoname()},ontick:function(e){e.type===gui.TICK_COLLECT_INPUT&&this._todoname()},destruct:function(){this._super.destruct(),gui.Tick.remove(gui.TICK_COLLECT_INPUT,this,this.context.gui.signature),this._types&&(this._types.forEach(function(e){this._weakmap.del(e)},this),delete this._types),delete this._weakmap},_todoname:function(){this._types.forEach(function(e){e.output instanceof edb.Input&&this._maybeinput(e.output)},this)},_maybeinput:function(e){var t=e.type;this._types.indexOf(t)>-1&&(this.latest.every(function(e,n){var r=e.type===t;return r&&this.latest.remove(n),!r},this),this.done=this.latest.push(e)===this._types.length,this._weakmap.get(t).forEach(function(t){t.oninput(e)}))},_breakdown:function(e){var t=null;return gui.Type.isArray(e)?t=this._breakarray(e):t=this._breakother(e),t},_breakarray:function(e){return e.map(function(e){var t=null;switch(gui.Type.of(e)){case"function":t=e;break;case"string":t=gui.Object.lookup(e,this.context);break;case"object":console.error(this+": expected function (not object)")}return t},this)},_breakother:function(e){var t=null;switch(gui.Type.of(e)){case"function":t=[e];break;case"string":t=this._breakarray(e.split(" "));break;case"object":console.error(this+": expected function (not object)")}return t}}),edb.ScriptSpirit=gui.Spirit.infuse("edb.ScriptSpirit",{debug:!1,src:null,type:"text/edbml",config:{map:{debug:"debug"}},onenter:function(){this._super.onenter(),this.type=this.att.get("type")||this.type;if(!this._plainscript()){var e=this.att.get("src")||this.src;e?this._load(e):gui.Tick.next(function(){this._init(this.dom.text())},this)}},_init:function(e){var t=null,n=this.dom.parent();n.localName==="head"?t=this.view:n.spirit?t=n.spirit.view:gui.debug&&console.warn("templates in document.body should be direct child of a spirit");if(t){var r=this.att.getup();t.compile(e,this.type,this.debug,r)}},_load:function(e){var t=edb.GenericLoader.get(this.type);(new t(this.document)).load(e,function(e){this._init(e)},this)},_plainscript:function(){var e=!1;switch(this.att.get("type")){case null:case"text/ecmacript":case"text/javascript":case"application/javascript":case"application/x-javascript":e=!0}return e}}),edb.ServiceSpirit=gui.Spirit.infuse("edb.ServiceSpirit",{onconstruct:function(){this._super.onconstruct();var e=this.att.get("type");if(!e)throw new Error("TODO: formalize missing type somehow");var t=gui.Object.lookup(e,this.window);this.att.get("href")?(new gui.Request(this.element.href)).acceptJSON().get(function(e,n){this.output.dispatch(new t(n))},this):this.output.dispatch(new t)},_pipeline:function(){console.error("TODO: might this be outdated???");var e=new this.output._type(this._arg(0),this._arg(1),this._arg(2),this._arg(3),this._arg(4),this._arg(5),this._arg(6),this._arg(7),this._arg(8),this._arg(9));this.output.dispatch(e)},_arg:function(e){var t=this.input._types[e];return this.input.get(t)}}),edb.UpdateAssistant={id:function(e){return gui.Type.isDefined(e.id)?e.id||null:e.getAttribute("id")||null},parse:function(e,t,n,r){return r=e.createElement(r.localName),r.innerHTML=t,r.id=n,Array.forEach(r.querySelectorAll("option"),function(e){switch(e.getAttribute("selected")){case"true":e.setAttribute("selected","selected");break;case"false":e.removeAttribute("selected")}}),Array.forEach(r.querySelectorAll("input[type=checkbox],input[type=radio]"),function(e){switch(e.getAttribute("checked")){case"true":e.setAttribute("checked","checked");break;case"false":e.removeAttribute("checked")}}),r},order:function(e){var t=new Map;return Array.forEach(e,function(e,n){e.nodeType===Node.ELEMENT_NODE&&t.set(this.id(e),n)},this),t},index:function(e){var t=Object.create(null);return Array.forEach(e,function(e,n){e.nodeType===Node.ELEMENT_NODE&&(t[this.id(e)]=e)},this),t}},edb.UpdateManager=function(t){this._keyid=t.dom.id()||t.spiritkey,this._spirit=t,this._doc=t.document},edb.UpdateManager.prototype={update:function(e){this._updates=new edb.UpdateCollector,this._olddom===null?this._first(e):this._next(e),this._updates.eachRelevant(function(e){e.update(),e.dispose()}),this._updates.dispose(),delete this._updates},_keyid:null,_doc:null,_spirit:null,_olddom:null,_nedwdom:null,_updates:null,_assistant:edb.UpdateAssistant,_first:function(e){this._olddom=this._parse(e),this._updates.collect((new edb.HardUpdate(this._doc)).setup(this._keyid,this._olddom))},_next:function(e){this._newdom=this._parse(e),this._crawl(this._newdom,this._olddom,this._newdom,this._keyid,{},null),this._olddom=this._newdom},_parse:function(e){return this._assistant.parse(this._doc,e,this._keyid,this._spirit.element)},_crawl:function(e,t,n,r,i,s){var o=!0,u=1;while(e&&t&&!this._updates.hardupdates(r)){switch(e.nodeType){case Node.TEXT_NODE:o=this._check(e,t,n,r,i,s,u);break;case Node.ELEMENT_NODE:o=this._scan(e,t,n,r,i,s,u),u++}e=e.nextSibling,t=t.nextSibling}return o},_scan:function(e,t,n,r,i,s,o){var u=!0,a=this._assistant.id(t);s=s?a?"#"+a:s+">"+t.localName+":nth-child("+o+")":"this";if(u=this._check(e,t,n,r,i,s,o))a&&(i=gui.Object.copy(i),n=e,i[a]=!0,r=a),u=this._crawl(e.firstChild,t.firstChild,n,r,i,s);return u},_check:function(e,t,n,r,i,s,o){var u=!0,a=!1,f=!1;if(e&&!t||!e&&t)u=!1;else if(u=e.nodeType===t.nodeType)switch(t.nodeType){case Node.TEXT_NODE:e.data!==t.data&&(u=!1);break;case Node.ELEMENT_NODE:if(u=this._familiar(e,t))if(u=this._checkatts(e,t,i,s))this._maybesoft(e,t)?(this._confirmsoft(e,t)&&(this._updatesoft(e,t,i,s,o),a=!0),u=!1):t.localName!=="textarea"&&(u=e.childNodes.length===t.childNodes.length)}return!u&&!a&&!f&&this._updates.collect((new edb.HardUpdate(this._doc)).setup(r,n)),u},_familiar:function(e,t){return["namespaceURI","localName"].every(function(n){return e[n]===t[n]})},_checkatts:function(e,t,n,r){var i=!0,s=null;if(this._attschanged(e.attributes,t.attributes,n,r)){var o=this._assistant.id(e),u=this._assistant.id(t);o&&o===u?(s=(new edb.AttsUpdate(this._doc)).setup(u,e,t),this._updates.collect(s,n)):i=!1}return i},_attschanged:function(e,t,n,r){return e.length!==t.length||!Array.every(e,function(e){var n=t.getNamedItem(e.name);return n&&n.value===e.value})},_maybesoft:function(e,t){return e&&t?this._maybesoft(e)&&this._maybesoft(t):Array.every(e.childNodes,function(e){var t=!0;switch(e.nodeType){case Node.TEXT_NODE:t=e.data.trim()==="";break;case Node.ELEMENT_NODE:t=this._assistant.id(e)!==null}return t},this)},_confirmsoft:function(e,t){var n=!0,r=null,i=this._assistant.order(t.childNodes);return Array.every(e.childNodes,function(e,t){if(e.nodeType===Node.ELEMENT_NODE){var s=this._assistant.id(e);i.has(s)&&i.has(r)&&(n=i.get(s)>i.get(r)),r=s}return n},this)},_updatesoft:function(e,t,n,r,i){var s=[],o=this._assistant.index(e.childNodes),u=this._assistant.index(t.childNodes),a=e.lastElementChild,f=this._assistant.id(t),l=null,c=null;while(a)c=this._assistant.id(a),u[c]?l=c:l?s.push((new edb.InsertUpdate(this._doc)).setup(l,a)):s.push((new edb.AppendUpdate(this._doc)).setup(f,a)),a=a.previousElementSibling;Object.keys(u).forEach(function(e){if(!o[e])s.push((new edb.RemoveUpdate(this._doc)).setup(e));else{var t=o[e],a=u[e];this._scan(t,a,t,e,n,r,i)}},this),s.reverse().forEach(function(e){this._updates.collect(e,n)},this)}},edb.UpdateCollector=function(){this._updates=[],this._hardupdates=new Set},edb.UpdateCollector.prototype={_updates:null,_hardupdates:null,toString:function(){return"[object edb.UpdateCollector]"},collect:function(e,t){this._updates.push(e),e.type===edb.Update.TYPE_HARD?this._hardupdates.add(e.id):e.ids=t},hardupdates:function(e){return this._hardupdates.has(e)},eachRelevant:function(e){this._updates.filter(function(e){return e.type===edb.Update.TYPE_HARD||Object.keys(e.ids).every(function(e){return!this.hardupdates(e)},this)},this).forEach(function(t){e(t)})},dispose:function(){delete this._hardupdates,delete this._updates}},edb.Update=gui.Exemplar.create("edb.Update",Object.prototype,{type:null,id:null,window:null,document:null,__construct__:function(e){this.onconstruct(e)},onconstruct:function(e){this.document=e,this.window=e.defaultView},setup:function(){return this},update:function(){},element:function(){var e=null;gui.KeyMaster.isKey(this.id)?e=this.window.gui.get(this.id).element:e=this.document.getElementById(this.id);if(!e)throw new Error("No element to match: "+this.id);return e},dispose:function(){delete this.window,delete this.document},_beforeUpdate:function(e){var t="x-beforeupdate-"+this.type;return this._dispatch(e,t)},_afterUpdate:function(e){var t="x-aftrerupdate-"+this.type;return this._dispatch(e,t)},_dispatch:function(e,t){var n=this.document.createEvent("UIEvents");return n.initEvent(t,!0,!0),e.dispatchEvent(n)},_report:function(e){this.window.gui.debug&&(gui.KeyMaster.isKey(this.id)&&(e=e.replace(this.id,"(anonymous)")),console.debug(e))}},{},{TYPE_HARD:"hard",TYPE_ATTS:"atts",TYPE_INSERT:"insert",TYPE_APPEND:"append",TYPE_REMOVE:"remove"}),edb.AttsUpdate=edb.Update.extend("edb.AttsUpdate",{type:edb.Update.TYPE_ATTS,_xold:null,_xnew:null,_summary:null,onconstruct:function(e){this._super.onconstruct(e),this._summary=[]},setup:function(e,t,n){return this._super.setup(),this.id=e,this._xnew=t,this._xold=n,this},update:function(){this._super.update();var e=this.element();this._beforeUpdate(e)&&(this._update(e),this._afterUpdate(e),this._report())},dispose:function(){this._super.dispose(),delete this._xold,delete this._xnew},_update:function(e){Array.forEach(this._xnew.attributes,function(t){var n=this._xold.getAttribute(t.name);if(n===null||n!==t.value)this._set(e,t.name,t.value),this._summary.push("@"+t.name)},this),Array.forEach(this._xold.attributes,function(t){this._xnew.hasAttribute(t.name)||(this._del(e,t.name,null),this._summary.push("@"+t.value))},this)},_set:function(e,t,n){var r=e.spirit;if(r)r.att.set(t,n);else{e.setAttribute(t,n);switch(t){case"checked":e.checked||(e.checked=!0);break;case"value":e.value!==n&&(e.value=String(n))}}},_del:function(e,t){var n=e.spirit;if(n)n.att.del(t);else switch(t){case"checked":e.checked=!1;break;default:e.removeAttribute(t)}},_report:function(){this._super._report('edb.AttsUpdate "#'+this.id+'" '+this._summary.join(", "))}}),edb.HardUpdate=edb.Update.extend("edb.HardUpdate",{type:edb.Update.TYPE_HARD,xelement:null,setup:function(e,t){return this._super.setup(),this.id=e,this.xelement=t,this},update:function(){this._super.update();var e=this.element();this._beforeUpdate(e)&&(gui.DOMPlugin.html(e,this._serialize()),this._afterUpdate(e),this._report())},dispose:function(){this._super.dispose(),delete this.xelement},_serialize:function(){var e=(new XMLSerializer).serializeToString(this.xelement);return e.contains("</")&&(e=e.slice(e.indexOf(">")+1,e.lastIndexOf("<"))),e},_report:function(){this._super._report("edb.HardUpdate #"+this.id)}}),edb.SoftUpdate=edb.Update.extend("edb.SoftUpdate",{xelement:null,type:null,dispose:function(){this._super.dispose(),delete this.xelement},_import:function(e){var t=this.document.createElement(e.nodeName);return t.innerHTML=(new XMLSerializer).serializeToString(this.xelement),t.firstChild}}),edb.InsertUpdate=edb.SoftUpdate.extend("edb.InsertUpdate",{type:edb.Update.TYPE_INSERT,xelement:null,setup:function(e,t){return this.id=e,this.xelement=t,this},update:function(){var e=this.element(),t=e.parentNode,n=this._import(t);this._beforeUpdate(t)&&(t.insertBefore(n,e),this._afterUpdate(n),this._report())},_report:function(){this._super._report("edb.InsertUpdate #"+this.xelement.getAttribute("id"))}}),edb.AppendUpdate=edb.SoftUpdate.extend("edb.AppendUpdate",{type:edb.Update.TYPE_APPEND,setup:function(e,t){return this.id=e,this.xelement=t,this},update:function(){var e=this.element(),t=this._import(e);this._beforeUpdate(e)&&(e.appendChild(t),this._afterUpdate(t),this._report())},_report:function(){this._super._report("edb.AppendUpdate #"+this.xelement.getAttribute("id"))}}),edb.RemoveUpdate=edb.SoftUpdate.extend("edb.RemoveUpdate",{type:edb.Update.TYPE_REMOVE,setup:function(e){return this.id=e,this},update:function(){var e=this.element(),t=e.parentNode;this._beforeUpdate(e)&&(t.removeChild(e),this._afterUpdate(t),this._report())},_report:function(){this._super._report("edb.RemoveUpdate #"+this.id)}}),edb.ScriptUpdate=edb.Update.extend("edb.ScriptUpdate",{type:"edbscript",onconstruct:function(e){this._super.onconstruct(e),this._summary=[]},setup:function(e,t,n,r,i){return this._super.setup(),this._spirit=e,this._selector=t,this._name=n,this._value=r,this._key=i,this},update:function(){this._super.update();var e=null;try{e=this._spirit.dom.q(this._selector)}catch(t){throw new Error("Bad selector: "+this._selector)}finally{if(!e)throw new Error("No such element: "+this._selector);this._beforeUpdate(e)&&(this._update(e),this._afterUpdate(e),this._report())}},_spirit:null,_selector:null,_name:null,_value:null,_key:null,_update:function(e){var t=e.getAttribute(this._name);t.contains(this._key)?e.spirit?e.spirit.att.set(this._name,this._value):e.setAttribute(this._name,this._value):console.error("Target was moved: "+this._selector)},_report:function(){this._super._report("edb.ScriptUpdate "+this._selector)}}),function(){var e=edb.UpdateManager.prototype._attschanged;edb.UpdateManager.prototype._attschanged=function(t,n,r,i){return e.apply(this,arguments)?!Array.every(t,function(e){var t=n.getNamedItem(e.name),s=gui.KeyMaster.extractKey(e.value);e.name==="oninput"&&console.error(t.value+"\n "+e.value+"\n"+(t!==null&&t.value===e.value));if(s){var o=gui.KeyMaster.extractKey(t.value),u=(new edb.ScriptUpdate(this._doc)).setup(this._spirit,i,t.name,e.value,o[0]);return this._updates.collect(u,r),!0}return!1},this):!1}}(),edb.GenericScript=gui.Exemplar.create("edb.GenericScript",Object.prototype,{readyState:null,onreadystatechange:null,window:null,spirit:null,toString:function(){return"[object edb.GenericScript]"},onconstruct:function(e,t,n){this.spirit=e||null,this.window=t||null,this.onreadystatechange=n||null},compile:function(e,t){},run:function(){},_gostate:function(e){e!==this.readyState&&(this.readyState=e,gui.Type.isFunction(this.onreadystatechange)&&this.onreadystatechange())},__construct__:function(e,t,n){this.onconstruct(e,t,n)}},{},{LOADING:"loading",WAITING:"waiting",WORKING:"working",READY:"ready",_scripts:new Map,set:function(){var e=gui.Type.list(arguments),t=e.shift();e.forEach(function(e){this._scripts.set(e,t)},this)},get:function(e){var t=this._scripts.get(e);if(!t)throw new Error("No script engine registered for type: "+e);return t}}),edb.GenericLoader=gui.FileLoader.extend({load:function(e,t,n){var r=new gui.URL(this._document,e);this._cache.has(r.location)?this._cached(r,t,n):r.external?this._request(r,t,n):this._lookup(r,t,n)},_lookup:function(e,t,n){var r=this._document.querySelector(e.hash);this.onload(r.textContent,e,t,n)}},{},{_loaders:new Map,set:function(){var e=gui.Type.list(arguments),t=e.shift();e.forEach(function(e){this._loaders.set(e,t)},this)},get:function(e){var t=edb.GenericLoader;if(e){t=this._loaders.get(e);if(!t)throw new Error("No script loader registered for type: "+e)}return t}}),edb.Script=edb.GenericScript.extend("edb.Script",{context:null,pointer:null,params:null,input:null,functions:null,onconstruct:function(e,t,n){this._keys=new Set,this._super.onconstruct(e,t,n),this.pointer=this.spirit,this.spirit=null,this.context=this.window,this.window=null,this.input=new edb.InputTracker,this.input.context=this.context,this.functions=Object.create(null),gui.Broadcast.addGlobal(gui.BROADCAST_DATA_PUB,this)},compile:function(e,t,n){if(this._function!==null)throw new Error("not supported: compile script twice");var r=new edb.ScriptCompiler(e,t,n);this._signature&&r.sign(this._signature),this._function=r.compile(this.context),this.params=r.params,gui.Object.each(r.functions,function(e,t){t=(new gui.URL(this.context.document,t)).href;var n=edb.Function.get(t,this.context);n?this.functions[e]=n:(gui.Broadcast.addGlobal(edb.BROADCAST_FUNCTION_LOADED,this),this.functions[e]=t)},this),gui.Object.each(r.inputs,function(e,t){this.input.add(t,this)},this);try{gui.debug&&gui.Client.hasBlob&&!gui.Client.isExplorer&&!gui.Client.isOpera?this._blob(r):this._maybeready()}catch(i){this._maybeready()}return this},sign:function(e){return this._signature=e,this},run:function(){this._keys=new Set;var e=null,t=null;this._function?this.input.done||(e="Script awaits input"):e="Script not compiled";if(e!==null)throw new Error(e);return this._subscribe(!0),t=this._function.apply(this.pointer,arguments),this._subscribe(!1),t},onbroadcast:function(e){switch(e.type){case gui.BROADCAST_DATA_SUB:var t=e.data;this._keys.add(t);break;case gui.BROADCAST_DATA_PUB:if(this._keys.has(e.data)&&this.readyState!==edb.GenericScript.WAITING){var n=gui.TICK_SCRIPT_UPDATE,r=this.context.gui.signature;gui.Tick.one(n,this,r).dispatch(n,0,r),this._gostate(edb.GenericScript.WAITING)}break;case edb.BROADCAST_FUNCTION_LOADED:var i=e.data;gui.Object.each(this.functions,function(e,t){t===i&&(this.functions[e]=edb.Function.get(i,this.context))},this),this._maybeready()}},ontick:function(e){switch(e.type){case gui.TICK_SCRIPT_UPDATE:this._gostate(edb.GenericScript.READY)}},oninput:function(e){this._maybeready()},_keys:null,_function:null,_signature:null,_functionsdone:function(){return Object.keys(this.functions).every(function(e){return gui.Type.isFunction(this.functions[e])},this)},_blob:function(e){var t=gui.KeyMaster.generateKey(),n="// blob script generated in development mode\n",r="function "+t+" ("+this.params+") { "+n+e.source("	")+"\n}",i=this.context,s=i.document;this._gostate(edb.GenericScript.LOADING),gui.BlobLoader.loadScript(s,r,function(){this._gostate(edb.GenericScript.WORKING),this._function=i[t],this._maybeready()},this)},_maybeready:function(){this.readyState!==edb.GenericScript.LOADING&&(this._gostate(edb.GenericScript.WORKING),this.input.done&&this._functionsdone()?this._gostate(edb.GenericScript.READY):this._gostate(edb.GenericScript.WAITING))},_subscribe:function(e){gui.Broadcast[e?"addGlobal":"removeGlobal"](gui.BROADCAST_DATA_SUB,this),gui.Broadcast[e?"removeGlobal":"addGlobal"](gui.BROADCAST_DATA_PUB,this)}},{},{_invokables:new Map,_log:null,assign:function(e,t){var n=gui.KeyMaster.generateKey();return edb.Script._invokables.set(n,function(n,r){e.apply(t,[gui.Type.cast(n),r])}),n},invoke:function(e,t,n){var r=null;n=n||this._log;if(t)gui.Broadcast.dispatchGlobal(this,gui.BROADCAST_SCRIPT_INVOKE,{key:e,sig:t,log:n});else{if(!(r=this._invokables.get(e)))throw new Error("Invokable does not exist: "+e);n.type==="click"?setImmediate(function(){r(n.value,n.checked)}):r(n.value,n.checked)}},register:function(e){return this._log={type:e.type,value:e.target.value,checked:e.target.checked},this}}),edb.Loader=edb.GenericLoader.extend("edb.Loader",{onload:function(e,t,n,r){t.external&&(e=this._extract(e,t)),this._super.onload(e,t,n,r)},_extract:function(e,t){var n=this._document.createElement("div");n.innerHTML=e;var r=n.querySelector(t.hash||"script"),i=null;if(r)switch(r.type){case"text/edbml":i=r.textContent;break;default:console.error("Bad script type: "+(r.type||"[no script type]"))}else console.error("No script found: "+t.location);return i}}),edb.Att=function(){},edb.Att.prototype=gui.Object.create(null,{toString:function(){return"[object edb.Att]"},_out:function(e){var t,n="";return gui.Type.isDefined(this[e])&&(t=edb.Att.encode(this[e]),n+=e+'="'+t+'" '),n},_pop:function(e){var t=this._out(e);return delete this[e],t},_all:function(){var e="";return gui.Object.nonmethods(this).forEach(function(t){e+=this._out(t)},this),e}}),edb.Att.encode=function(e){var t=gui.Type.of(e);switch(t){case"string":break;case"number":case"boolean":e=String(e);break;case"object":case"array":try{e=encodeURIComponent(JSON.stringify(e))}catch(n){throw new Error("Could not create HTML attribute: "+n)}break;case"date":throw new Error("TODO: edb.Att.encode standard date format?");default:throw new Error("Could not create HTML attribute for "+t)}return e},edb.Out=function(){this.html=""},edb.Out.prototype={html:null,write:function(){return this.html}},edb.Function={get:function(e,t){e=(new gui.URL(t.document,e)).href;var n=this._map.get(e)||null;return n||this._load(e,t),n},_map:new Map,_load:function(e,t){(new edb.Loader(t.document)).load(e,function(n){(new edb.Script(null,t,function(){this.readyState===edb.GenericScript.READY&&(edb.Function._map.set(e,this._function),gui.Broadcast.dispatchGlobal(null,edb.BROADCAST_FUNCTION_LOADED,e))})).compile(n,t.gui.debug)})}},edb.Instruction=function(e){this.atts=Object.create(null),this.type=e.split("<?")[1].split(" ")[0];var t,n=edb.Instruction._ATEXP;while(t=n.exec(e)){var r=t[1],i=t[2];this.atts[r]=gui.Type.cast(i)}},edb.Instruction.prototype={type:null,atts:null,toString:function(){return"[object edb.Instruction]"}},edb.Instruction.from=function(e){var t=[],n=null,r=null;while(r=this._PIEXP.exec(e))t.push(new edb.Instruction(r[0]));return t},edb.Instruction.clean=function(e){return e.replace(this._PIEXP,"")},edb.Instruction._PIEXP=/<\?.[^>?]+\?>/g,edb.Instruction._ATEXP=/(\S+)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g,edb.FunctionCompiler=gui.Exemplar.create(Object.prototype,{script:null,debug:!1,params:null,functions:null,extras:null,onconstruct:function(e,t,n){this.script=e,this.extras=n,this.debug=t?!0:!1},compile:function(e,t){var n=null;this.params=[],this.functions=Object.create(null),this._vars=[];var r={declarations:Object.create(null),definitions:[]};["_validate","_tag","_extract","_declare","_cornholio","_compile"].forEach(function(e){this.script=this[e](this.script,r)},this);try{this.debug&&console.log(this.source("	",this.params)),n=this._convert(e,this.script,this.params)}catch(i){t||(n=this._fail(e,i))}return n},source:function(e,t){var n=this._format(this.script);e&&(n=e+n.replace(/\n/g,"\n"+e));if(t){var r=t.length?"( "+t.join(", ")+" )":"()";n="function "+r+" {\n"+n+"\n}"}return n},sign:function(e){return this._signature=e,this},_signature:null,_instructions:null,_validate:function(e){if(this.debug&&edb.FunctionCompiler._NESTEXP.test(e))throw"Nested EDBML dysfunction";return e},_tag:function(e){if(this.extras){var t=this.extras.tag;t&&(e='\n<?param name="__content__"?>\n<?param name="__attribs__"?>\natt = __attribs__;\n'+e)}return e},_extract:function(e,t){return edb.Instruction.from(e).forEach(function(e){this._instruct(e)},this),edb.Instruction.clean(e)},_instruct:function(e){var t=e.atts;switch(e.type){case"param":this.params.push(t.name);break;case"script":this.functions[t.name]=t.src}},_declare:function(e,t){var n=[];return gui.Object.each(this.functions,function(e,r){t.declarations[e]=!0,n.push(e+" = __functions__ [ '"+e+"' ];\n")},this),n[0]&&t.definitions.push("( function lookup ( __functions__ ) {\n"+n.join("")+"})( this.view.script.functions );"),e},_cornholio:function(e,t){var n="";Object.keys(t.declarations).forEach(function(e){n+=", "+e+" = null"});var r="var out = new edb.Out (), att = new edb.Att ()"+n+";\n";return t.definitions.forEach(function(e){r+=e+"\n"}),r+e},_compile:function(e,t){function d(e,t){var i,s,o,u;this._behind(e,t,"@")||(this._ahead(e,t,"@")?(r+="' + att._all () + '",l=2):(i=e.substring(t+1),s=n.exec(i)[0],o=this._behind(e,t,"-"),u=o?"att._pop":"att._out",r=o?r.substring(0,r.length-1):r,r+="' + "+u+" ( '"+s+"' ) + '",l=s.length+1))}function v(e,t){var i,s;if(!this._behind(e,t,"@"))if(this._ahead(e,t,"@"))r+="var att = new edb.Att ();",l=2;else{i=e.substring(t+1),s=n.exec(i)[0];if(!s)throw"Bad @name: "+i;r+=i.replace(s,"att['"+s+"']"),l=i.length}}var n=edb.FunctionCompiler._ATTREXP,r='"use strict";\n',i=!1,s=!1,o=!1,u=!1,a=!1,f=null,l=0,c=0,h=0,p=0;return e.split("\n").forEach(function(e,t){e=e.trim(),c=e.length-1,a=e.charAt(0)==="+",u=u||i&&a,e.length>0&&(t>0&&(i?u||(r+="';\n",i=!1):r+="\n"),u=!1,Array.forEach(e,function(t,n){if(i)switch(t){case"{":s||o;break;case"}":s&&(s=!1,l=1,r+=") + '"),o&&(r=this._inject(r,h,f,p++),o=!1,f=null,l=1);break;case"$":!s&&!o&&this._ahead(e,n,"{")&&(s=!0,l=2,r+="' + (");break;case"#":!s&&!o&&this._ahead(e,n,"{")&&(o=!0,f="",l=2);break;case"+":switch(n){case 0:l=a?1:0;break;case c:u=!0,l=1}break;case"'":!s&&!o&&(r+="\\");break;case"@":d.call(this,e,n)}else switch(t){case"<":n===0&&(i=!0,h=r.length-1,r+="out.html += '");break;case"@":v.call(this,e,n)}l--<=0&&(o?f+=t:r+=t)},this))},this),r+=(i?"';":"")+"\nreturn out.write ();",this.debug?this._format(r):r},_inject:function(e,t,n,r){var i=this._signature?", &quot;"+this._signature+"&quot;":"";return e.substring(0,t)+"\n"+"var __edb__"+r+" = edb.Script.assign ( function ( value, checked ) { \n"+n+";\n"+"}, this );"+e.substring(t)+"edb.Script.register ( event ).invoke ( &quot;' + __edb__"+r+" + '&quot;"+i+" );"},_convert:function(e,t,n){var r="";return gui.Type.isArray(n)&&(r=n.join(",")),new e.Function(r,t)},_ahead:function(e,t,n){var r=t+1,i=n.length;return e.length>t+i&&e.substring(r,r+i)===n},_behind:function(e,t,n){var r=n.length,i=t-r;return i>=0&&e.substr(i,r)===n},_fail:function(e,t){return this._debug(this._format(this.script)),this.script='<p class="error">'+t.message+"</p>",this.compile(e,!0)},_debug:function(e){if(window.btoa){e=window.btoa("function debug () {\n"+e+"\n}");var t=document.createElement("script");t.src="data:text/javascript;base64,"+e,document.querySelector("head").appendChild(t),t.onload=function(){this.parentNode.removeChild(this)}}},_format:function(e){var t="",n="",r=null,i=null,s=null,o=null;return e.split("\n").forEach(function(e){e=e.trim(),r=e.charAt(0),i=e.charAt(e.length-1),s=e.split("//")[0].trim(),o=s.charAt(s.length-1),(r==="}"||r==="]")&&n!==""&&(n=n.slice(0,-1)),t+=n+e+"\n";if(i==="{"||i==="["||o==="{"||o==="[")n+="	"}),t}}),edb.FunctionCompiler._NESTEXP=/<script.*type=["']?text\/edbml["']?.*>([\s\S]+?)/g,edb.FunctionCompiler._ATTREXP=/^[^\d][a-zA-Z0-9-_\.]+/,edb.ScriptCompiler=edb.FunctionCompiler.extend({inputs:null,_instruct:function(e){this._super._instruct(e);var t=e.atts;switch(e.type){case"input":this.inputs[t.name]=t.type}},compile:function(e,t){return this.inputs=Object.create(null),this._super.compile(e,t)},_declare:function(e,t){this._super._declare(e,t);var n=[];return gui.Object.each(this.inputs,function(e,r){t.declarations[e]=!0,n.push(e+" = __input__.get ( "+r+" );\n")},this),n[0]&&t.definitions.push("( function lookup ( __input__ ) {\n"+n.join("")+"})( this.view.script.input );"),e}}),gui.module("edb",{addins:{oninput:function(e){}},plugins:{view:edb.SpiritView,input:edb.InputTracker,output:edb.Output},channels:[["script[type='text/edbml']","edb.ScriptSpirit"],["link[rel='service']","edb.ServiceSpirit"]],init:function(e){e===gui.context&&edb.GenericScript&&edb.GenericLoader&&(edb.GenericScript.set(edb.Script,"text/edbml"),edb.GenericLoader.set(edb.Loader,"text/edbml")),e.Object.model=function(e,t){return edb.ObjectModel.extend(e,t)},e.Array.model=function(e,t){return edb.ArrayModel.extend(e,t)},e.Map.model=function(e,t){return edb.MapModel.extend(e,t)}}});