/*
 * Spiritual EDB 0.0.2
 * (c) 2013 Wunderbyte
 * Spiritual is freely distributable under the MIT license.
 */
window.edb=gui.namespace("edb",{toString:function(){return"[namespace edb]"},BROADCAST_FUNCTION_LOADED:"broadcast-function-loaded",BROADCAST_TAG_LOADED:"broadcast-tag-loaded",LIFE_SCRIPT_WILL_RUN:"life-script-will-run",LIFE_SCRIPT_DID_RUN:"life-script-did-run",TICK_SCRIPT_UPDATE:"gui-tick-spiritscript-update",TICK_COLLECT_INPUT:"gui-tick-collect-input"}),edb.Type=function(){},edb.Type.prototype={$primaryKey:"id",_instanceKey:null,onconstruct:function(){},$init:function(){},$sub:function(){gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_DATA_SUB,this._instanceKey)},$pub:function(){gui.Broadcast.dispatchGlobal(null,gui.BROADCAST_DATA_PUB,this._instanceKey)},$serialize:function(pretty){var clone=JSON.parse(JSON.stringify(this));return Object.keys(clone).forEach(function(key){switch(key.charAt(0)){case"$":case"_":delete clone[key]}}),JSON.stringify(clone,null,pretty?"	":"")},toString:function(){return"edb.Type#toString :)"}},edb.Object=gui.Class.create("edb.Object",edb.Type.prototype,{__construct__:function(data){this._instanceKey=gui.KeyMaster.generateKey();var type=gui.Type.of(data);switch(type){case"object":case"undefined":edb.Object.approximate(this,data),this.onconstruct();break;default:throw new TypeError("Unexpected argument of type "+type.toUpperCase()+":\n"+data)}}},{__name__:"DataObject",__data__:!0},{approximate:function(handler,proxy){var def=null;proxy=proxy||{};var model={};this._definitions(handler).forEach(function(key){switch(def=handler[key],gui.Type.of(def)){case"function":if(gui.Type.isConstructor(def)){var C=def;model[key]=new C(proxy[key])}break;case"object":console.warn("TODO: approximate object: "+key),console.warn(JSON.stringify(def));break;case"array":console.warn("TODO: approximate array: "+key),console.warn(JSON.stringify(def));break;default:gui.Type.isDefined(proxy[key])||(proxy[key]=handler[key])}}),gui.Object.nonmethods(proxy).forEach(function(key){Object.defineProperty(handler,key,{enumerable:!0,configurable:!0,get:function(){return this.$sub(),model[key]||proxy[key]},set:function(value){var target=model[key]?model:proxy;target[key]=value,this.$pub()}})})},_definitions:function(handler){function fix(key){gui.Type.isDefined(Object.prototype[key])||gui.Type.isDefined(edb.Type.prototype[key])||key.startsWith("_")||keys.push(key)}var keys=[];for(var key in handler)fix(key);return keys}}),edb.Array=gui.Class.create("edb.Array",Array.prototype,{$contentmodel:null,__construct__:function(){this._instanceKey=gui.KeyMaster.generateKey();var C=this.constructor;if(C.__content__&&(this.$contentmodel=C.__content__,C.__content__=null),gui.Type.isDefined(arguments[0])){var input=[];gui.Type.isArray(arguments[0])?input=arguments[0]:Array.forEach(arguments,function(arg){input.push(arg)});var boxer=this.$contentmodel||this.$cm;gui.Type.isFunction(boxer)&&input.forEach(function(o){if(void 0!==o){if(!o._instanceKey){var Model=boxer;gui.Type.isConstructor(Model)||(Model=boxer(o)),o=new Model(o)}Array.prototype.push.call(this,o)}},this)}edb.Array.approximate(this,{}),this.onconstruct()}},{__name__:"DataList",__data__:!0,__content__:null},{approximate:function(handler,proxy){var def=null;proxy=proxy||{},this._definitions(handler).forEach(function(key){switch(def=handler[key],gui.Type.of(def)){case"function":break;case"object":case"array":console.warn("TODO: complex stuff on edb.Array :)");break;default:gui.Type.isDefined(proxy[key])||(proxy[key]=handler[key])}}),gui.Object.nonmethods(proxy).forEach(function(key){Object.defineProperty(handler,key,{enumerable:!0,configurable:!0,get:function(){return this.$sub(),proxy[key]},set:function(value){proxy[key]=value,this.$pub()}})})},_definitions:function(handler){function fix(key){gui.Type.isNumber(gui.Type.cast(key))||gui.Type.isDefined(Array.prototype[key])||gui.Type.isDefined(edb.Type.prototype[key])||key.startsWith("_")||keys.push(key)}var keys=[];for(var key in handler)fix(key);return keys}}),function(){"use strict";Object.keys(edb.Type.prototype).forEach(function(def){this[def]=edb.Type.prototype[def]},this),["filter","forEach","every","map","some","indexOf","lastIndexOf"].forEach(function(method){this[method]=function(){var result=Array.prototype[method].apply(this,arguments);return this.$sub(),result}},this),["push","pop","shift","unshift","splice","reverse"].forEach(function(method){this[method]=function(){var result=Array.prototype[method].apply(this,arguments);return this.$pub(),result}},this),this.concat=function(other){var clone=new this.constructor;return this.forEach(function(o){clone.push(o)}),other.forEach(function(o){clone.push(o)}),clone}}.call(edb.Array.prototype),edb.ScriptPlugin=gui.Plugin.extend("edb.ScriptPlugin",{type:"text/edbml",src:null,loaded:!0,autorun:!0,ran:!1,diff:!0,debug:!1,extras:null,onconstruct:function(){this._super.onconstruct();var spirit=this.spirit;spirit instanceof edb.ScriptSpirit?this.autorun=!1:this.diff&&(this._updater=new edb.UpdateManager(spirit)),this.src&&spirit.life.add(gui.LIFE_ENTER,this)},onlife:function(life){life.type===gui.LIFE_ENTER&&this.load(this.src)},functions:function(){return this._script.functions},input:function(){return this._script.input},load:function(src,type){var context=this.spirit.window;edb.Template.load(context,src,type||this.type,function(script){this._compiled(script)},this)},compile:function(source,type,directives){var context=this.spirit.window;edb.Template.compile(context,source,type||this.type,directives,function(script){this._compiled(script)},this)},run:function(){this._script?(this._script.pointer=this.spirit,this.write(this._script.run.apply(this._script,arguments))):console.warn("Running uncompiled script")},write:function(html){this.diff?this._updater.update(html):this.spirit.dom.html(html),this.ran=!0,this.spirit.life.dispatch(edb.LIFE_SCRIPT_DID_RUN,(this._latest=html)!==this._latest)},_script:null,_updater:null,_compiled:function(script){this._script=script,this.loaded=!0,this.debug&&this._script.debug(),this.autorun&&this.run()}},{lazy:!1}),edb.OutputPlugin=gui.Plugin.extend("edb.OutputPlugin",{dispatch:function(data,Type){var input=this._format(data,Type);if(!(input instanceof edb.Input))throw new TypeError("Not an instance of edb.Input: "+input);if(!input.type)throw Error("edb.Input type is "+input.type);input.type.output=input,gui.Broadcast.dispatchGlobal(this.sandboxed?null:this.spirit,gui.BROADCAST_OUTPUT,input)},_format:function(data,Type){if(data instanceof edb.Input==!1){if(Type)Type=this._lookup(Type),data instanceof Type==!1&&(data=new Type(data));else if(data._instanceKey)Type=data.constructor;else{switch(gui.Type.of(data)){case"object":Type=Object.model();break;case"array":Type=Array.model()}data=this._format(data,Type)}data=new edb.Input(Type,data)}return data},_lookup:function(arg){var type=null;switch(gui.Type.of(arg)){case"function":type=arg;break;case"string":type=gui.Object.lookup(arg,this.context);break;case"object":console.error(this+": expected edb.Type constructor (not an object)")}if(!type)throw new TypeError('The type "'+arg+'" does not exist');return type}}),edb.InputPlugin=gui.Tracker.extend("edb.InputPlugin",{done:!0,onconstruct:function(){this._super.onconstruct(),gui.Broadcast.addGlobal(gui.BROADCAST_OUTPUT,this),this._watches=[],this._matches=[]},add:gui.Combo.chained(function(arg,handler){this.done=!1,handler=handler?handler:this.spirit,arg=edb.InputPlugin._breakdown(arg,this.context),this._add(arg,handler)}),remove:gui.Combo.chained(function(arg,handler){handler=handler?handler:this.spirit,arg=edb.InputPlugin._breakdown(arg,this.context),this._remove(arg,handler),this.done=this._matches.length===this._watches.length}),get:function(type){var types=this._matches.map(function(input){return input.data.constructor}),best=edb.InputPlugin._bestmatch(type,types),input=best?this._matches.filter(function(input){return input.type===best}).shift():null;return input?input.data:null},onbroadcast:function(b){b.type===gui.BROADCAST_OUTPUT&&this._maybeinput(b.data)},_watches:null,_matches:null,_add:function(types,handler){types.forEach(function(type){this._watches.push(type),this._addchecks(type.__indexident__,[handler]),type.output&&gui.Tick.next(function(){this._todoname()},this)},this)},_remove:function(types,handler){types.forEach(function(type){var index=this._watches.indexOf(type);index>-1&&(this._watches.remove(index),this._removechecks(type.__indexident__,[handler]))},this)},_todoname:function(){this._watches.forEach(function(type){type.output instanceof edb.Input&&this._maybeinput(type.output)},this)},_maybeinput:function(input){var best=edb.InputPlugin._bestmatch(input.type,this._watches);best&&(this._updatematch(input),this.done=this._matches.length===this._watches.length,this._updatehandlers(input))},_updatematch:function(newinput){var matches=this._matches,types=matches.map(function(input){return input.type}),best=edb.InputPlugin._bestmatch(newinput.type,types);if(best){var oldinput=matches.filter(function(input){return input.type===best})[0],index=matches.indexOf(oldinput);matches[index]=newinput}else matches.push(newinput)},_updatehandlers:function(input){gui.Class.ancestorsAndSelf(input.type,function(Type){var list=this._xxx[Type.__indexident__];list&&list.forEach(function(checks){var handler=checks[0];handler.oninput(input)})},this)}},{},{_breakdown:function(arg,context){switch(gui.Type.of(arg)){case"array":return this._breakarray(arg,context);default:return this._breakother(arg,context)}},_breakarray:function(array,context){return array.map(function(o){switch(gui.Type.of(o)){case"function":return o;case"string":return gui.Object.lookup(o,context);case"object":console.error("Expected function. Got object.")}},this)},_breakother:function(arg,context){switch(gui.Type.of(arg)){case"function":return[arg];case"string":return this._breakarray(arg.split(" "),context);case"object":console.error("Expected function. Got object.")}},_bestmatch:function(target,types){var best=null,rating=Number.MAX_VALUE;return this._rateall(target,types,function(type,rate){rate>-1&&rating>rate&&(best=type)}),best},_rateall:function(target,types,action){types.forEach(function(type){action(type,this._rateone(target,type))},this)},_rateone:function(target,type){if(target===type)return 0;var tops=gui.Class.ancestorsAndSelf(target),subs=gui.Class.descendantsAndSelf(target),itop=tops.indexOf(type),isub=subs.indexOf(type);return 0>itop?isub:itop}}),edb.Input=function(type,data){this.type=type||null,this.data=data||null},edb.Input.prototype={type:null,data:null,toString:function(){return"[object edb.Input]"}},edb.Input.add=function(handler){console.log("deprecated"),gui.Broadcast.addGlobal(gui.BROADCAST_OUTPUT,handler)},edb.Input.remove=function(handler){console.log("deprecated"),gui.Broadcast.removeGlobal(gui.BROADCAST_OUTPUT,handler)},edb.ScriptSpirit=gui.Spirit.infuse("edb.ScriptSpirit",{debug:!1,config:{map:{debug:"debug"}},onenter:function(){this._super.onenter(),this._plainscript()||this.dom.parent(gui.Spirit)&&this._initplugin()},_plainscript:function(){var is=!1;switch(this.att.get("type")){case null:case"text/ecmacript":case"text/javascript":case"application/javascript":case"application/x-javascript":is=!0}return is},_initplugin:function(){var src=this.att.get("src")||this.src,type=this.att.get("type")||this.type,parent=this.dom.parent(),extras=this.att.getmap(),plugin=parent.spirit.script;plugin.extras=extras,plugin.debug=this.debug,src?plugin.load(src,type,extras):plugin.compile(this.dom.text(),type,extras)}}),edb.ServiceSpirit=gui.Spirit.infuse("edb.ServiceSpirit",{onconstruct:function(){this._super.onconstruct();var type=this.att.get("type");if(!type)throw Error("TODO: formalize missing type somehow");var Type=gui.Object.lookup(type,this.window);this.att.get("href")?new gui.Request(this.element.href).acceptJSON().get(function(status,data){this.output.dispatch(new Type(data))},this):this.output.dispatch(new Type)},_pipeline:function(){console.error("TODO: might this be outdated???");var data=new this.output._type(this._arg(0),this._arg(1),this._arg(2),this._arg(3),this._arg(4),this._arg(5),this._arg(6),this._arg(7),this._arg(8),this._arg(9));this.output.dispatch(data)},_arg:function(index){var type=this.input._types[index];return this.input.get(type)}}),edb.Instruction=function(pi){this.atts=Object.create(null),this.type=pi.split("<?")[1].split(" ")[0];for(var hit,atexp=edb.Instruction._ATEXP;hit=atexp.exec(pi);){var n=hit[1],v=hit[2];this.atts[n]=gui.Type.cast(v)}},edb.Instruction.prototype={type:null,atts:null,toString:function(){return"[object edb.Instruction]"}},edb.Instruction.from=function(source){for(var pis=[],hit=null;hit=this._PIEXP.exec(source);)pis.push(new edb.Instruction(hit[0]));return pis},edb.Instruction.clean=function(source){return source.replace(this._PIEXP,"")},edb.Instruction._PIEXP=/<\?.[^>?]+\?>/g,edb.Instruction._ATEXP=/(\S+)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g,edb.Runner=function(){},edb.Runner.prototype={firstline:!1,lastline:!1,firstchar:!1,lastchar:!1,run:function(compiler,script,status,result){this._runlines(compiler,script.split("\n"),status,result)},ahead:function(string){var line=this._line,index=this._index,i=index+1,l=string.length;return line.length>index+l&&line.substring(i,i+l)===string},behind:function(string){var line=this._line,index=this._index,length=string.length,start=index-length;return start>=0&&line.substr(start,length)===string},_line:null,_index:-1,_runlines:function(compiler,lines,status,result){var stop=lines.length-1;lines.forEach(function(line,i){this._line=line,this.firstline=0===i,this.lastline=i===stop,compiler.online(line,this,status,result),this._runchars(compiler,line.split(""),status,result)},this)},_runchars:function(compiler,chars,status,result){var stop=chars.length-1;chars.forEach(function(c,i){this._index=i,this.firstchar=0===i,this.lastchar=i===stop,compiler.onchar(c,this,status,result)},this)}},edb.Status=function(body){this.body=body||"",this.conf=[]},edb.Status.prototype={mode:edb.Status.MODE_JS,body:null,peek:!1,poke:!1,cont:!1,adds:!1,func:null,conf:null,skip:0,last:0,spot:0,indx:0,refs:!1},edb.Status.MODE_JS="js",edb.Status.MODE_HTML="html",edb.Status.MODE_TAG="tag",edb.Result=function(text){this.body=text||""},edb.Result.prototype={body:null},edb.State=function(body){this.body=body||"",this.conf=[]},edb.State.prototype={mode:edb.State.MODE_JS,body:null,peek:!1,poke:!1,cont:!1,adds:!1,func:null,conf:null,skip:0,last:0,spot:0,indx:0,refs:!1},edb.State.MODE_JS="js",edb.State.MODE_HTML="html",edb.State.MODE_TAG="tag",edb.Template=gui.Class.create("edb.Template",Object.prototype,{readyState:null,onreadystatechange:null,context:null,spirit:null,toString:function(){return"[object edb.Template]"},onconstruct:function(spirit,window,handler){this.spirit=spirit||null,this.context=window||null,this.onreadystatechange=handler||null},compile:function(){},run:function(){},_gostate:function(state){state!==this.readyState&&(this.readyState=state,gui.Type.isFunction(this.onreadystatechange)&&this.onreadystatechange())}},{},{LOADING:"loading",WAITING:"waiting",WORKING:"working",READY:"ready",setImplementation:function(){var args=gui.Object.toArray(arguments),impl=args.shift();args.forEach(function(type){this._implementations.set(type,impl)},this)},getImplementation:function(type){var impl=this._implementations.get(type);if(!impl)throw Error("No implementation for: "+type);return impl},load:function(context,src,type,callback,thisp){new edb.TemplateLoader(context.document).load(src,function(source){var url=new gui.URL(context.document,src),script=edb.Script.get(url.href);script?callback.call(thisp,script):this.compile(context,source,type,null,function(script){edb.Script.set(url.href,script),callback.call(thisp,script)},this)},this)},compile:function(context,source,type,directives,callback,thisp){var Script=this.getImplementation(type),script=new Script(null,context,function(){this.readyState===edb.Template.READY&&callback.call(thisp,this)});script.compile(source,directives)},_implementations:new Map}),edb.TemplateLoader=gui.FileLoader.extend({directives:null,load:function(src,callback,thisp){var url=new gui.URL(this._document,src);this._cache.has(url.location)?this._cached(url,callback,thisp):url.external?this._request(url,callback,thisp):this._lookup(url,callback,thisp)},onload:function(text,url,callback,thisp){url.external&&(text=this._extract(text,url)),callback.call(thisp,text,this.directives),this.directives=null},_lookup:function(url,callback,thisp){var script=this._document.querySelector(url.hash);this.directives=gui.AttPlugin.getmap(script),this.onload(script.textContent,url,callback,thisp)},_extract:function(text,url){var temp=this._document.createElement("div");temp.innerHTML=text;var script=temp.querySelector(url.hash||"script");return script?(this.directives=gui.AttPlugin.getmap(script),script.textContent):(console.error("No script found: "+url.location),void 0)}},{},{_loaders:new Map,set:function(){var args=gui.Object.toArray(arguments),impl=args.shift();args.forEach(function(type){this._loaders.set(type,impl)},this)},get:function(type){var impl=edb.BaseLoader;if(type&&(impl=this._loaders.get(type),!impl))throw Error("No script loader registered for type: "+type);return impl}}),edb.Compiler=gui.Class.create(Object.prototype,{_compile:function(script){var state=new edb.State('"use strict";\n');return script.split("\n").forEach(function(line,index){this._compileline(state,line,index)},this),state.body+=("html"===state.mode?"';":"")+"\nreturn out.write ();",this._format(state.body)},_compileline:function(state,line,index){line=line.trim(),state.last=line.length-1,state.adds="+"===line.charAt(0),state.cont=state.cont||"html"===state.mode&&state.adds,line.length>0&&(index>0&&("html"===state.mode?state.cont||(state.body+="';\n",state.mode="js"):state.body+="\n"),state.cont=!1,Array.forEach(line,function(c,i){this._compilechar(state,c,i,line)},this))},_compilechar:function(state,c,i,line){switch(state.mode){case"tag":this._compiletag(state,c,i,line);break;case"html":this._compilehtml(state,c,i,line);break;default:this._compilescript(state,c,i,line)}0>=state.skip--&&(state.poke?state.func+=c:"tag"!==state.mode&&(state.body+=c))},_compilehtml:function(state,c,i,line){switch(c){case"{":state.peek||state.poke;break;case"}":state.peek&&(state.peek=!1,state.skip=1,state.body+=") + '"),state.poke&&(state.body=this._inject(state.body,state.spot,state.func,state.indx++),state.poke=!1,state.func=null,state.skip=1);break;case"$":state.peek||state.poke||!this._ahead(line,i,"{")||(state.peek=!0,state.skip=2,state.body+="' + (");break;case"#":state.peek||state.poke||!this._ahead(line,i,"{")||(state.poke=!0,state.func="",state.skip=2);break;case"+":switch(i){case 0:state.skip=state.adds?1:0;break;case state.last:state.cont=!0,state.skip=1}break;case"'":state.peek||state.poke||(state.body+="\\");break;case"@":this._htmlatt(state,line,i)}},_compilescript:function(state,c,i,line){switch(c){case"<":if(0===i){var tag;(tag=this._tagstart(line))?(state.mode="tag",this._aaa(state,line,i)):(tag=this._tagstop(line))?(state.mode="tag",this._bbb(state)):(state.mode="html",state.spot=state.body.length-1,state.body+="out.html += '")}break;case"@":this._scriptatt(state,line,i)}},_aaa:function(state,line){state.body+="out.html += Tag.get ( '#ole', window )( function ( out ) {";var elem=new gui.HTMLParser(document).parse(line+"</ole>")[0],json=JSON.stringify(gui.AttPlugin.getmap(elem),null,"	"),atts=this._fixerupper(json);state.conf.push(atts)},_bbb:function(state){state.body+="}, "+state.conf.pop()+");",state.conf=null},_fixerupper:function(json){var state=new edb.State;state.body="";var lines=json.split("\n");return lines.forEach(function(line,index){Array.forEach(line,function(c,i){switch(c){case'"':state.peek||state.poke||(this._ahead(line,i,"${")?(state.peek=!0,state.skip=3):this._ahead(line,i,"#{")&&(state.poke=!0,state.skip=3,state.func=" function () {\n",state.spot=state.body.length-1));break;case"}":(state.peek||state.poke)&&this._skipahead(line,i,'"')&&(state.poke&&(state.func+="\n}",state.body=state.body.substring(0,state.spot)+state.func+state.body.substring(state.spot)),state.peek=!1,state.poke=!1,state.skip=2)}0>=state.skip--&&(state.poke?state.func+=c:state.body+=c)},this),lines.length-1>index&&(state.body+="\n")},this),state.body},_compiletag:function(state,c,i,line){switch(c){case"$":this._ahead(line,i,"{")&&(state.refs=!0,state.skip=2);break;case">":state.mode="js",state.skip=1}},_ahead:function(line,index,string){var i=index+1,l=string.length;return line.length>index+l&&line.substring(i,i+l)===string},_behind:function(line,index,string){var length=string.length,start=index-length;return start>=0&&line.substr(start,length)===string},_skipahead:function(line,index,string){return line=line.substr(index).replace(/ /g,""),this._ahead(line,0,string)},_tagstart:function(line){return this._ahead(line,0,"ole")},_tagstop:function(line){return this._ahead(line,0,"/ole>")},_htmlatt:function(state,line,i){var rest,name,dels,what,attr=edb.Compiler._ATTREXP;this._behind(line,i,"@")||this._behind(line,i,"#{")||(this._ahead(line,i,"@")?(state.body+="' + att._all () + '",state.skip=2):(rest=line.substring(i+1),name=attr.exec(rest)[0],dels=this._behind(line,i,"-"),what=dels?"att._pop":"att._out",state.body=dels?state.body.substring(0,state.body.length-1):state.body,state.body+="' + "+what+" ( '"+name+"' ) + '",state.skip=name.length+1))},_scriptatt:function(state,line,i){var rest,name,attr=edb.Compiler._ATTREXP;if(this._behind(line,i,"@"));else if(this._ahead(line,i,"@"))state.body+="var att = new edb.Att ();",state.skip=2;else{if(rest=line.substring(i+1),name=attr.exec(rest)[0],!name)throw"Bad @name: "+rest;state.body+=rest.replace(name,"att['"+name+"']"),state.skip=rest.length}},_inject:function(body,spot,func,index){var sig=this._signature?", &quot;"+this._signature+"&quot;":"";return body.substring(0,spot)+"\n"+"var __edb__"+index+" = edb.Script.assign ( function ( value, checked ) { \n"+func+";\n"+"}, this );"+body.substring(spot)+"edb.Script.register ( event ).invoke ( &quot;' + __edb__"+index+" + '&quot;"+sig+" );"},_format:function(body){var result="",tabs="	",first=null,last=null,fixt=null,flast=null;return body.split("\n").forEach(function(line){line=line.trim(),first=line.charAt(0),last=line.charAt(line.length-1),fixt=line.split("//")[0].trim(),flast=fixt.charAt(fixt.length-1),"}"!==first&&"]"!==first||""===tabs||(tabs=tabs.slice(0,-1)),result+=tabs+line+"\n",("{"===last||"["===last||"{"===flast||"["===flast)&&(tabs+="	")}),result}},{},{_ATTREXP:/^[^\d][a-zA-Z0-9-_\.]+/}),edb.FunctionCompiler=edb.Compiler.extend("edb.FunctionCompiler",{source:null,params:null,functions:null,tags:null,directives:null,sequence:null,onconstruct:function(source,directives){this.directives=directives||Object.create(null),this.source=source,this.sequence=["_validate","_extract","_direct","_declare","_define","_compile"]},compile:function(scope){var result=null;this.params=[],this.tags=Object.create(null),this.functions=Object.create(null),this._vars=[];var head={declarations:Object.create(null),definitions:[]};this.sequence.forEach(function(step){this.source=this[step](this.source,head)},this);try{result=this._convert(scope,this.source,this.params),this.source=this._source(this.source,this.params)}catch(exception){result=this._fail(scope,exception)}return result},sign:function(signature){return this._signature=signature,this},_signature:null,_instructions:null,_failed:!1,_validate:function(script){if(edb.FunctionCompiler._NESTEXP.test(script))throw"Nested EDBML dysfunction";return script},_direct:function(script){return script},_extract:function(script){return edb.Instruction.from(script).forEach(function(pi){this._instruct(pi)},this),edb.Instruction.clean(script)},_instruct:function(pi){var atts=pi.atts;switch(pi.type){case"param":this.params.push(atts.name);break;case"function":this.functions[atts.name]=atts.src;break;case"tag":var name=atts.src.split("#")[1];if(!name)throw Error("Missing #identifier: "+atts.src);this.tags[name]=atts.src}},_declare:function(script,head){var funcs=[];return gui.Object.each(this.functions,function(name){head.declarations[name]=!0,funcs.push(name+" = functions [ '"+name+"' ];\n")},this),funcs[0]&&head.definitions.push("( function lookup ( functions ) {\n"+funcs.join("")+"})( this.script.functions ());"),script},_define:function(script,head){var vars="";Object.keys(head.declarations).forEach(function(name){vars+=", "+name+" = null"});var html="var Out = edb.Out, Att = edb.Att, Tag = edb.Tag, out = new Out (), att = new Att ()"+vars+";\n";return head.definitions.forEach(function(def){html+=def+"\n"}),html+script},_convert:function(scope,script,params){var args="";return gui.Type.isArray(params)&&(args=params.join(",")),new scope.Function(args,script)},_fail:function(scope,exception){if(this._failed)throw exception;return this._failed=!0,this._debug(scope,this._format(this.source)),this.source='<p class="error">'+exception.message+"</p>",this.compile(scope,!0)},_debug:function(scope,source){if(window.btoa){source=scope.btoa("function debug () {\n"+source+"\n}");var script=scope.document.createElement("script");script.src="data:text/javascript;base64,"+source,scope.document.querySelector("head").appendChild(script),script.onload=function(){this.parentNode.removeChild(this)}}},_source:function(source,params){var lines=source.split("\n");lines.pop();var args=params.length?"( "+params.join(", ")+" )":"()";return"function "+args+" {\n"+lines.join("\n")+"\n}"}},{},{_NESTEXP:/<script.*type=["']?text\/edbml["']?.*>([\s\S]+?)/g}),edb.ScriptCompiler=edb.FunctionCompiler.extend({inputs:null,_instruct:function(pi){this._super._instruct(pi);var atts=pi.atts;switch(pi.type){case"input":this.inputs[atts.name]=atts.type}},compile:function(scope,fallback){return this.inputs=Object.create(null),this._super.compile(scope,fallback)},_declare:function(script,head){this._super._declare(script,head);var defs=[];return gui.Object.each(this.inputs,function(name,type){head.declarations[name]=!0,defs.push(name+" = __input__.get ( "+type+" );\n")},this),defs[0]&&head.definitions.push("( function lookup ( __input__ ) {\n"+defs.join("")+"})( this.script.input ());"),script}}),edb.TagCompiler=edb.FunctionCompiler.extend("edb.TagCompiler",{_direct:function(script){if(this.directives.tag){var content=edb.TagCompiler._CONTENT;this.params.push("content"),this.params.push("attribs"),script="att = new Att ( attribs );\n"+script,script=script.replace(content,"content ( out );")}return this._super._direct(script)}},{},{_CONTENT:/<content(.*)>(.*)<\/content>|<content(.*)(\/?)>/}),edb.Function=edb.Template.extend("edb.Function",{context:null,pointer:null,params:null,functions:null,tags:null,onconstruct:function(pointer,context,handler){this._super.onconstruct(pointer,context,handler),this.pointer=this.spirit,this.context=context,this.spirit=null,this.tags=Object.create(null),this.functions=Object.create(null)},compile:function(source,directives){if(null!==this._function)throw Error("TODO: recompile the script :)");var compiler=this._compiler=new this._Compiler(source,directives);return this._signature&&compiler.sign(this._signature),this._function=compiler.compile(this.context),this._source=compiler.source,this.params=compiler.params,gui.Object.each(compiler.tags,function(name,src){this._tagload(name,src)},this),gui.Object.each(compiler.functions,function(name,src){this._functionload(name,src)},this),this._oncompiled()},debug:function(){console.debug(this._source)},sign:function(signature){return this._signature=signature,this},run:function(){var result=null;if(!this._function)throw Error("Script not compiled");try{this._subscribe(!0),result=this._function.apply(this.pointer,arguments),this._subscribe(!1)}catch(exception){console.error(exception.message+":\n\n"+this._source)}return result},onbroadcast:function(b){switch(b.type){case edb.BROADCAST_FUNCTION_LOADED:this._functionloaded(b.data);break;case edb.BROADCAST_TAG_LOADED:this._tagloaded(b.data)}},_function:null,_signature:null,_Compiler:edb.FunctionCompiler,_compiler:null,_oncompiled:function(){try{this._useblob()?this._loadblob():this._maybeready()}catch(workerexception){this._maybeready()}return this},_useblob:function(){return edb.Function.useblob&&this.context.gui.debug&&gui.Client.hasBlob&&!gui.Client.isExplorer&&!gui.Client.isOpera},_loadblob:function(){var win=this.context,doc=win.document,key=gui.KeyMaster.generateKey("function"),src=this._compiler.source.replace("function","function "+key);this._gostate(edb.Template.LOADING),gui.BlobLoader.loadScript(doc,src,function(){this._gostate(edb.Template.WORKING),this._function=win[key],this._maybeready()},this)},_tagload:function(name,src){src=gui.URL.absolute(this.context.document,src);var tag=edb.Tag.get(src,this.context);tag?this.tags[name]=tag:(this._await(edb.BROADCAST_TAG_LOADED,!0),this.tags[name]=src)},_functionload:function(name,src){src=gui.URL.absolute(this.context.document,src);var func=edb.Function.get(src,this.context);if(gui.Type.isDefined(this.functions[name]))throw Error('var "'+name+'" already used');func?this.functions[name]=func:(this._await(edb.BROADCAST_FUNCTION_LOADED,!0),this.functions[name]=src)},_functionloaded:function(src){gui.Object.each(this.functions,function(name,value){value===src&&(this.functions[name]=edb.Function.get(src,this.context))},this),this._maybeready()},_tagloaded:function(src){gui.Object.each(this.tags,function(name,value){value===src&&(this.tags[name]=edb.Tag.get(src,this.context))},this),this._maybeready()},_await:function(msg,add){var act=add?"add":"remove",sig=this.context.gui.signature;gui.Broadcast[act](msg,this,sig)},_maybeready:function(){this.readyState!==edb.Template.LOADING&&(this._gostate(edb.Template.WORKING),this._done()?(this._await(edb.BROADCAST_TAG_LOADED,!1),this._await(edb.BROADCAST_FUNCTION_LOADED,!1),this._gostate(edb.Template.READY)):this._gostate(edb.Template.WAITING))},_done:function(){return["functions","tags"].every(function(map){return Object.keys(this[map]).every(function(name){return gui.Type.isFunction(this[map][name])},this)},this)},_subscribe:function(isBuilding){gui.Broadcast[isBuilding?"addGlobal":"removeGlobal"](gui.BROADCAST_DATA_SUB,this),gui.Broadcast[isBuilding?"removeGlobal":"addGlobal"](gui.BROADCAST_DATA_PUB,this)}},{get:function(src,win){src=new gui.URL(win.document,src).href;var has=gui.Type.isFunction(this._map[src]);return has?this._map[src]:this._load(src,win)},_broadcast:edb.BROADCAST_FUNCTION_LOADED,_map:Object.create(null),_load:function(src,win){var func=null,Implementation=this,cast=this._broadcast,sig=win.gui.signature;return new edb.TemplateLoader(win.document).load(src,function(source,directives){new Implementation(null,win,function(){this.readyState===edb.Template.READY&&(func=Implementation._map[src]=this._function,directives.debug&&this.debug(),gui.Broadcast.dispatch(null,cast,src,sig))}).compile(source,directives)}),func}},{useblob:!0}),edb.Script=edb.Function.extend("edb.Script",{input:null,onconstruct:function(pointer,context,handler){this._super.onconstruct(pointer,context,handler),this.input=new edb.InputPlugin,this.input.context=this.context,this.input.onconstruct(),console.warn("Bad: onconstruct should autoinvoke"),this._keys=new Set,gui.Broadcast.addGlobal(gui.BROADCAST_DATA_PUB,this)},onbroadcast:function(b){switch(this._super.onbroadcast(b),b.type){case gui.BROADCAST_DATA_SUB:this._keys.add(b.data);break;case gui.BROADCAST_DATA_PUB:if(this._keys.has(b.data)&&this.readyState!==edb.Template.WAITING){var tick=edb.TICK_SCRIPT_UPDATE,sig=this.context.gui.signature;gui.Tick.one(tick,this,sig).dispatch(tick,0,sig),this._gostate(edb.Template.WAITING)}}},ontick:function(tick){switch(tick.type){case edb.TICK_SCRIPT_UPDATE:this._gostate(edb.Template.READY)}},oninput:function(){this._maybeready()},run:function(){if(this._keys=new Set,this.input.done)return this._super.run.apply(this,arguments);throw Error("Script awaits input")
},_Compiler:edb.ScriptCompiler,_keys:null,_resolved:!1,_oncompiled:function(){return gui.Object.each(this._compiler.inputs,function(name,type){this.input.add(type,this)},this),this._super._oncompiled()},_done:function(){return this.input.done&&this._super._done()}},{_invokables:new Map,_log:null,assign:function(func,thisp){var key=gui.KeyMaster.generateKey();return edb.Script._invokables.set(key,function(value,checked){func.apply(thisp,[gui.Type.cast(value),checked])}),key},invoke:function(key,sig,log){var func=null;if(log=log||this._log,sig)gui.Broadcast.dispatchGlobal(this,gui.BROADCAST_SCRIPT_INVOKE,{key:key,sig:sig,log:log});else{if(!(func=this._invokables.get(key)))throw Error("Invokable does not exist: "+key);"click"===log.type?setImmediate(function(){func(log.value,log.checked)}):func(log.value,log.checked)}},register:function(e){return this._log={type:e.type,value:e.target.value,checked:e.target.checked},this},get:function(key){return this._scripts[key]},set:function(key,script){this._scripts[key]=script},_scripts:Object.create(null)}),edb.Tag=edb.Function.extend("edb.Tag",{compile:function(source,directives){return directives.tag=!0,this._super.compile(source,directives)},_Compiler:edb.TagCompiler},{_map:Object.create(null),_broadcast:edb.BROADCAST_TAG_LOADED}),edb.Att=function(atts){atts&&gui.Object.extend(this,atts)},edb.Att.prototype=gui.Object.create(null,{toString:function(){return"[object edb.Att]"},_out:function(att){var val,html="";return gui.Type.isDefined(this[att])&&(val=edb.Att.encode(this[att]),html+=att+'="'+val+'" '),html},_pop:function(att){var html=this._out(att);return delete this[att],html},_all:function(){var html="";return gui.Object.nonmethods(this).forEach(function(att){html+=this._out(att)},this),html}}),edb.Att.encode=function(data){var type=gui.Type.of(data);switch(type){case"string":break;case"number":case"boolean":data+="";break;case"object":case"array":try{data=encodeURIComponent(JSON.stringify(data))}catch(jsonex){throw Error("Could not create HTML attribute: "+jsonex)}break;case"date":throw Error("TODO: edb.Att.encode standard date format?");default:throw Error("Could not create HTML attribute for "+type)}return data},edb.Out=function(){this.html=""},edb.Out.prototype={html:null,write:function(){return this.html}},edb.UpdateAssistant={id:function(element){return gui.Type.isDefined(element.id)?element.id||null:element.getAttribute("id")||null},parse:function(doc,markup,id,element){return element=doc.createElement(element.localName),element.innerHTML=markup,element.id=id,Array.forEach(element.querySelectorAll("option"),function(option){switch(option.getAttribute("selected")){case"true":option.setAttribute("selected","selected");break;case"false":option.removeAttribute("selected")}}),Array.forEach(element.querySelectorAll("input[type=checkbox],input[type=radio]"),function(option){switch(option.getAttribute("checked")){case"true":option.setAttribute("checked","checked");break;case"false":option.removeAttribute("checked")}}),element},order:function(nodes){var order=new Map;return Array.forEach(nodes,function(node,index){node.nodeType===Node.ELEMENT_NODE&&order.set(this.id(node),index)},this),order},index:function(nodes){var result=Object.create(null);return Array.forEach(nodes,function(node){node.nodeType===Node.ELEMENT_NODE&&(result[this.id(node)]=node)},this),result}},edb.UpdateManager=function(spirit){this._keyid=spirit.dom.id()||spirit.spiritkey,this._spirit=spirit,this._doc=spirit.document},edb.UpdateManager.prototype={update:function(html){this._updates=new edb.UpdateCollector,null===this._olddom?this._first(html):this._next(html),this._updates.eachRelevant(function(update){update.update(),update.dispose()}),this._updates.dispose(),delete this._updates},_keyid:null,_doc:null,_spirit:null,_olddom:null,_nedwdom:null,_updates:null,_assistant:edb.UpdateAssistant,_first:function(html){this._olddom=this._parse(html),this._updates.collect(new edb.HardUpdate(this._doc).setup(this._keyid,this._olddom))},_next:function(html){this._newdom=this._parse(html),this._crawl(this._newdom,this._olddom,this._newdom,this._keyid,{},null),this._olddom=this._newdom},_parse:function(html){return this._assistant.parse(this._doc,html,this._keyid,this._spirit.element)},_crawl:function(newchild,oldchild,lastnode,id,ids,css){for(var result=!0,n=1;newchild&&oldchild&&!this._updates.hardupdates(id);){switch(newchild.nodeType){case Node.TEXT_NODE:result=this._check(newchild,oldchild,lastnode,id,ids,css,n);break;case Node.ELEMENT_NODE:result=this._scan(newchild,oldchild,lastnode,id,ids,css,n),n++}newchild=newchild.nextSibling,oldchild=oldchild.nextSibling}return result},_scan:function(newnode,oldnode,lastnode,id,ids,css,n){var result=!0,oldid=this._assistant.id(oldnode);return css=css?oldid?"#"+oldid:css+">"+oldnode.localName+":nth-child("+n+")":"this",(result=this._check(newnode,oldnode,lastnode,id,ids,css,n))&&(oldid&&(ids=gui.Object.copy(ids),lastnode=newnode,ids[oldid]=!0,id=oldid),result=this._crawl(newnode.firstChild,oldnode.firstChild,lastnode,id,ids,css)),result},_check:function(newnode,oldnode,lastnode,id,ids,css,n){var result=!0,isSoftUpdate=!1,isPluginUpdate=!1;if(newnode&&!oldnode||!newnode&&oldnode)result=!1;else if(result=newnode.nodeType===oldnode.nodeType)switch(oldnode.nodeType){case Node.TEXT_NODE:newnode.data!==oldnode.data&&(result=!1);break;case Node.ELEMENT_NODE:(result=this._familiar(newnode,oldnode))&&(result=this._checkatts(newnode,oldnode,ids,css))&&(this._maybesoft(newnode,oldnode)?(this._confirmsoft(newnode,oldnode)&&(this._updatesoft(newnode,oldnode,ids,css,n),isSoftUpdate=!0),result=!1):"textarea"!==oldnode.localName&&(result=newnode.childNodes.length===oldnode.childNodes.length))}return result||isSoftUpdate||isPluginUpdate||this._updates.collect(new edb.HardUpdate(this._doc).setup(id,lastnode)),result},_familiar:function(newnode,oldnode){return["namespaceURI","localName"].every(function(prop){return newnode[prop]===oldnode[prop]})},_checkatts:function(newnode,oldnode,ids,css){var result=!0,update=null;if(this._attschanged(newnode.attributes,oldnode.attributes,ids,css)){var newid=this._assistant.id(newnode),oldid=this._assistant.id(oldnode);newid&&newid===oldid?(update=new edb.AttsUpdate(this._doc).setup(oldid,newnode,oldnode),this._updates.collect(update,ids)):result=!1}return result},_attschanged:function(newatts,oldatts){return newatts.length!==oldatts.length||!Array.every(newatts,function(newatt){var oldatt=oldatts.getNamedItem(newatt.name);return oldatt&&oldatt.value===newatt.value})},_maybesoft:function(newnode,oldnode){return newnode&&oldnode?this._maybesoft(newnode)&&this._maybesoft(oldnode):Array.every(newnode.childNodes,function(node){var res=!0;switch(node.nodeType){case Node.TEXT_NODE:res=""===node.data.trim();break;case Node.ELEMENT_NODE:res=null!==this._assistant.id(node)}return res},this)},_confirmsoft:function(newnode,oldnode){var res=!0,prev=null,oldorder=this._assistant.order(oldnode.childNodes);return Array.every(newnode.childNodes,function(node){if(node.nodeType===Node.ELEMENT_NODE){var id=this._assistant.id(node);oldorder.has(id)&&oldorder.has(prev)&&(res=oldorder.get(id)>oldorder.get(prev)),prev=id}return res},this)},_updatesoft:function(newnode,oldnode,ids,css,n){for(var updates=[],news=this._assistant.index(newnode.childNodes),olds=this._assistant.index(oldnode.childNodes),child=newnode.lastElementChild,topid=this._assistant.id(oldnode),oldid=null,newid=null;child;)newid=this._assistant.id(child),olds[newid]?oldid=newid:oldid?updates.push(new edb.InsertUpdate(this._doc).setup(oldid,child)):updates.push(new edb.AppendUpdate(this._doc).setup(topid,child)),child=child.previousElementSibling;Object.keys(olds).forEach(function(id){if(news[id]){var n1=news[id],n2=olds[id];this._scan(n1,n2,n1,id,ids,css,n)}else updates.push(new edb.RemoveUpdate(this._doc).setup(id))},this),updates.reverse().forEach(function(update){this._updates.collect(update,ids)},this)}},edb.UpdateCollector=function(){this._updates=[],this._hardupdates=new Set},edb.UpdateCollector.prototype={_updates:null,_hardupdates:null,toString:function(){return"[object edb.UpdateCollector]"},collect:function(update,ids){this._updates.push(update),update.type===edb.Update.TYPE_HARD?this._hardupdates.add(update.id):update.ids=ids},hardupdates:function(id){return this._hardupdates.has(id)},eachRelevant:function(action){this._updates.filter(function(update){return update.type===edb.Update.TYPE_HARD||Object.keys(update.ids).every(function(id){return!this.hardupdates(id)},this)},this).forEach(function(update){action(update)})},dispose:function(){delete this._hardupdates,delete this._updates}},edb.Update=gui.Class.create("edb.Update",Object.prototype,{type:null,id:null,window:null,document:null,__construct__:function(doc){this.onconstruct(doc)},onconstruct:function(doc){this.document=doc,this.window=doc.defaultView},setup:function(){return this},update:function(){},element:function(){var element=null;if(element=gui.KeyMaster.isKey(this.id)?this.window.gui.get(this.id).element:this.document.getElementById(this.id),!element)throw Error("No element to match: "+this.id);return element},dispose:function(){delete this.window,delete this.document},_beforeUpdate:function(element){var event="x-beforeupdate-"+this.type;return this._dispatch(element,event)},_afterUpdate:function(element){var event="x-aftrerupdate-"+this.type;return this._dispatch(element,event)},_dispatch:function(element,name){var event=this.document.createEvent("UIEvents");return event.initEvent(name,!0,!0),element.dispatchEvent(event)},_report:function(report){this.window.gui.debug&&(gui.KeyMaster.isKey(this.id)&&(report=report.replace(this.id,"(anonymous)")),console.debug(report))}},{},{TYPE_HARD:"hard",TYPE_ATTS:"atts",TYPE_INSERT:"insert",TYPE_APPEND:"append",TYPE_REMOVE:"remove"}),edb.AttsUpdate=edb.Update.extend("edb.AttsUpdate",{type:edb.Update.TYPE_ATTS,_xold:null,_xnew:null,_summary:null,onconstruct:function(doc){this._super.onconstruct(doc),this._summary=[]},setup:function(id,xnew,xold){return this._super.setup(),this.id=id,this._xnew=xnew,this._xold=xold,this},update:function(){this._super.update();var element=this.element();this._beforeUpdate(element)&&(this._update(element),this._afterUpdate(element),this._report())},dispose:function(){this._super.dispose(),delete this._xold,delete this._xnew},_update:function(element){Array.forEach(this._xnew.attributes,function(newatt){var oldatt=this._xold.getAttribute(newatt.name);(null===oldatt||oldatt!==newatt.value)&&(this._set(element,newatt.name,newatt.value),this._summary.push("@"+newatt.name))},this),Array.forEach(this._xold.attributes,function(oldatt){this._xnew.hasAttribute(oldatt.name)||(this._del(element,oldatt.name,null),this._summary.push("@"+oldatt.value))},this)},_set:function(element,name,value){var spirit=element.spirit;if(spirit)spirit.att.set(name,value);else switch(element.setAttribute(name,value),name){case"checked":element.checked||(element.checked=!0);break;case"value":element.value!==value&&(element.value=value+"")}},_del:function(element,name){var spirit=element.spirit;if(spirit)spirit.att.del(name);else switch(name){case"checked":element.checked=!1;break;default:element.removeAttribute(name)}},_report:function(){this._super._report('edb.AttsUpdate "#'+this.id+'" '+this._summary.join(", "))}}),edb.HardUpdate=edb.Update.extend("edb.HardUpdate",{type:edb.Update.TYPE_HARD,xelement:null,setup:function(id,xelement){return this._super.setup(),this.id=id,this.xelement=xelement,this},update:function(){this._super.update();var element=this.element();this._beforeUpdate(element)&&(gui.DOMPlugin.html(element,this._serialize()),this._afterUpdate(element),this._report())},dispose:function(){this._super.dispose(),delete this.xelement},_serialize:function(){var xhtml=(new XMLSerializer).serializeToString(this.xelement);return xhtml.contains("</")&&(xhtml=xhtml.slice(xhtml.indexOf(">")+1,xhtml.lastIndexOf("<"))),xhtml},_report:function(){this._super._report("edb.HardUpdate #"+this.id)}}),edb.SoftUpdate=edb.Update.extend("edb.SoftUpdate",{xelement:null,type:null,dispose:function(){this._super.dispose(),delete this.xelement},_import:function(parent){var temp=this.document.createElement(parent.nodeName);return temp.innerHTML=(new XMLSerializer).serializeToString(this.xelement),temp.firstChild}}),edb.InsertUpdate=edb.SoftUpdate.extend("edb.InsertUpdate",{type:edb.Update.TYPE_INSERT,xelement:null,setup:function(id,xelement){return this.id=id,this.xelement=xelement,this},update:function(){var sibling=this.element(),parent=sibling.parentNode,child=this._import(parent);this._beforeUpdate(parent)&&(parent.insertBefore(child,sibling),this._afterUpdate(child),this._report())},_report:function(){this._super._report("edb.InsertUpdate #"+this.xelement.getAttribute("id"))}}),edb.AppendUpdate=edb.SoftUpdate.extend("edb.AppendUpdate",{type:edb.Update.TYPE_APPEND,setup:function(id,xelement){return this.id=id,this.xelement=xelement,this},update:function(){var parent=this.element(),child=this._import(parent);this._beforeUpdate(parent)&&(parent.appendChild(child),this._afterUpdate(child),this._report())},_report:function(){this._super._report("edb.AppendUpdate #"+this.xelement.getAttribute("id"))}}),edb.RemoveUpdate=edb.SoftUpdate.extend("edb.RemoveUpdate",{type:edb.Update.TYPE_REMOVE,setup:function(id){return this.id=id,this},update:function(){var element=this.element(),parent=element.parentNode;this._beforeUpdate(element)&&(parent.removeChild(element),this._afterUpdate(parent),this._report())},_report:function(){this._super._report("edb.RemoveUpdate #"+this.id)}}),edb.ScriptUpdate=edb.Update.extend("edb.ScriptUpdate",{type:"edbscript",onconstruct:function(doc){this._super.onconstruct(doc),this._summary=[]},setup:function(spirit,selector,name,value,key){return this._super.setup(),this._spirit=spirit,this._selector=selector,this._name=name,this._value=value,this._key=key,this},update:function(){this._super.update();var element=null;try{element=this._spirit.dom.q(this._selector)}catch(domexception){throw Error("Bad selector: "+this._selector)}finally{if(!element)throw Error("No such element: "+this._selector);this._beforeUpdate(element)&&(this._update(element),this._afterUpdate(element),this._report())}},_spirit:null,_selector:null,_name:null,_value:null,_key:null,_update:function(element){var current=element.getAttribute(this._name);current.contains(this._key)?element.spirit?element.spirit.att.set(this._name,this._value):element.setAttribute(this._name,this._value):console.error("Target was moved: "+this._selector)},_report:function(){this._super._report("edb.ScriptUpdate "+this._selector)}}),function(){var method=edb.UpdateManager.prototype._attschanged;edb.UpdateManager.prototype._attschanged=function(newatts,oldatts,ids,css){return method.apply(this,arguments)?!Array.every(newatts,function(newatt){var oldatt=oldatts.getNamedItem(newatt.name),newhit=gui.KeyMaster.extractKey(newatt.value);if("oninput"===newatt.name&&console.error(oldatt.value+"\n "+newatt.value+"\n"+(null!==oldatt&&oldatt.value===newatt.value)),newhit){var oldhit=gui.KeyMaster.extractKey(oldatt.value),update=new edb.ScriptUpdate(this._doc).setup(this._spirit,css,oldatt.name,newatt.value,oldhit[0]);return this._updates.collect(update,ids),!0}return!1},this):!1}}(),gui.module("edb",{mixins:{oninput:function(){}},plugins:{script:edb.ScriptPlugin,input:edb.InputPlugin,output:edb.OutputPlugin},channels:[["script[type='text/edbml']","edb.ScriptSpirit"],["link[rel='service']","edb.ServiceSpirit"]],init:function(context){context.Object.model=function(a1,a2){return edb.Object.extend(a1,a2)},context.Array.model=function(a1,a2){return edb.Array.extend(a1,a2)},context.Map.model=function(a1,a2){return edb.MapModel.extend(a1,a2)},context===gui.context&&edb.Template&&edb.TemplateLoader&&edb.Template.setImplementation(edb.Script,"application/x-edbml","application/edbml","text/edbml","edbml")}});