/**
 * Spiritual EDB
 * (c) 2013 Wunderbyte
 * Spiritual is freely distributable under the MIT license.
 */
!function(t){"use strict";t.edb=gui.namespace("edb",{debug:!0,portals:!1,useblobs:!0,BROADCAST_ACCESS:"edb-broadcast-access",BROADCAST_CHANGE:"edb-broadcast-change",BROADCAST_OUTPUT:"edb-broadcast-output",BROADCAST_SCRIPT_INVOKE:"edb-broadcast-script-invoke",LIFE_SCRIPT_WILL_RUN:"edb-life-script-will-run",LIFE_SCRIPT_DID_RUN:"edb-life-script-did-run",TICK_SCRIPT_UPDATE:"edb-tick-script-update",TICK_COLLECT_INPUT:"edb-tick-collect-input",TICK_PUBLISH_CHANGES:"edb-tick-update-changes",set:function(t,e){return edb.Script.$assign(t,e)},get:function(t,e){return edb.Script.$tempname(t,e)},go:function(t,e,n){edb.Script.$register(t),edb.Script.$invoke(e,n)}}),edb.Type=function(){},edb.Type.prototype={$id:null,_instanceid:null,onconstruct:function(){},$onconstruct:function(){edb.Type.underscoreinstanceid(this),edb.Type.$confirmpersist(this)},$oninit:function(){},$ondestruct:function(){edb.Type.$maybepersist(this)},$output:function(t){return edb.Output.dispatch(this,t||self),this},$stringify:function(t,e){return JSON.stringify(this.$normalize(),t,e)},$GET:function(){throw new Error("Not supported. Use "+this.constructor+".$GET(optionalid)")},$PUT:function(t){return this.constructor.PUT(this,t)},$POST:function(t){return this.constructor.POST(this,t)},$DELETE:function(t){return this.constructor.DELETE(this,t)}},gui.Object.each({getter:gui.Combo.before(function(){gui.Broadcast.dispatch(this,edb.BROADCAST_ACCESS,this._instanceid)}),setter:gui.Combo.after(function(){gui.Broadcast.dispatch(this,edb.BROADCAST_CHANGE,this._instanceid)}),decorateGetters:function(t,e){return e.forEach(function(e){t[e]=edb.Type.getter(t[e])}),t},decorateSetters:function(t,e){return e.forEach(function(e){t[e]=edb.Type.setter(t[e])}),t},underscoreinstanceid:function(t){Object.defineProperty(t,"_instanceid",{value:t.$instanceid})},isInstance:function(t){return gui.Type.isComplex(t)?t instanceof edb.Object||t instanceof edb.Array:!1},lookup:function(t,e){var n=null;switch(gui.Type.of(e)){case"function":n=e;break;case"string":n=gui.Object.lookup(e,t);break;case"object":console.error(this+": expected edb.Type constructor (not an object)")}if(!n)throw new TypeError('The type "'+e+'" does not exist');return n},cast:function(t){if(gui.Type.isComplex(t)&&!edb.Type.isInstance(t))switch(gui.Type.of(t)){case"object":return new edb.Object(t);case"array":return new edb.Array(t)}return t},$confirmpersist:function(t){var e=t.constructor;if(e.storage&&edb.Storage.$typecheck(t)&&arguments.length>1)throw new Error("Persisted models and collections must construct with a single arg")},$maybepersist:function(t){var e=t.constructor;e.storage&&e.$store(t,!0)}},function(t,e){edb.Type[t]=e}),function(){var t={out:function(){return edb.Output.out(this)}},e={storage:null,restore:function(t){return this.storage.getItem(this.$classname,t||self)},$store:function(t,e){this.storage.setItem(this.$classname,t,t.$context,e)}},n={uri:null,primarykey:"_id",GET:function(){return this.$httpread.apply(this,arguments)},PUT:function(t,e){return this.$httpupdate("PUT",t,e)},POST:function(t,e){return this.$httpupdate("POST",t,e)},DELETE:function(t,e){return this.$httpupdate("DELETE",t,e)},$httpread:function(){var t,e,n,i=this,s=new gui.Then;return Array.forEach(arguments,function(t){switch(gui.Type.of(t)){case"string":e=t;break;case"object":n=t}}),t=gui.URL.parametrize(this.uri,n),this.$httprequest(t,"GET",null,function(t){s.now(i.$httpresponse(t))}),s},$httpupdate:function(t,e,n){var i=this,s=new gui.Then,r=gui.URL.parametrize(e.uri,n),o=gui.Type.isInstance(e)?e.$normalize():e;return this.$httprequest(r,t||"PUT",o,function(e){s.now(i.$httpresponse(e,n,t))}),s},$httprequest:function(t,e,n,i){var s=new gui.Request(t);e=e.toLowerCase(),s[e](n).then(function(t,e){i(e)})},$httpresponse:function(t){var e=this;switch(gui.Type.of(t)){case"object":case"array":t=new e(t)}return t}};[t,e,n].forEach(function(t){gui.Object.each(t,function(t,e){edb.Type[t]=e})}),edb.Type.$staticmixins=function(){var i={};return[n,t,e].forEach(function(t){Object.keys(t).forEach(function(t){i[t]=this[t]},this)},this),i}}(),edb.Object=function(t,e,n,i){return gui.Class.create(Object.prototype,{$onconstruct:function(t){switch(edb.Type.prototype.$onconstruct.apply(this,arguments),gui.Type.of(t)){case"object":case"undefined":edb.Object._approximate(this,t||Object.create(null));break;default:throw new TypeError("Unexpected edb.Object constructor argument of type "+gui.Type.of(t)+": "+String(t))}this.onconstruct.apply(this,arguments),this.$oninit()},$normalize:function(){var t,e={};return gui.Object.each(this,function(n,i){t=n[0],"$"!==t&&"_"!==t&&(edb.Type.isInstance(i)&&(i=i.$normalize()),e[n]=i)}),e}},function(){return edb.Type.$staticmixins()}(),{observe:function(t,e){var n=t.$instanceid||t._instanceid,i=this._observers,s=i[n]||(i[n]=[]);return-1===s.indexOf(e)&&s.push(e),t},unobserve:function(t,e){var n,i=t.$instanceid||t._instanceid,s=this._observers,r=s[i];return r&&(n=r.indexOf(e))>-1&&0===gui.Array.remove(r,n)&&delete s[i],t},ontick:function(t){var e,n,i,s,r=this._observers;t.type===edb.TICK_PUBLISH_CHANGES&&(e=gui.Object.copy(this._changes),this._changes=Object.create(null),gui.Object.each(e,function(t){(s=r[t])&&(n=gui.Object.each(e,function(e,n){return i=n[Object.keys(n)[0]],e===t?i:null}).filter(function(t){return null!==t}),s.forEach(function(t){t.onchange(n)})),gui.Broadcast.dispatch(null,edb.BROADCAST_CHANGE,t)}))},_observers:Object.create(null),_getter:function(t,e){return function(){var n=e.apply(this);return edb.Object._onaccess(this,t),n}},_setter:function(t,e){return function(n){var i=this[t];e.apply(this,arguments),edb.Object._onchange(this,t,i,n),i=n}},_onaccess:function(t,e){var n=new edb.ObjectAccess(t,e);gui.Broadcast.dispatch(null,edb.BROADCAST_ACCESS,n.instanceid)},_onchange:function(t,e,n,i){var s=this._changes,r=t._instanceid,o=s[r]=s[r]||(s[r]=Object.create(null));o[e]=new edb.ObjectChange(t,e,edb.ObjectChange.TYPE_UPDATED,n,i),gui.Tick.dispatch(edb.TICK_PUBLISH_CHANGES)},_changes:Object.create(null),_approximate:function(s,r){var o,u,c,a=s.constructor.$classname,d=Object.create(null);this._definitions(s).forEach(function(h){if(u=s[h],c=r[h],t(c)){if(!t(u))throw new TypeError(a+' declares "'+h+'" as something undefined');if(e(u))if(n(u)){if(i(u)||(u=u(c)),!i(u))throw new TypeError(a+' "'+h+'" must resolve to a constructor');o=u,d[h]=new o(r[h])}else d[h]=edb.Type.cast(t(c)?c:u)}else r[h]=u}),gui.Object.nonmethods(r).forEach(function(t){u=r[t],gui.Type.isComplex(u)&&(d[t]||(d[t]=edb.Type.cast(u))),gui.Property.accessor(s,t,{getter:edb.Object._getter(t,function(){return d[t]||r[t]}),setter:edb.Object._setter(t,function(e){var n=d[t]?d:r;n[t]=edb.Type.cast(e)})})})},_definitions:function(t){var e=[];return gui.Object.all(t,function(t){gui.Type.isDefined(Object.prototype[t])||gui.Type.isDefined(edb.Type.prototype[t])||t.startsWith("_")||e.push(t)}),e}})}(gui.Type.isDefined,gui.Type.isComplex,gui.Type.isFunction,gui.Type.isConstructor),function(){gui.Tick.add(edb.TICK_PUBLISH_CHANGES,edb.Object),gui.Object.extendmissing(edb.Object.prototype,edb.Type.prototype)}(),function(t){edb.Array=gui.Class.create(t,{push:function(){var e=t.push.apply(this,arguments);return Array.forEach(arguments,function(t){edb.Array._onchange(this,1,t)},this),e},pop:function(){var e=t.pop.apply(this,arguments);return edb.Array._onchange(this,0,e),e},shift:function(){var e=t.shift.apply(this,arguments);return edb.Array._onchange(this,0,e),e},unshift:function(){var e=t.unshift.apply(this,arguments);return Array.forEach(arguments,function(t){edb.Array._onchange(this,1,t)},this),e},splice:function(){var e=t.splice.apply(this,arguments),n=[].slice.call(arguments,2);return e.forEach(function(t){edb.Array._onchange(this,0,t)},this),n.forEach(function(t){edb.Array._onchange(this,1,t)},this),e},$of:null,$onconstruct:function(){edb.Type.prototype.$onconstruct.apply(this,arguments),edb.Array.populate(this,arguments),edb.Array.approximate(this),this.onconstruct.call(this,arguments),this.$oninit()},$normalize:function(){return Array.map(this,function(t){return edb.Type.isInstance(t)?t.$normalize():t})}},function(){return edb.Type.$staticmixins()}(),{populate:function(t,e){var n;e.length&&(n=[],n=gui.Type.isArray(e[0])?e[0]:Array.prototype.slice.call(e),n=gui.Type.isFunction(t.$of)?edb.Array._populatefunction(n,t.$of):edb.Array._populatedefault(n),Array.prototype.push.apply(t,n))},approximate:function(t,e){var n=null;e=e||Object.create(null),this._definitions(t).forEach(function(i){switch(n=t[i],gui.Type.of(n)){case"function":break;case"object":case"array":console.warn("TODO: complex stuff on edb.Array :)");break;default:gui.Type.isDefined(e[i])||(e[i]=t[i])}}),gui.Object.nonmethods(e).forEach(function(n){Object.defineProperty(t,n,{enumerable:!0,configurable:!0,get:edb.Type.getter(function(){return e[n]}),set:edb.Type.setter(function(t){e[n]=t})})})},_definitions:function(t){var e=[];for(var n in t)this._define(n)&&e.push(n);return e},_define:function(t){return gui.Type.isNumber(gui.Type.cast(t))||gui.Type.isDefined(Array.prototype[t])||gui.Type.isDefined(edb.Type.prototype[t])||t.startsWith("_")?!1:!0},_populatefunction:function(t,e){return t.map(function(t){if(void 0!==t&&!t._instanceid){var n=e;gui.Type.isConstructor(n)||(n=e(t)),t=new n(t)}return t})},_populatedefault:function(t){return t.map(function(t){if(!edb.Type.isInstance(t))switch(gui.Type.of(t)){case"object":return new edb.Object(t);case"array":return new edb.Array(t)}return t})},_onaccess:function(){},_onchange:function(t,e){e={0:edb.ArrayChange.TYPE_REMOVED,1:edb.ArrayChange.TYPE_ADDED}[e]}})}(Array.prototype),function(t){edb.Type.decorateGetters(t,["filter","forEach","every","map","some","indexOf","lastIndexOf"]),edb.Type.decorateSetters(t,["push","unshift","splice","pop","shift","reverse"]),t.concat=function(t){var e=new this.constructor;return this.forEach(function(t){e.push(t)}),t.forEach(function(t){e.push(t)}),e}}(edb.Array.prototype),function(){gui.Object.extendmissing(edb.Array.prototype,edb.Type.prototype)}(),edb.ObjectAccess=function(t,e){this.instanceid=t._instanceid,this.object=t,this.name=e},edb.ObjectAccess.prototype={instanceid:null,object:null,name:null},edb.ObjectChange=function(t,e,n,i,s){this.object=t,this.name=e,this.type=n,this.oldValue=i,this.newValue=s},edb.ObjectChange.prototype={object:null,name:null,type:null,oldValue:void 0,newValue:void 0},edb.ObjectChange.TYPE_UPDATED="updated",edb.ArrayAccess=function(t){this.instanceid=t._instanceid,this.array=t},edb.ArrayAccess.prototype={instanceid:null,array:null},edb.ArrayChange=function(t){this.instanceid=t._instanceid},edb.ArrayChange.prototype={instanceid:null,array:null},edb.ArrayChange.TYPE_ADDED="added",edb.ArrayChange.TYPE_REMOVED="removed",edb.Output={toString:function(){return"[object edb.Output]"},dispatch:function(t){var e=this._configure(t.constructor,t);gui.Broadcast.dispatch(null,edb.BROADCAST_OUTPUT,e)},out:function(t){var e=t.$classid,n=this._map[e];return n?!0:!1},onbroadcast:function(t){t.type===gui.BROADCAST_WILL_UNLOAD&&this._onunload()},_map:{},_configure:function(t,e){var n=t.$classid;return this._map[n]=e,new edb.Input(e)},_onunload:function(){gui.Object.each(this._map,function(t,e){e.$ondestruct()}),this._map=null},$get:function(t){var e=t.$classid,n=this._map[e];return n?new edb.Input(n):null}},edb.OutputPlugin=gui.Plugin.extend({dispatch:function(t,e){return console.error("edb.OutputPlugin is deprecated"),edb.Output.dispatch(this.context,t,e)},exists:function(t){return console.error("edb.OutputPlugin is deprecated"),edb.Output.out(t,this.context||self)}}),edb.Input=function(t){if(!edb.Type.isInstance(t))throw new TypeError(t+" is not a Type");this.type=t.constructor,this.data=t},edb.Input.prototype={type:null,data:null,toString:function(){return"[object edb.Input]"}},edb.InputPlugin=gui.Tracker.extend({done:!0,onconstruct:function(){this._super.onconstruct(),this._watches=[],this._matches=[]},ondestruct:function(){this._super.ondestruct(),this.remove(this._watches),this._xxx(!1)},add:gui.Combo.chained(function(t,e){this.done=!1,e=e?e:this.spirit,t=edb.InputPlugin._breakdown(t,this.context),this._add(t,e),this._xxx(!0)}),remove:gui.Combo.chained(function(t,e){e=e?e:this.spirit,t=edb.InputPlugin._breakdown(t,this.context),this._remove(t,e),(this.done=this._matches.length===this._watches.length)&&this._xxx(!1)}),get:function(t){var e=this._matches.map(function(t){return t.data.constructor}),n=edb.InputPlugin._bestmatch(t,e),i=n?this._matches.filter(function(t){return t.type===n}).shift():null;return i?i.data:null},dispatch:function(t,e){return this.spirit?this.spirit.script.input(t,e):(console.error("TODO: not implemented (private sandbox input)"),void 0)},onbroadcast:function(t){t.type===edb.BROADCAST_OUTPUT&&this.match(t.data)},match:function(t){this._maybeinput(t)},_watches:null,_matches:null,_add:function(t,e){t.forEach(function(t){if(!gui.Type.isDefined(t))throw new TypeError("Could not register input for undefined Type");this._watches.push(t),this._addchecks(t.$classid,[e]),t.out(this.context)&&this._maybeinput(edb.Output.$get(t,this.context))},this)},_remove:function(t,e){t.forEach(function(t){var n=this._watches.indexOf(t);n>-1&&(gui.Array.remove(this._watches,n),this._removechecks(t.$classid,[e]))},this)},_maybeinput:function(t){var e=edb.InputPlugin._bestmatch(t.type,this._watches);e&&(this._updatematch(t),this.done=this._matches.length===this._watches.length,this._updatehandlers(t))},_updatematch:function(t){var e=this._matches,n=e.map(function(t){return t.type}),i=edb.InputPlugin._bestmatch(t.type,n);if(i){var s=e.filter(function(t){return t.type===i})[0],r=e.indexOf(s);e[r]=t}else e.push(t)},_updatehandlers:function(t){gui.Class.ancestorsAndSelf(t.type,function(e){var n=this._trackedtypes[e.$classid];n&&n.forEach(function(e){var n=e[0];n.oninput(t)})},this)},_xxx:function(t){gui.Broadcast[t?"add":"remove"](edb.BROADCAST_OUTPUT,this,this.context.gui.$contextid)}},{},{_breakdown:function(t,e){return gui.Type.isArray(t)?this._breakarray(t,e):this._breakother(t,e)},_breakarray:function(t,e){return t.map(function(t){switch(gui.Type.of(t)){case"function":return t;case"string":return gui.Object.lookup(t,e);case"object":console.error("Expected function. Got object.")}},this)},_breakother:function(t,e){switch(gui.Type.of(t)){case"function":return[t];case"string":return this._breakarray(t.split(" "),e);case"object":console.error("Expected function. Got object.")}},_bestmatch:function(t,e){var n=null,i=Number.MAX_VALUE;return this._rateall(t,e,function(t,e){e>-1&&i>e&&(n=t)}),n},_rateall:function(t,e,n){e.forEach(function(e){n(e,this._rateone(t,e))},this)},_rateone:function(t,e){if(t===e)return 0;var n=gui.Class.ancestorsAndSelf(t),i=gui.Class.descendantsAndSelf(t),s=n.indexOf(e),r=i.indexOf(e);return 0>s?r:s}}),edb.ScriptPlugin=gui.Plugin.extend({loaded:!1,autorun:!0,ran:!1,diff:!0,debug:!1,extras:null,src:{getter:function(){return this._src},setter:function(t){this.load(t)}},onconstruct:function(){this._super.onconstruct();var t=this.spirit;this.inputs=this.inputs.bind(this),t.life.add(gui.LIFE_DESTRUCT,this),t instanceof edb.ScriptSpirit?this.autorun=!1:this.diff&&(this._updater=new edb.UpdateManager(t))},ondestruct:function(){this._super.ondestruct(),this._script&&this._script.dispose()},onatt:function(t){"src"===t.name&&(this.src=t.value)},ontick:function(t){t.type===gui.TICK_DOC_FIT&&this.spirit.action.dispatchGlobal(gui.ACTION_DOC_FIT)},onlife:function(t){t.type===gui.LIFE_ENTER&&(this.spirit.life.remove(t.type,this),this._dosrc&&(this.load(this._dosrc),this._dosrc=null))},load:function(t){var e=this.context,n=e.document,i=gui.URL.absolute(n,t),s=this._then=new gui.Then;return this.spirit.life.entered?i!==this._src&&(edb.Script.load(e,n,t,function(t){this._onreadystatechange(t)},this),this._src=i):(this.spirit.life.add(gui.LIFE_ENTER,this),this._dosrc=t),s},compile:function(t,e){var n=this.context,i=new gui.URL(this.context.document);edb.Script.compile(n,i,t,e,function(t){this._onreadystatechange(t)},this)},run:function(){this.loaded?(this._script.pointer=this.spirit,this.write(this._script.execute.apply(this._script,arguments))):this._dorun=arguments},write:function(t){var e=this._html!==t;if(e&&(this._html=t,this._stayfocused(function(){this.diff?this._updater.update(t):this.spirit.dom.html(t)}),this.ran=!0,this.spirit.life.dispatch(edb.LIFE_SCRIPT_DID_RUN,e),this.context.gui.hosted)){var n=gui.TICK_DOC_FIT,i=this.context.gui.$contextid;gui.Tick.one(n,this,i).dispatch(n,0,i)}},input:function(t,e){var n=edb.Input.format(this.context,t,e);return this._script?this._script.input.match(n):(this._doinput=this._doinput||[],this._doinput.push(n)),n.data},inputs:function(t){return this._script.input.get(t)},_src:null,_script:null,_then:null,_updater:null,_doinput:null,_dosrc:null,_dorun:null,_html:null,_onreadystatechange:function(t){switch(this._script=this._script||t,t.readyState){case edb.Function.WAITING:if(this._doinput&&this._doinput.length){for(;this._doinput.length;)this.input(this._doinput.shift());this._doinput=null}break;case edb.Function.READY:this.loaded||(this.loaded=!0,this.debug&&t.debug(),this._then&&(this._then.now(),this._then=null)),this._dorun?(this.run.apply(this,this._dorun),this._dorun=null):this.autorun&&this.run()}},_stayfocused:function(t){var e,n=edb.EDBModule.fieldselector;if(t.call(this),n&&(e=gui.DOMPlugin.q(this.spirit.document,n),e&&"#"+e.id!==n&&e&&gui.DOMPlugin.contains(this.spirit,e))){e.focus();var i="textarea,input:not([type=checkbox]):not([type=radio])";gui.CSSPlugin.matches(e,i)&&e.setSelectionRange(e.value.length,e.value.length),this._restorefocus(e),this._debugwarning()}},_restorefocus:function(t){var e="textarea,input:not([type=checkbox]):not([type=radio])";t.focus(),gui.CSSPlugin.matches(t,e)&&t.setSelectionRange(t.value.length,t.value.length)},_debugwarning:function(){var t=edb.ScriptPlugin;t._warning&&this.spirit.window.gui.debug&&(console.debug(t._warning),t._warning=null)}},{},{_warning:"Spiritual: Form elements with a unique @id may be updated without losing the undo-redo stack (now gone)."}),edb.ScriptSpirit=gui.Spirit.extend({debug:!1,onconfigure:function(){this._super.onconfigure();var t=this.dom.parent(gui.Spirit);t&&this._initparentplugin(t)},_initparentplugin:function(t){var e=this.att.get("src");if(e)t.script.load(e);else{var n=this.att.getmap();n.debug=n.debug||this.debug,t.script.compile(this.dom.text(),n)}}}),edb.ServiceSpirit=gui.Spirit.extend({onconstruct:function(){this._super.onconstruct();var t,e=this.att.get("type");if(e&&(t=gui.Object.lookup(e,this.window),!t))throw new TypeError('"'+e+'" is not a Type (in this context).');this.att.get("href")?new gui.Request(this.element.href).get().then(function(n,i){e=function(){if(t)return new t(i);switch(gui.Type.of(i)){case"object":return new edb.Object(i);case"array":return new edb.Array(i)}}(),e?e.$output(this.window):console.error("TODO: handle unhandled response type")},this):t&&(new t).$output(this.window)}}),edb.Instruction=function(t){this.atts=Object.create(null),this.type=t.split("<?")[1].split(" ")[0];for(var e,n=edb.Instruction._ATEXP;e=n.exec(t);){var i=e[1],s=e[2];this.atts[i]=gui.Type.cast(s)}},edb.Instruction.prototype={type:null,atts:null,toString:function(){return"[object edb.Instruction]"}},edb.Instruction.from=function(t){for(var e=[],n=null;n=this._PIEXP.exec(t);)e.push(new edb.Instruction(n[0]));return e},edb.Instruction.clean=function(t){return t.replace(this._PIEXP,"")},edb.Instruction._PIEXP=/<\?.[^>?]+\?>/g,edb.Instruction._ATEXP=/(\S+)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g,edb.Runner=function(){},edb.Runner.prototype={firstline:!1,lastline:!1,firstchar:!1,lastchar:!1,run:function(t,e,n,i){this._runlines(t,e.split("\n"),n,i)},ahead:function(t){var e=this._line,n=this._index,i=n+1,s=t.length;return e.length>n+s&&e.substring(i,i+s)===t},behind:function(t){var e=this._line,n=this._index,i=t.length,s=n-i;return s>=0&&e.substr(s,i)===t},lineahead:function(){return this._line.substring(this._index+1)},skipahead:function(){console.error("TODO")},_line:null,_index:-1,_runlines:function(t,e,n,i){var s=e.length-1;e.forEach(function(e,r){this.firstline=0===r,this.lastline=r===s,this._runline(e,r,t,n,i)},this)},_runline:function(t,e,n,i,s){t=this._line=t.trim(),t.length&&(n.newline(t,this,i,s),this._runchars(n,t.split(""),i,s),n.endline(t,this,i,s))},_runchars:function(t,e,n,i){var s=e.length-1;e.forEach(function(e,r){this._index=r,this.firstchar=0===r,this.lastchar=r===s,t.nextchar(e,this,n,i)},this)}},edb.Status=function(){this.conf=[]},edb.Status.MODE_JS="js",edb.Status.MODE_HTML="html",edb.Status.MODE_TAG="tag",edb.Status.prototype={mode:edb.Status.MODE_JS,peek:!1,poke:!1,cont:!1,adds:!1,func:null,conf:null,curl:null,skip:0,last:0,spot:0,indx:0,refs:!1,isjs:function(){return this.mode===edb.Status.MODE_JS},ishtml:function(){return this.mode===edb.Status.MODE_HTML},istag:function(){return this.mode===edb.Status.MODE_TAG},gojs:function(){this.mode=edb.Status.MODE_JS},gohtml:function(){this.mode=edb.Status.MODE_HTML},gotag:function(){this.mode=edb.Status.MODE_TAG}},edb.Result=function(t){this.body=t||""},edb.Result.prototype={body:null,temp:null,format:function(){return edb.Result.format(this.body)}},edb.Result.format=function(t){var e="",n="	",i=null,s=null,r=null,o=null;return t.split("\n").forEach(function(t){t=t.trim(),i=t.charAt(0),s=t.charAt(t.length-1),r=t.split("//")[0].trim(),o=r.charAt(r.length-1),"}"!==i&&"]"!==i||""===n||(n=n.slice(0,-1)),e+=n+t+"\n",("{"===s||"["===s||"{"===o||"["===o)&&(n+="	")}),e},edb.Storage=gui.Class.create(Object.prototype,{},{length:{getter:function(){throw new Error("Not supported.")}},getItem:function(t,e){{var n=new gui.Then;this[t]}return this.$getItem(t,e,function(e){this[t]=e,gui.Tick.next(function(){n.now(e||null)})}),n},setItem:function(t,e,n){var i=new gui.Then;return edb.Storage.$typecheck(e)&&this.$setItem(t,e,n,function(){this[t]=e,i.now(e)}),i},removeItem:function(t){var e=new gui.Then;return delete this[t],this.$removeItem(t,function(){e.now()}),e},clear:function(){var t=new gui.Then;return this.$clear(function(){Object.keys(this).filter(function(t){return void 0===this.prototype[t]},this).forEach(function(t){delete this[t]},this),t.now()}),t},$getItem:function(){},$setItem:function(){},$removeItem:function(){},$clear:function(){}},{$typecheck:function(t){if(edb.Type.isInstance(t)){if(t.constructor.$classname!==gui.Class.ANONYMOUS)return!0;throw new Error("Cannot persist ANONYMOUS Type")}throw new TypeError("Persist only models and collections")}}),edb.DOMStorage=edb.Storage.extend({},{_storagekey:null,_storagemap:null,_domstorage:function(){},_timeout:-1,$getItem:function(t,e,n){var i=null,s=null,r=null,o=this.$read(e);(i=o[t])&&(i=JSON.parse(i),r=gui.Object.lookup(t,e||self),s=r?new r(i):null),n.call(this,s)},$setItem:function(t,e,n,i){var s=this.$read(n);s[t]=e.$stringify(),this.$write(n,!0),i.call(this)},$removeItem:function(t,e,n){var i=this.$read(e);delete i[t],this.$write(e,!1),n.call(this)},$clear:function(t,e){this._domstorage(t).removeItem(this._storagekey),this._storagemap=null,e.call(this)},$read:function(e){if(e=t,!this._storagemap){var n=this._domstorage(e).getItem(this._storagekey);this._storagemap=n?JSON.parse(n):{}}return this._storagemap},$write:function(e,n){function i(){try{o.setItem(r,JSON.stringify(s))}catch(t){alert(t)}}clearTimeout(this._timeout);var s=this._storagemap,r=this._storagekey,o=this._domstorage(e);e=t,s&&i()}}),edb.SessionStorage=edb.DOMStorage.extend({},{_domstorage:function(t){return t.sessionStorage},_storagekey:"MyVendor.MyApp.SessionStorage"}),edb.LocalStorage=edb.DOMStorage.extend({},{_domstorage:function(t){return t.localStorage},_storagekey:"MyVendor.MyApp.LocalStorage"}),edb.State=edb.Object.extend({},{storage:null}),edb.SessionState=edb.State.extend({},{storage:edb.SessionStorage}),edb.LocalState=edb.State.extend({},{storage:edb.LocalStorage}),edb.Compiler=gui.Class.create(Object.prototype,{newline:function(t,e,n){n.last=t.length-1,n.adds="+"===t[0],n.cont=n.cont||n.ishtml()&&n.adds},endline:function(t,e,n,i){n.ishtml()?n.cont||(i.body+="';\n",n.gojs()):i.body+="\n",n.cont=!1},nextchar:function(t,e,n,i){switch(n.mode){case edb.Status.MODE_JS:this._compilejs(t,e,n,i);break;case edb.Status.MODE_HTML:this._compilehtml(t,e,n,i);break;case edb.Status.MODE_TAG:this._compiletag(t,e,n,i)}n.skip--<=0&&(n.poke||n.geek?i.temp+=t:n.istag()||(i.body+=t))},_compile:function(t){var e=new edb.Runner,n=new edb.Status,i=new edb.Result('"use strict";\n');return e.run(this,t,n,i),i.body+=(n.ishtml()?"';":"")+"\nreturn out.write ();",i.format()},_compilejs:function(t,e,n,i){switch(t){case"<":if(e.firstchar){n.gohtml(),n.spot=i.body.length-1,i.body+="out.html += '"}break;case"@":this._scriptatt(e,n,i)}},_compilehtml:function(t,e,n,i){var s=n.peek||n.poke||n.geek;switch(t){case"{":s&&n.curl++;break;case"}":0===--n.curl&&(n.peek&&(n.peek=!1,n.skip=1,n.curl=0,i.body+=") + '"),n.poke&&(this._poke(n,i),n.poke=!1,i.temp=null,n.spot=-1,n.skip=1,n.curl=0),n.geek&&(this._geek(n,i),n.geek=!1,i.temp=null,n.spot=-1,n.skip=1,n.curl=0));break;case"$":!s&&e.ahead("{")&&(e.behind('gui.test="')?(n.geek=!0,n.skip=2,n.curl=0,i.temp=""):(n.peek=!0,n.skip=2,n.curl=0,i.body+="' + ("));break;case"#":!s&&e.ahead("{")&&(n.poke=!0,n.skip=2,n.curl=0,i.temp="");break;case"+":e.firstchar?n.skip=n.adds?1:0:e.lastchar&&(n.cont=!0,n.skip=1);break;case"'":s||(i.body+="\\");break;case"@":this._htmlatt(e,n,i)}},_compiletag:function(t,e,n,i){switch(e){case"$":this._ahead(i,n,"{")&&(t.refs=!0,t.skip=2);break;case">":t.gojs(),t.skip=1}},_scriptatt:function(t,e,n){var i,s,r=edb.Compiler._ATTREXP;if(t.behind("@"));else if(t.ahead("@"))n.body+="var att = new edb.Att ();",e.skip=2;else{if(i=t.lineahead(),s=r.exec(i)[0],!s)throw"Bad @name: "+i;n.body+=i.replace(s,"att['"+s+"']"),e.skip=i.length}},_htmlatt:function(t,e,n){var i,s,r,o,u=edb.Compiler._ATTREXP;t.behind("@")||(t.behind("#{")?console.error("todo"):t.ahead("@")?(n.body+="' + att._all () + '",e.skip=2):(i=t.lineahead(),s=u.exec(i)[0],r=t.behind("-"),o=r?"att._pop":"att._out",n.body=r?n.body.substring(0,n.body.length-1):n.body,n.body+="' + "+o+" ( '"+s+"' ) + '",e.skip=s.length+1))},_poke:function(t,e){this._inject(t,e,edb.Compiler._POKE)},_geek:function(t,e){this._inject(t,e,edb.Compiler._GEEK)},_inject:function(t,e,n){var i=e.body,s=e.temp,r=t.spot,o=i.substring(0,r),u=i.substring(r),c=gui.KeyMaster.generateKey();e.body=o+"\n"+n.outline.replace("$name",c).replace("$temp",s)+u+n.inline.replace("$name",c)}},{},{_POKE:{outline:"var $name = edb.set ( function ( value, checked ) {\n$temp;\n}, this );",inline:"edb.go(event,&quot;' + $name + '&quot;);"},_GEEK:{outline:"var $name = edb.set ( function () {\nreturn $temp;\n}, this );",inline:"edb.get(&quot;' + $name + '&quot;);"},_ATTREXP:/^[^\d][a-zA-Z0-9-_\.]+/}),edb.FunctionCompiler=edb.Compiler.extend({source:null,dependencies:null,directives:null,sequence:null,onconstruct:function(t,e){this.directives=e||Object.create(null),this.source=t,this.sequence=["_validate","_extract","_direct","_declare","_define","_compile"]},compile:function(t,e){var n=null;this.dependencies=[],this._params=[],this._context=t,this._url=e,this._vars=[];var i={declarations:Object.create(null),functiondefs:[]};this.sequence.forEach(function(t){this.source=this[t](this.source,i)},this);try{n=this._convert(this.source,this._params),this.source=this._source(this.source,this._params)}catch(s){n=this._fail(s)}return n},sign:function(t){return this._$contextid=t,this},_context:null,_$contextid:null,_instructions:null,_params:null,_failed:!1,_validate:function(t){if(edb.FunctionCompiler._NESTEXP.test(t))throw"Nested EDBML dysfunction";return t},_direct:function(t){return t},_extract:function(t){return edb.Instruction.from(t).forEach(function(t){this._instruct(t)},this),edb.Instruction.clean(t)},_instruct:function(t){var e=t.type,n=t.atts,i=n.src,s=n.name,r=this._context;switch(e){case"param":this._params.push(s);break;case"function":case"tag":if(e===edb.Import.TYPE_TAG){if(!i.contains("#"))throw new Error("Missing tag #identifier: "+i);s=i.split("#")[1]}var o=this._basedocument();this.dependencies.push(new edb.Import(r,o,e,i,s))}},_declare:function(t,e){var n=[];return this.dependencies.forEach(function(t){e.declarations[t.name]=!0,n.push(t.name+" = get ( self, '"+t.tempname()+"' );\n")},this),n[0]&&e.functiondefs.push("( function functions ( get ) {\n"+n.join("")+"}( edb.Function.get ));"),t},_define:function(t,e){var n="",i="var ";return Object.keys(e.declarations).forEach(function(t){n+=", "+t}),this._params.indexOf("out")<0&&(i+="Out = edb.Out, out = new Out (), "),this._params.indexOf("att")<0&&(i+="Att = edb.Att, att = new Att (), "),i+="Tag = edb.Tag "+n+";\n",e.functiondefs.forEach(function(t){i+=t+"\n"}),i+t},_convert:function(t,e){var n="",i=this._context;return gui.Type.isArray(e)&&(n=e.join(",")),new i.Function(n,t)},_fail:function(t){var e=this._context;if(this._failed)throw t;return this._failed=!0,this._debug(edb.Result.format(this.source)),this.source='<p class="error">'+t.message+"</p>",this.compile(e,!0)},_debug:function(e){var n=this._context;if(t.btoa){e=n.btoa("function debug () {\n"+e+"\n}");var i=n.document.createElement("script");i.src="data:text/javascript;base64,"+e,n.document.querySelector("head").appendChild(i),i.onload=function(){this.parentNode.removeChild(this)}}},_source:function(t,e){var n=t.split("\n");n.pop();var i=e.length?"( "+e.join(", ")+" )":"()";return"function "+i+" {\n"+n.join("\n")+"\n}"},_basedocument:function(){return this._document||(this._document=function(t){var e=document.implementation.createHTMLDocument("temp"),n=e.createElement("base");return n.href=t,e.querySelector("head").appendChild(n),e}(this._url.href))}},{},{_NESTEXP:/<script.*type=["']?text\/edbml["']?.*>([\s\S]+?)/g}),edb.ScriptCompiler=edb.FunctionCompiler.extend({inputs:null,_instruct:function(t){this._super._instruct(t);var e=t.atts;switch(t.type){case"input":this.inputs[e.name]=e.type}},compile:function(t,e){return this.inputs=Object.create(null),this._super.compile(t,e)},_declare:function(t,e){return this._super._declare(t,e),this._declareinputs(t,e)},_declareinputs:function(t,e){var n=[];return gui.Object.each(this.inputs,function(t,i){e.declarations[t]=!0,n.push(t+" = get ( "+i+" );\n")},this),n[0]&&e.functiondefs.push("( function inputs ( get ) {\n"+n.join("")+"})( this.script.inputs );"),t}}),edb.TagCompiler=edb.FunctionCompiler.extend({_direct:function(t){if(this.directives.tag){var e=edb.TagCompiler._CONTENT;this._params.push("content"),this._params.push("attribs"),this._params.push("COMPILED_AS_TAG"),t="att = new Att ( attribs );\n"+t,t=t.replace(e,"content ( out );")}return this._super._direct(t)}},{},{_CONTENT:/<content(.*)>(.*)<\/content>|<content(.*)(\/?)>/}),edb.Loader=gui.FileLoader.extend({directives:null,load:function(t,e,n){var i=new gui.URL(this._document,t);this._cache.has(i.location)?this._cached(i,e,n):i.external?this._request(i,e,n):i.hash?this._lookup(i,e,n):console.error("Now what?")},onload:function(t,e,n,i){e.external&&(t=this._extract(t,e)),n.call(i,t,this.directives,e),this.directives=null},_lookup:function(t,e,n){var i=this._document.querySelector(t.hash);i?(this.directives=gui.AttPlugin.getmap(i),this.onload(i.textContent,t,e,n)):console.error("No such script: "+t)},_extract:function(t,e){var n=gui.HTMLParser.parseToDocument(t),i=n.querySelector(e.hash||"script");return i?(this.directives=gui.AttPlugin.getmap(i),i.textContent):(console.error("No such script: "+e.location+e.hash||""),void 0)}}),edb.Function=gui.Class.create(Object.prototype,{executable:null,context:null,url:null,readyState:null,onreadystatechange:null,onconstruct:function(t,e,n){this.context=t||null,this.url=e||null,this.onreadystatechange=n||null,this._imports=Object.create(null)},compile:function(t,e){if(null===this.executable){var n=this._compiler(),i=new n(t,e);return this._$contextid&&i.sign(this._$contextid),this.executable=i.compile(this.context,this.url),this._source=i.source,this._dependencies(i),this._oncompiled(i,e),this
}throw new Error("TODO: recompile the script :)")},debug:function(){console.debug(this._source)},_dependencies:function(t){t.dependencies.map(function(t){return this._imports[t.name]=null,t},this).forEach(function(t){t.resolve().then(function(e){this._imports[t.name]=e,this._maybeready()},this)},this)},sign:function(t){return this._$contextid=t,this},execute:function(){var t=null;if(!this.executable)throw new Error(this+" not compiled");try{this._subscribe(!0),t=this.executable.apply(this.pointer,arguments),this._subscribe(!1)}catch(e){console.error(e.message+":\n\n"+this._source)}return t},_$contextid:null,_imports:null,_compiler:function(){return edb.FunctionCompiler},_oncompiled:function(t,e){e.debug&&this.debug();try{this._useblob()?this._loadblob(t):this._maybeready()}catch(n){this._maybeready()}},_useblob:function(){return this.context.gui.debug&&gui.Client.isWebKit},_loadblob:function(t){var e=this.context,n=e.document,i=gui.KeyMaster.generateKey(),s=t.source.replace("function","function "+i);this._gostate(edb.Function.LOADING),gui.BlobLoader.loadScript(n,s,function(){this._gostate(edb.Function.WORKING),this.executable=e[i],this._maybeready()},this)},_gostate:function(t){t!==this.readyState&&(this.readyState=t,gui.Type.isFunction(this.onreadystatechange)&&this.onreadystatechange())},_maybeready:function(){this.readyState!==edb.Function.LOADING&&(this._gostate(edb.Function.WORKING),this._done()?this._gostate(edb.Function.READY):this._gostate(edb.Function.WAITING))},_done:function(){return Object.keys(this._imports).every(function(t){return null!==this._imports[t]},this)}},{get:function(t,e){var n=this._executables,i=t.gui.$contextid;if(gui.URL.absolute(e))return n[i]?n[i][e]||null:null;throw new Error("Absolute URL expected")},load:function(t,e,n,i,s){var r=this._executablecontext(t);new edb.Loader(e).load(n,function(e,n,o){this.compile(t,o,e,n,function(t){r[o.href]||t.readyState!==edb.Function.READY||(r[o.href]=t.executable),i.call(s,t)})},this)},compile:function(t,e,n,i,s,r){var o=this;new o(t,e,function(){s.call(r,this)}).compile(n,i)},_executables:Object.create(null),_executablecontext:function(t){var e=this._executables,n=t.gui.$contextid;return e[n]||(e[n]=Object.create(null))}},{LOADING:"loading",WAITING:"waiting",WORKING:"working",READY:"ready"}),function(){edb.Function.get=edb.Function.get.bind(edb.Function)}(),edb.Script=edb.Function.extend({input:null,pointer:null,onconstruct:function(t,e,n){this._super.onconstruct(t,e,n),this.input=new edb.InputPlugin,this.input.context=this.context,this.input.onconstruct(),this._keys=new Set,gui.Broadcast.add(edb.BROADCAST_CHANGE,this)},onbroadcast:function(t){switch(t.type){case edb.BROADCAST_ACCESS:this._keys.add(t.data);break;case edb.BROADCAST_CHANGE:if(this._keys.has(t.data)&&this.readyState!==edb.Function.WAITING){var e=edb.TICK_SCRIPT_UPDATE,n=this.context.gui.$contextid;gui.Tick.one(e,this,n).dispatch(e,0,n),this._gostate(edb.Function.WAITING)}}},ontick:function(t){switch(t.type){case edb.TICK_SCRIPT_UPDATE:this._gostate(edb.Function.READY)}},oninput:function(){this._maybeready()},execute:function(){this._keys=new Set;var t=null;if(!this.input.done)throw new Error("Script awaits input");return this._subscribe(!0),t=this._super.execute.apply(this,arguments),this._subscribe(!1),t},dispose:function(){this.onreadystatechange=null,this.input.ondestruct()},_Compiler:edb.ScriptCompiler,_keys:null,_inputresolved:!1,_compiler:function(){return edb.ScriptCompiler},_oncompiled:function(t,e){gui.Object.each(t.inputs,function(t,e){this.input.add(e,this)},this),this._inputresolved=!0,this._super._oncompiled(t,e)},_done:function(){return this._inputresolved&&this.input.done&&this._super._done()},_subscribe:function(t){gui.Broadcast[t?"add":"remove"](edb.BROADCAST_ACCESS,this),gui.Broadcast[t?"remove":"add"](edb.BROADCAST_CHANGE,this)}},{_invokables:Object.create(null),_log:null,$assign:function(t,e){var n=gui.KeyMaster.generateKey();return edb.Script._invokables[n]=function(n,i){return t.apply(e,[gui.Type.cast(n),i])},n},$revoke:function(t){edb.Script._invokables[t]=null,delete edb.Script._invokables[t]},$invoke:function(t,e,n){var i=null;if(n=n||this._log,e)gui.Broadcast.dispatchGlobal(this,edb.BROADCAST_SCRIPT_INVOKE,{key:t,sig:e,log:n});else{if(!(i=this._invokables[t]))throw new Error("Invokable does not exist: "+t);n?"click"===n.type?gui.Tick.next(function(){i(n.value,n.checked)}):i(n.value,n.checked):i()}},$register:function(t){return this._log=t?{type:t.type,value:t.target.value,checked:t.target.checked}:null,this},$tempname:function(t,e){var n;if(!e){if(n=this._invokables[t])return n();throw new Error("out of synch")}console.error("TODO")}}),edb.Tag=edb.Function.extend({_compiler:function(){return edb.TagCompiler},compile:function(t,e){return e.tag=!0,this._super.compile(t,e)}}),edb.Import=function(t,e,n,i,s){this._context=t,this._document=e,this.type=n,this.name=s,this.href=i},edb.Import.prototype={type:null,name:null,href:null,toString:function(){return"[object edb.Import]"},resolve:function(){var t=this._functionpool(),e=t.get(this._context,this.tempname()),n=new gui.Then;return e?n.now(e):t.load(this._context,this._document,this.href,function(t){t.readyState===edb.Function.READY&&n.now(t)}),n},tempname:function(){return new gui.URL(this._document,this.href).href},_functionpool:function(){switch(this.type){case edb.Import.TYPE_FUNCTION:return edb.Function;case edb.Import.TYPE_TAG:return edb.Tag}},_context:null},edb.Import.TYPE_FUNCTION="function",edb.Import.TYPE_TAG="tag",edb.Att=function(t){t&&gui.Object.extend(this,t)},edb.Att.prototype=gui.Object.create(null,{toString:function(){return"[object edb.Att]"},_out:function(t){var e=this[t],n="";switch(gui.Type.of(e)){case"null":case"undefined":break;default:e=edb.Att.encode(this[t]),n+=t+'="'+e+'" '}return n},_pop:function(t){var e=this._out(t);return delete this[t],e},_all:function(){var t="";return gui.Object.nonmethods(this).forEach(function(e){t+=this._out(e)},this),t}}),edb.Att.encode=function(t){var e=gui.Type.of(t);switch(e){case"string":break;case"number":case"boolean":t=String(t);break;case"object":case"array":try{t=encodeURIComponent(JSON.stringify(t))}catch(n){throw new Error("Could not create HTML attribute: "+n)}break;case"date":throw new Error("TODO: edb.Att.encode standard date format?");default:throw new Error("Could not create HTML attribute for "+e)}return t},edb.Out=function(){},edb.Out.prototype={html:"",toString:function(){return"[object edb.Out]"},write:function(){return this.html}},edb.UpdateAssistant={id:function(t){return gui.Type.isDefined(t.id)?t.id||null:t.getAttribute("id")||null},parse:function(t,e,n,i){return i=t.createElement(i.localName),i.innerHTML=e,i.id=n,Array.forEach(i.querySelectorAll("option"),function(t){switch(t.getAttribute("selected")){case"true":t.setAttribute("selected","selected");break;case"false":t.removeAttribute("selected")}}),Array.forEach(i.querySelectorAll("input[type=checkbox],input[type=radio]"),function(t){switch(t.getAttribute("checked")){case"true":t.setAttribute("checked","checked");break;case"false":t.removeAttribute("checked")}}),i},order:function(t){var e=new Map;return Array.forEach(t,function(t,n){t.nodeType===Node.ELEMENT_NODE&&e.set(this.id(t),n)},this),e},index:function(t){var e=Object.create(null);return Array.forEach(t,function(t){t.nodeType===Node.ELEMENT_NODE&&(e[this.id(t)]=t)},this),e}},edb.UpdateManager=function(t){this._keyid=t.dom.id()||t.$instanceid,this._spirit=t,this._doc=t.document},edb.UpdateManager.prototype={toString:function(){return"[object edb.UpdateManager]"},update:function(t){this._updates=new edb.UpdateCollector,this._functions={},this._olddom?(this._next(t),this._updates.collect(new edb.FunctionUpdate(this._doc).setup(this._keyid,this._functions))):this._first(t),this._updates.eachRelevant(function(t){t.update(),t.dispose()}),this._updates&&this._updates.dispose(),delete this._updates},_keyid:null,_doc:null,_spirit:null,_olddom:null,_nedwdom:null,_updates:null,_assistant:edb.UpdateAssistant,_first:function(t){this._olddom=this._parse(t),this._updates.collect(new edb.HardUpdate(this._doc).setup(this._keyid,this._olddom))},_next:function(t){this._newdom=this._parse(t),this._crawl(this._newdom,this._olddom,this._newdom,this._keyid,{}),this._olddom=this._newdom},_parse:function(t){return this._assistant.parse(this._doc,t,this._keyid,this._spirit.element)},_crawl:function(t,e,n,i,s){for(var r=!0;t&&e&&!this._updates.hardupdates(i);){switch(t.nodeType){case Node.TEXT_NODE:r=this._check(t,e,n,i,s);break;case Node.ELEMENT_NODE:r=this._scan(t,e,n,i,s)}t=t.nextSibling,e=e.nextSibling}return r},_scan:function(t,e,n,i,s){var r=!0,o=this._assistant.id(e);return(r=this._check(t,e,n,i,s))&&(o&&(s=gui.Object.copy(s),n=t,s[o]=!0,i=o),r=this._crawl(t.firstChild,e.firstChild,n,i,s)),r},_check:function(t,e,n,i,s){var r=!0,o=!1,u=!1;if(t&&!e||!t&&e)r=!1;else if(r=t.nodeType===e.nodeType)switch(e.nodeType){case Node.TEXT_NODE:t.data!==e.data&&(r=!1);break;case Node.ELEMENT_NODE:(r=this._familiar(t,e))&&(r=this._checkatts(t,e,s))&&(this._maybesoft(t,e)?(this._confirmsoft(t,e)&&(this._updatesoft(t,e,s),o=!0),r=!1):"textarea"!==e.localName&&(r=t.childNodes.length===e.childNodes.length,!r&&e.id&&(n=t,i=e.id)))}return r||o||u||(this._updates.collect(new edb.FunctionUpdate(this._doc).setup(i)),this._updates.collect(new edb.HardUpdate(this._doc).setup(i,n))),r},_familiar:function(t,e){return["namespaceURI","localName"].every(function(n){return t[n]===e[n]})},_checkatts:function(t,e,n){var i=!0,s=null;if(this._attschanged(t.attributes,e.attributes,n)){var r=this._assistant.id(t),o=this._assistant.id(e);r&&r===o?(s=new edb.AttsUpdate(this._doc).setup(o,t,e),this._updates.collect(s,n)):i=!1}return i},_attschanged:function(t,e){var n=t.length!==e.length;return n||(n=!Array.every(t,function(t){var n=e.getNamedItem(t.name);return n&&n.value===t.value}),n&&(n=!Array.every(t,function(t){var n=e.getNamedItem(t.name);return this._functionchanged(t.value,n.value)?!0:t.value===n.value},this))),n},_functionchanged:function(t,e){var n=gui.KeyMaster.extractKey(t),i=gui.KeyMaster.extractKey(e);return n&&i?(i.forEach(function(t,e){this._functions[t]=n[e]},this),!0):!1},_maybesoft:function(t,e){return t&&e?t.id&&t.id===e.id&&this._maybesoft(t)&&this._maybesoft(e):Array.every(t.childNodes,function(t){var e=!0;switch(t.nodeType){case Node.TEXT_NODE:e=""===t.data.trim();break;case Node.ELEMENT_NODE:e=null!==this._assistant.id(t)}return e},this)},_confirmsoft:function(t,e){var n=!0,i=null,s=this._assistant.order(e.childNodes);return Array.every(t.childNodes,function(t){if(t.nodeType===Node.ELEMENT_NODE){var e=this._assistant.id(t);s.has(e)&&s.has(i)&&(n=s.get(e)>s.get(i)),i=e}return n},this)},_updatesoft:function(t,e,n){for(var i=[],s=this._assistant.index(t.childNodes),r=this._assistant.index(e.childNodes),o=t.lastElementChild,u=this._assistant.id(e),c=null,a=null;o;)a=this._assistant.id(o),r[a]?c=a:c?i.push(new edb.InsertUpdate(this._doc).setup(c,o)):i.push(new edb.AppendUpdate(this._doc).setup(u,o)),o=o.previousElementSibling;Object.keys(r).forEach(function(t){if(s[t]){var e=s[t],o=r[t];this._scan(e,o,e,t,n)}else i.push(new edb.RemoveUpdate(this._doc).setup(t)),i.push(new edb.FunctionUpdate(this._doc).setup(t))},this),i.reverse().forEach(function(t){this._updates.collect(t,n)},this)}},edb.UpdateCollector=function(){this._updates=[],this._hardupdates=new Set},edb.UpdateCollector.prototype={_updates:null,_hardupdates:null,toString:function(){return"[object edb.UpdateCollector]"},collect:function(t,e){return this._updates.push(t),t.type===edb.Update.TYPE_HARD?this._hardupdates.add(t.id):t.ids=e||{},this},hardupdates:function(t){return this._hardupdates.has(t)},eachRelevant:function(t){this._updates.filter(function(t){return t.type===edb.Update.TYPE_HARD||Object.keys(t.ids).every(function(t){return!this.hardupdates(t)},this)},this).forEach(function(e){t(e)})},dispose:function(){delete this._hardupdates,delete this._updates}},edb.Update=gui.Class.create(Object.prototype,{type:null,id:null,ids:null,window:null,document:null,onconstruct:function(t){this.window=t.defaultView,this.document=t},setup:function(){return this},update:function(){},element:function(){var t,e=null;return gui.KeyMaster.isKey(this.id)&&(t=this.window.gui.get(this.id))&&(e=t.element),e=e||this.document.getElementById(this.id),e||console.error("No element to match @id: "+this.id),e},dispose:function(){this.window=null,this.document=null},_beforeUpdate:function(t){var e="x-beforeupdate-"+this.type;return this._dispatch(t,e)},_afterUpdate:function(t){var e="x-afterupdate-"+this.type;return this._dispatch(t,e)},_dispatch:function(t,e){var n=this.document.createEvent("UIEvents");return n.initEvent(e,!0,!0),t.dispatchEvent(n)},_report:function(t){this.window.gui.debug&&(gui.KeyMaster.isKey(this.id)&&(t=t.replace(this.id,"(anonymous)")),console.debug(t))}},{},{TYPE_HARD:"hard",TYPE_ATTS:"atts",TYPE_INSERT:"insert",TYPE_APPEND:"append",TYPE_REMOVE:"remove",TYPE_FUNCTION:"function"}),edb.AttsUpdate=edb.Update.extend({type:edb.Update.TYPE_ATTS,_xold:null,_xnew:null,_summary:null,onconstruct:function(t){this._super.onconstruct(t),this._summary=[]},setup:function(t,e,n){return this._super.setup(),this.id=t,this._xnew=e,this._xold=n,this},update:function(){this._super.update();var t=this.element();this._beforeUpdate(t)&&(this._update(t),this._afterUpdate(t),this._report())},dispose:function(){this._super.dispose(),delete this._xold,delete this._xnew},_update:function(t){Array.forEach(this._xnew.attributes,function(e){var n=this._xold.getAttribute(e.name);(null===n||n!==e.value)&&(this._set(t,e.name,e.value),this._summary.push("@"+e.name))},this),Array.forEach(this._xold.attributes,function(e){this._xnew.hasAttribute(e.name)||(this._del(t,e.name,null),this._summary.push("@"+e.value))},this)},_set:function(t,e,n){var i=t.spirit;if(i)i.att.set(e,n);else switch(t.setAttribute(e,n),e){case"checked":t.checked||(t.checked=!0);break;case"value":t.value!==n&&(t.value=String(n))}},_del:function(t,e){var n=t.spirit;if(n)n.att.del(e);else switch(e){case"checked":t.checked=!1;break;default:t.removeAttribute(e)}},_report:function(){this._super._report('edb.AttsUpdate "#'+this.id+'" '+this._summary.join(", "))}}),edb.HardUpdate=edb.Update.extend({type:edb.Update.TYPE_HARD,xelement:null,setup:function(t,e){return this._super.setup(),this.id=t,this.xelement=e,this},update:function(){this._super.update();var t=this.element();t&&this._beforeUpdate(t)&&(gui.DOMPlugin.html(t,this.xelement.innerHTML),this._afterUpdate(t),this._report())},dispose:function(){this._super.dispose(),delete this.xelement},_report:function(){this._super._report("edb.HardUpdate #"+this.id)}}),edb.SoftUpdate=edb.Update.extend({xelement:null,type:null,dispose:function(){this._super.dispose(),delete this.xelement},_import:function(t){var e=this.document.createElement(t.nodeName);return e.innerHTML=this.xelement.outerHTML,e.firstChild}}),edb.InsertUpdate=edb.SoftUpdate.extend({type:edb.Update.TYPE_INSERT,xelement:null,setup:function(t,e){return this.id=t,this.xelement=e,this},update:function(){var t=this.element(),e=t.parentNode,n=this._import(e);this._beforeUpdate(e)&&(e.insertBefore(n,t),this._afterUpdate(n),this._report())},_report:function(){this._super._report("edb.InsertUpdate #"+this.xelement.getAttribute("id"))}}),edb.AppendUpdate=edb.SoftUpdate.extend({type:edb.Update.TYPE_APPEND,setup:function(t,e){return this.id=t,this.xelement=e,this},update:function(){var t=this.element(),e=this._import(t);this._beforeUpdate(t)&&(t.appendChild(e),this._afterUpdate(e),this._report())},_report:function(){this._super._report("edb.AppendUpdate #"+this.xelement.getAttribute("id"))}}),edb.RemoveUpdate=edb.SoftUpdate.extend({type:edb.Update.TYPE_REMOVE,setup:function(t){return this.id=t,this},update:function(){var t=this.element(),e=t.parentNode;this._beforeUpdate(t)&&(e.removeChild(t),this._afterUpdate(e),this._report())},_report:function(){this._super._report("edb.RemoveUpdate #"+this.id)}}),edb.FunctionUpdate=edb.Update.extend({type:edb.Update.TYPE_FUNCTION,setup:function(t,e){return this.id=t,this._map=e||null,this},update:function(){var t=0,e=this.element();this._map?(t=edb.FunctionUpdate._remap(e,this._map))&&this._report("remapped "+t+" keys"):(t=edb.FunctionUpdate._revoke(e))&&this._report("revoked "+t+" keys")},_report:function(t){this._super._report("edb.FunctionUpdate "+t)}},{_revoke:function(t){var e,n=0;return this._getatts(t).forEach(function(t){e=gui.KeyMaster.extractKey(t.value),e&&e.forEach(function(t){edb.Script.$revoke(t),n++})}),n},_remap:function(t,e){var n,i,s=0;return Object.keys(e).length&&this._getatts(t).forEach(function(t){(n=gui.KeyMaster.extractKey(t.value))&&n.forEach(function(n){(i=e[n])&&(t.value=t.value.replace(n,i),edb.Script.$revoke(n),s++)})}),s},_getatts:function(t){var e=[];return(new gui.Crawler).descend(t,{handleElement:function(t){Array.forEach(t.attributes,function(t){t.value.contains("edb.go")&&e.push(t)})}}),e}}),edb.EDBModule=gui.module("edb",{fieldselector:null,mixins:{oninput:function(t){t.data instanceof edb.State&&this._statesstarted(t.type,t.data)&&gui.Spirit.$oninit(this)},_state:null,_sessionstate:null,_localstate:null,_startstates:function(){var t;return Object.keys(gui.Spirit.$states).some(function(e){return(t=this.constructor[e])?(this._startstate(t),!0):!1},this)},_startstate:function(t){this.input.add(t),t.out(this.window)||t.restore(this.window).then(function(e){e=e||new t,e.$output(this.window)},this)},_statesstarted:function(t,e){var n,i,s=gui.Spirit.$states;return Object.keys(s).every(function(r){return n=this.constructor[r],i=s[r],this[i]=t===n?e:null,!n||null!==this[i]},this)},onchange:function(){}},plugins:{script:edb.ScriptPlugin,input:edb.InputPlugin,output:edb.OutputPlugin},channels:[["script[type='text/edbml']","edb.ScriptSpirit"],["link[rel='service']","edb.ServiceSpirit"]],oncontextinitialize:function(t){var e,n,i;if(!t.event)try{t.event=null}catch(s){}t.gui.portalled||(e=t.gui.AttConfigPlugin)&&(n=e.prototype,i=n.$evaluate,n.$evaluate=function(e,n,s){if(gui.Type.isString(n)&&n.startsWith("edb.get")){var r=gui.KeyMaster.extractKey(n)[0];n=r?t.edb.get(r):r}return i.call(this,e,n,s)})},onafterspiritualize:function(t){var e=t.document;gui.Client.isGecko?(e.addEventListener("focus",this,!0),e.addEventListener("blur",this,!0)):(e.addEventListener("focusin",this,!0),e.addEventListener("focusout",this,!0))},handleEvent:function(t){switch(t.type){case"focusin":case"focus":this.fieldselector=this._fieldselector(t.target);break;case"focusout":case"blur":this.fieldselector=null}},_fieldselector:function(t){function e(t){if(t.id)try{return gui.DOMPlugin.q(t.parentNode,t.id),!0}catch(e){}return!1}for(var n=-1,i=[];t&&t.nodeType===Node.ELEMENT_NODE;)e(t)?(i.push("#"+t.id),t=null):"body"===t.localName?(i.push("body"),t=null):(n=gui.DOMPlugin.ordinal(t)+1,i.push(">"+t.localName+":nth-child("+n+")"),t=t.parentNode);return i.reverse().join("")}})}(this);