/*
 * Spiritual EDB 0.0.2
 * (c) 2013 Wunderbyte
 * Spiritual is freely distributable under the MIT license.
 */
window.edb=gui.namespace("edb",{portals:!0,useblobs:!0,BROADCAST_ACCESS:"edb-broadcast-access",BROADCAST_CHANGE:"edb-broadcast-change",BROADCAST_OUTPUT:"edb-broadcast-output",BROADCAST_SCRIPT_INVOKE:"edb-broadcast-script-invoke",LIFE_SCRIPT_WILL_RUN:"edb-life-script-will-run",LIFE_SCRIPT_DID_RUN:"edb-life-script-did-run",TICK_SCRIPT_UPDATE:"edb-tick-script-update",TICK_COLLECT_INPUT:"edb-tick-collect-input",TICK_PUBLISH_CHANGES:"edb-tick-update-changes",set:function(action,thisp){return edb.Script.$assign(action,thisp)},go:function(e,key,sig){edb.Script.$register(e),edb.Script.$invoke(key,sig,this._log)}}),edb.Type=function(){},edb.Type.prototype={$id:null,$context:null,$contextid:null,_instanceid:null,onconstruct:function(){},$onconstruct:function(){edb.Type.underscoreinstanceid(this),edb.Type.$confirmpersist(this)},$ondestruct:function(){edb.Type.$maybepersist(this)},$output:function(context){return edb.Output.dispatch(this,context||self),this},$stringify:function(filter,tabber){return JSON.stringify(this.$normalize(),filter,tabber)},$GET:function(){throw Error("Not supported. Use "+this.constructor+".$GET(optionalid)")},$PUT:function(options){return this.constructor.PUT(this,options)},$POST:function(options){return this.constructor.POST(this,options)},$DELETE:function(options){return this.constructor.DELETE(this,options)}},gui.Object.each({getter:gui.Combo.before(function(){gui.Broadcast.dispatchGlobal(this,edb.BROADCAST_ACCESS,this._instanceid)}),setter:gui.Combo.after(function(){gui.Broadcast.dispatchGlobal(this,edb.BROADCAST_CHANGE,this._instanceid)}),decorateGetters:function(proto,methods){return methods.forEach(function(method){proto[method]=edb.Type.getter(proto[method])}),proto},decorateSetters:function(proto,methods){return methods.forEach(function(method){proto[method]=edb.Type.setter(proto[method])}),proto},underscoreinstanceid:function(inst){Object.defineProperty(inst,"_instanceid",{value:inst.$instanceid})},isInstance:function(o){return gui.Type.isComplex(o)?o instanceof edb.Object||o instanceof edb.Array:!1},lookup:function(context,arg){var type=null;switch(gui.Type.of(arg)){case"function":type=arg;break;case"string":type=gui.Object.lookup(arg,context);break;case"object":console.error(this+": expected edb.Type constructor (not an object)")}if(!type)throw new TypeError('The type "'+arg+'" does not exist');return type},cast:function(value){if(gui.Type.isComplex(value)&&!edb.Type.isInstance(value))switch(gui.Type.of(value)){case"object":return new edb.Object(value);case"array":return new edb.Array(value)}return value},$confirmpersist:function(type){var Type=type.constructor;if(Type.storage&&edb.Storage.$typecheck(type)&&arguments.length>1)throw Error("Persisted models and collections must construct with a single arg")},$maybepersist:function(type){var Type=type.constructor;Type.storage&&Type.$store(type)}},function(key,value){edb.Type[key]=value}),function(){var iomixins={out:function(context){return edb.Output.out(this,context||self)}},persistancemixins={storage:null,restore:function(){return this.storage.getItem(this.$classname)},$store:function(type){this.storage.setItem(this.$classname,type)}},httpmixins={uri:null,primarykey:"_id",GET:function(){return this.$httpread.apply(this,arguments)},PUT:function(inst,options){return this.$httpupdate("PUT",inst,options)},POST:function(inst,options){return this.$httpupdate("POST",inst,options)},DELETE:function(inst,options){return this.$httpupdate("DELETE",inst,options)},$httpread:function(){var href,id,options,type=this,then=new gui.Then;return Array.forEach(arguments,function(arg){switch(gui.Type.of(arg)){case"string":id=arg;break;case"object":options=arg}}),href=gui.URL.parametrize(this.uri,options),this.$httprequest(href,"GET",null,function(response){then.now(type.$httpresponse(response))}),then},$httpupdate:function(method,inst,options){var type=this,then=new gui.Then,href=gui.URL.parametrize(inst.uri,options),data=gui.Type.isInstance(inst)?inst.$normalize():inst;return this.$httprequest(href,method||"PUT",data,function(response){then.now(type.$httpresponse(response,options,method))}),then},$httprequest:function(url,method,payload,callback){var request=new gui.Request(url);method=method.toLowerCase(),request[method](payload).then(function(status,data){callback(data)})},$httpresponse:function(response){var Type=this;switch(gui.Type.of(response)){case"object":case"array":response=new Type(response)}return response}};[iomixins,persistancemixins,httpmixins].forEach(function(mixins){gui.Object.each(mixins,function(key,value){edb.Type[key]=value})}),edb.Type.$staticmixins=function(){var mixins={};return[httpmixins,iomixins,persistancemixins].forEach(function(set){Object.keys(set).forEach(function(key){mixins[key]=this[key]},this)},this),mixins}}(),edb.Object=gui.Class.create(Object.prototype,{$onconstruct:function(data){switch(edb.Type.prototype.$onconstruct.apply(this,arguments),gui.Type.of(data)){case"object":case"undefined":edb.Object._approximate(this,data||Object.create(null));break;default:throw new TypeError("Unexpected edb.Object constructor argument of type "+gui.Type.of(data)+": "+(data+""))}this.onconstruct.apply(this,arguments)},$normalize:function(){var c,o={};return gui.Object.each(this,function(key,value){c=key[0],"$"!==c&&"_"!==c&&(edb.Type.isInstance(value)&&(value=value.$normalize()),o[key]=value)}),o}},function(){return edb.Type.$staticmixins()}(),{observe:function(object,handler){var id=object.$instanceid||object._instanceid,obs=this._observers,handlers=obs[id]||(obs[id]=[]);return-1===handlers.indexOf(handler)&&handlers.push(handler),object},unobserve:function(object,handler){var index,id=object.$instanceid||object._instanceid,obs=this._observers,handlers=obs[id];return handlers&&(index=handlers.indexOf(handler))>-1&&0===gui.Array.remove(handlers,index)&&delete obs[id],object},ontick:function(tick){var snapshot,changes,change,handlers,observers=this._observers;tick.type===edb.TICK_PUBLISH_CHANGES&&(snapshot=gui.Object.copy(this._changes),this._changes=Object.create(null),gui.Object.each(snapshot,function(instanceid){(handlers=observers[instanceid])&&(changes=gui.Object.each(snapshot,function(id,propdef){return change=propdef[Object.keys(propdef)[0]],id===instanceid?change:null}).filter(function(change){return null!==change}),handlers.forEach(function(handler){handler.onchange(changes)})),gui.Broadcast.dispatchGlobal(null,edb.BROADCAST_CHANGE,instanceid)}))},_observers:Object.create(null),_getter:function(key,base){return function(){var result=base.apply(this);return edb.Object._onaccess(this,key),result}},_setter:function(key,base){return function(newval){var oldval=this[key];base.apply(this,arguments),edb.Object._onchange(this,key,oldval,newval),oldval=newval}},_onaccess:function(object,name){var access=new edb.ObjectAccess(object,name);gui.Broadcast.dispatchGlobal(null,edb.BROADCAST_ACCESS,access.instanceid)},_onchange:function(object,name,oldval,newval){var all=this._changes,id=object._instanceid,set=all[id]=all[id]||(all[id]=Object.create(null));set[name]=new edb.ObjectChange(object,name,edb.ObjectChange.TYPE_UPDATED,oldval,newval),gui.Tick.dispatch(edb.TICK_PUBLISH_CHANGES)},_changes:Object.create(null),_approximate:function(handler,proxy){var Def,def,types=Object.create(null);this._definitions(handler).forEach(function(key){def=handler[key],gui.Type.isComplex(def)?gui.Type.isConstructor(def)?(Def=def,types[key]=new Def(proxy[key])):types[key]=edb.Type.cast(def):gui.Type.isDefined(proxy[key])||(proxy[key]=handler[key])}),gui.Object.nonmethods(proxy).forEach(function(key){def=proxy[key],gui.Type.isComplex(def)&&(types[key]||(types[key]=edb.Type.cast(def))),gui.Property.accessor(handler,key,{getter:edb.Object._getter(key,function(){return types[key]||proxy[key]}),setter:edb.Object._setter(key,function(value){var target=types[key]?types:proxy;target[key]=edb.Type.cast(value)})})})},_definitions:function(handler){var keys=[];return gui.Object.all(handler,function(key){gui.Type.isDefined(Object.prototype[key])||gui.Type.isDefined(edb.Type.prototype[key])||key.startsWith("_")||keys.push(key)}),keys}}),function(){gui.Tick.add(edb.TICK_PUBLISH_CHANGES,edb.Object),gui.Object.extendmissing(edb.Object.prototype,edb.Type.prototype)}(),function(proto){edb.Array=gui.Class.create(proto,{push:function(){var res=proto.push.apply(this,arguments);return Array.forEach(arguments,function(arg){edb.Array._onchange(this,1,arg)},this),res},pop:function(){var res=proto.pop.apply(this,arguments);return edb.Array._onchange(this,0,res),res},shift:function(){var res=proto.shift.apply(this,arguments);return edb.Array._onchange(this,0,res),res},unshift:function(){var res=proto.unshift.apply(this,arguments);return Array.forEach(arguments,function(arg){edb.Array._onchange(this,1,arg)},this),res},splice:function(){var res=proto.splice.apply(this,arguments),add=[].slice.call(arguments,2);return res.forEach(function(r){edb.Array._onchange(this,0,r)},this),add.forEach(function(a){edb.Array._onchange(this,1,a)},this),res},$of:null,$onconstruct:function(){edb.Type.prototype.$onconstruct.apply(this,arguments),edb.Array.populate(this,arguments),edb.Array.approximate(this),this.onconstruct.call(this,arguments)},$normalize:function(){return Array.map(this,function(thing){return edb.Type.isInstance(thing)?thing.$normalize():thing})}},function(){return edb.Type.$staticmixins()}(),{populate:function(array,args){var members;args.length&&(members=[],members=gui.Type.isArray(args[0])?args[0]:Array.prototype.slice.call(args),members=gui.Type.isFunction(array.$of)?edb.Array._populatefunction(members,array.$of):edb.Array._populatedefault(members),Array.prototype.push.apply(array,members))},approximate:function(handler,proxy){var def=null;proxy=proxy||Object.create(null),this._definitions(handler).forEach(function(key){switch(def=handler[key],gui.Type.of(def)){case"function":break;case"object":case"array":console.warn("TODO: complex stuff on edb.Array :)");break;default:gui.Type.isDefined(proxy[key])||(proxy[key]=handler[key])}}),gui.Object.nonmethods(proxy).forEach(function(key){Object.defineProperty(handler,key,{enumerable:!0,configurable:!0,get:edb.Type.getter(function(){return proxy[key]}),set:edb.Type.setter(function(value){proxy[key]=value})})})},_definitions:function(handler){var keys=[];for(var key in handler)this._define(key)&&keys.push(key);return keys},_define:function(key){return gui.Type.isNumber(gui.Type.cast(key))||gui.Type.isDefined(Array.prototype[key])||gui.Type.isDefined(edb.Type.prototype[key])||key.startsWith("_")?!1:!0},_populatefunction:function(members,func){return members.map(function(o){if(void 0!==o&&!o._instanceid){var Type=func;gui.Type.isConstructor(Type)||(Type=func(o)),o=new Type(o)}return o})},_populatedefault:function(members){return members.map(function(o){if(!edb.Type.isInstance(o))switch(gui.Type.of(o)){case"object":return new edb.Object(o);case"array":return new edb.Array(o)}return o})},_onaccess:function(){},_onchange:function(array,type){type={0:edb.ArrayChange.TYPE_REMOVED,1:edb.ArrayChange.TYPE_ADDED}[type]}})}(Array.prototype),function(proto){"use strict";edb.Type.decorateGetters(proto,["filter","forEach","every","map","some","indexOf","lastIndexOf"]),edb.Type.decorateSetters(proto,["push","unshift","splice","pop","shift","reverse"]),proto.concat=function(other){var clone=new this.constructor;return this.forEach(function(o){clone.push(o)}),other.forEach(function(o){clone.push(o)}),clone}}(edb.Array.prototype),function(){gui.Object.extendmissing(edb.Array.prototype,edb.Type.prototype)}(),edb.ObjectAccess=function(object,name){this.instanceid=object._instanceid,this.object=object,this.name=name},edb.ObjectAccess.prototype={instanceid:null,object:null,name:null},edb.ObjectChange=function(object,name,type,oldval,newval){this.object=object,this.name=name,this.type=type,this.oldValue=oldval,this.newValue=newval},edb.ObjectChange.prototype={object:null,name:null,type:null,oldValue:void 0,newValue:void 0},edb.ObjectChange.TYPE_UPDATED="updated",edb.ArrayAccess=function(array){this.instanceid=array._instanceid,this.array=array},edb.ArrayAccess.prototype={instanceid:null,array:null},edb.ArrayChange=function(array){this.instanceid=array._instanceid},edb.ArrayChange.prototype={instanceid:null,array:null},edb.ArrayChange.TYPE_ADDED="added",edb.ArrayChange.TYPE_REMOVED="removed",edb.Output={toString:function(){return"[object edb.Output]"},dispatch:function(type,context){context=context||self,this._configure(type.constructor,type,context),gui.Broadcast.dispatch(null,edb.BROADCAST_OUTPUT,new edb.Input(type),context.gui.$contextid),gui.Broadcast.addGlobal(gui.BROADCAST_WILL_UNLOAD,this)},out:function(Type,context){context=context||self;var contxid=context.gui.$contextid,contmap=this._contexts[contxid],classid=Type.$classid;return contmap&&contmap[classid]},onbroadcast:function(b){b.type===gui.BROADCAST_WILL_UNLOAD&&this._onunload(b.data)},_contexts:{},_configure:function(Type,type,context){var contxid=context.gui.$contextid,contmap=this._contexts[contxid]||(this._contexts[contxid]={}),classid=Type.$classid;contmap[classid]=type,type.$context=context,type.$contextid=contxid},_onunload:function(contextid){var context=this._contexts[contextid];context&&(gui.Object.each(context,function(classid,type){type.$ondestruct()},this),delete this._contexts[contextid])},$get:function(Type,context){if(context=context||self,Type.out(context)){var contxid=context.gui.$contextid,contmap=this._contexts[contxid],classid=Type.$classid,typeobj=contmap[classid];return new edb.Input(typeobj)}return null}},edb.OutputPlugin=gui.Plugin.extend({dispatch:function(data,Type){return console.error("edb.OutputPlugin is deprecated"),edb.Output.dispatch(this.context,data,Type)},exists:function(Type){return console.error("edb.OutputPlugin is deprecated"),edb.Output.out(Type,this.context||self)}}),edb.Input=function(type){if(!edb.Type.isInstance(type))throw new TypeError(type+" is not a Type");this.type=type.constructor,this.data=type},edb.Input.prototype={type:null,data:null,toString:function(){return"[object edb.Input]"}},edb.InputPlugin=gui.Tracker.extend({done:!0,onconstruct:function(){this._super.onconstruct(),this._watches=[],this._matches=[]},ondestruct:function(){this._super.ondestruct(),this.remove(this._watches),this._xxx(!1)},add:gui.Combo.chained(function(arg,handler){this.done=!1,handler=handler?handler:this.spirit,arg=edb.InputPlugin._breakdown(arg,this.context),this._add(arg,handler),this._xxx(!0)}),remove:gui.Combo.chained(function(arg,handler){handler=handler?handler:this.spirit,arg=edb.InputPlugin._breakdown(arg,this.context),this._remove(arg,handler),(this.done=this._matches.length===this._watches.length)&&this._xxx(!1)}),get:function(type){var types=this._matches.map(function(input){return input.data.constructor}),best=edb.InputPlugin._bestmatch(type,types),input=best?this._matches.filter(function(input){return input.type===best}).shift():null;return input?input.data:null},dispatch:function(data,Type){return this.spirit?this.spirit.script.input(data,Type):(console.error("TODO: not implemented (private sandbox input)"),void 0)},onbroadcast:function(b){b.type===edb.BROADCAST_OUTPUT&&this.match(b.data)},match:function(input){this._maybeinput(input)},_watches:null,_matches:null,_add:function(types,handler){types.forEach(function(Type){if(!gui.Type.isDefined(Type))throw new TypeError("Could not register input for undefined Type");this._watches.push(Type),this._addchecks(Type.$classid,[handler]),Type.out(this.context)&&this._maybeinput(edb.Output.$get(Type,this.context))},this)},_remove:function(types,handler){types.forEach(function(type){var index=this._watches.indexOf(type);index>-1&&(this._watches.remove(index),this._removechecks(type.$classid,[handler]))},this)},_maybeinput:function(input){var best=edb.InputPlugin._bestmatch(input.type,this._watches);best&&(this._updatematch(input),this.done=this._matches.length===this._watches.length,this._updatehandlers(input))},_updatematch:function(newinput){var matches=this._matches,types=matches.map(function(input){return input.type}),best=edb.InputPlugin._bestmatch(newinput.type,types);if(best){var oldinput=matches.filter(function(input){return input.type===best})[0],index=matches.indexOf(oldinput);matches[index]=newinput}else matches.push(newinput)},_updatehandlers:function(input){gui.Class.ancestorsAndSelf(input.type,function(Type){var list=this._trackedtypes[Type.$classid];list&&list.forEach(function(checks){var handler=checks[0];handler.oninput(input)})},this)},_xxx:function(is){gui.Broadcast[is?"add":"remove"](edb.BROADCAST_OUTPUT,this,this.context.gui.$contextid)}},{},{_breakdown:function(arg,context){return gui.Type.isArray(arg)?this._breakarray(arg,context):this._breakother(arg,context)},_breakarray:function(array,context){return array.map(function(o){switch(gui.Type.of(o)){case"function":return o;case"string":return gui.Object.lookup(o,context);case"object":console.error("Expected function. Got object.")}},this)},_breakother:function(arg,context){switch(gui.Type.of(arg)){case"function":return[arg];case"string":return this._breakarray(arg.split(" "),context);case"object":console.error("Expected function. Got object.")}},_bestmatch:function(target,types){var best=null,rating=Number.MAX_VALUE;return this._rateall(target,types,function(type,rate){rate>-1&&rating>rate&&(best=type)}),best},_rateall:function(target,types,action){types.forEach(function(type){action(type,this._rateone(target,type))},this)},_rateone:function(target,type){if(target===type)return 0;var tops=gui.Class.ancestorsAndSelf(target),subs=gui.Class.descendantsAndSelf(target),itop=tops.indexOf(type),isub=subs.indexOf(type);return 0>itop?isub:itop}}),edb.ScriptPlugin=gui.Plugin.extend({loaded:!1,autorun:!0,ran:!1,diff:!0,debug:!1,extras:null,src:{getter:function(){return this._src},setter:function(src){this.load(src)}},onconstruct:function(){this._super.onconstruct();var spirit=this.spirit;this.inputs=this.inputs.bind(this),spirit.life.add(gui.LIFE_DESTRUCT,this),spirit instanceof edb.ScriptSpirit?this.autorun=!1:this.diff&&(this._updater=new edb.UpdateManager(spirit))},ondestruct:function(){this._super.ondestruct(),this._script&&this._script.dispose()},onatt:function(att){"src"===att.name&&(this.src=att.value)},ontick:function(tick){tick.type===gui.TICK_DOC_FIT&&this.spirit.action.dispatchGlobal(gui.ACTION_DOC_FIT)},onlife:function(life){life.type===gui.LIFE_ENTER&&(this.spirit.life.remove(life.type,this),this._dosrc&&(this.load(this._dosrc),this._dosrc=null))},load:function(src){var win=this.context,doc=win.document,abs=gui.URL.absolute(doc,src);this.spirit.life.entered?abs!==this._src&&(edb.Script.load(win,doc,src,function(script){this._onreadystatechange(script)},this),this._src=abs):(this.spirit.life.add(gui.LIFE_ENTER,this),this._dosrc=src)},compile:function(source,directives){var win=this.context,url=new gui.URL(this.context.document);edb.Script.compile(win,url,source,directives,function(script){this._onreadystatechange(script)},this)},run:function(){this.loaded?(this._script.pointer=this.spirit,this.write(this._script.execute.apply(this._script,arguments))):this._dorun=arguments},write:function(html){var changed=this._html!==html;if(changed&&(this._html=html,this._stayfocused(function(){this.diff?this._updater.update(html):this.spirit.dom.html(html)}),this.ran=!0,this.spirit.life.dispatch(edb.LIFE_SCRIPT_DID_RUN,changed),this.context.gui.hosted)){var tick=gui.TICK_DOC_FIT,id=this.context.gui.$contextid;gui.Tick.one(tick,this,id).dispatch(tick,0,id)}},input:function(data,Type){var input=edb.Input.format(this.context,data,Type);return this._script?this._script.input.match(input):(this._doinput=this._doinput||[],this._doinput.push(input)),input.data},inputs:function(type){return this._script.input.get(type)},_src:null,_script:null,_updater:null,_doinput:null,_dosrc:null,_dorun:null,_html:null,_onreadystatechange:function(script){switch(this._script=this._script||script,script.readyState){case edb.Function.WAITING:if(this._doinput&&this._doinput.length){for(;this._doinput.length;)this.input(this._doinput.shift());this._doinput=null}break;case edb.Function.READY:this.loaded||(this.loaded=!0,this.debug&&script.debug()),this._dorun?(this.run.apply(this,this._dorun),this._dorun=null):this.autorun&&this.run()}},_stayfocused:function(action){var field,selector=edb.EDBModule.fieldselector;if(action.call(this),selector&&(field=gui.DOMPlugin.q(this.spirit.document,selector),field&&"#"+field.id!==selector&&field&&gui.DOMPlugin.contains(this.spirit,field))){field.focus();var text="textarea,input:not([type=checkbox]):not([type=radio])";gui.CSSPlugin.matches(field,text)&&field.setSelectionRange(field.value.length,field.value.length),this._restorefocus(field),this._debugwarning()}},_restorefocus:function(field){var text="textarea,input:not([type=checkbox]):not([type=radio])";field.focus(),gui.CSSPlugin.matches(field,text)&&field.setSelectionRange(field.value.length,field.value.length)},_debugwarning:function(){var This=edb.ScriptPlugin;This._warning&&this.spirit.window.gui.debug&&(console.debug(This._warning),This._warning=null)}},{},{_warning:"Spiritual: Form elements with a unique @id may be updated without losing the undo-redo stack (now gone)."}),edb.ScriptSpirit=gui.Spirit.extend({debug:!1,onconfigure:function(){this._super.onconfigure();var parent=this.dom.parent(gui.Spirit);parent&&this._initparentplugin(parent)},_initparentplugin:function(parent){var src=this.att.get("src");if(src)parent.script.load(src);else{var directives=this.att.getmap();directives.debug=directives.debug||this.debug,parent.script.compile(this.dom.text(),directives)}}}),edb.ServiceSpirit=gui.Spirit.extend({onconstruct:function(){this._super.onconstruct();var Type,type=this.att.get("type");if(type&&(Type=gui.Object.lookup(type,this.window),!Type))throw new TypeError('"'+type+'" is not a Type (in this context).');this.att.get("href")?new gui.Request(this.element.href).get().then(function(status,data){type=function(){if(Type)return new Type(data);switch(gui.Type.of(data)){case"object":return new edb.Object(data);case"array":return new edb.Array(data)}}(),type?type.$output(this.window):console.error("TODO: handle unhandled response type")},this):Type&&(new Type).$output(this.window)}}),edb.Instruction=function(pi){this.atts=Object.create(null),this.type=pi.split("<?")[1].split(" ")[0];for(var hit,atexp=edb.Instruction._ATEXP;hit=atexp.exec(pi);){var n=hit[1],v=hit[2];this.atts[n]=gui.Type.cast(v)}},edb.Instruction.prototype={type:null,atts:null,toString:function(){return"[object edb.Instruction]"}},edb.Instruction.from=function(source){for(var pis=[],hit=null;hit=this._PIEXP.exec(source);)pis.push(new edb.Instruction(hit[0]));return pis},edb.Instruction.clean=function(source){return source.replace(this._PIEXP,"")},edb.Instruction._PIEXP=/<\?.[^>?]+\?>/g,edb.Instruction._ATEXP=/(\S+)=["']?((?:.(?!["']?\s+(?:\S+)=|[>"']))+.)["']?/g,edb.Runner=function(){},edb.Runner.prototype={firstline:!1,lastline:!1,firstchar:!1,lastchar:!1,run:function(compiler,script,status,result){this._runlines(compiler,script.split("\n"),status,result)},ahead:function(string){var line=this._line,index=this._index,i=index+1,l=string.length;return line.length>index+l&&line.substring(i,i+l)===string},behind:function(string){var line=this._line,index=this._index,length=string.length,start=index-length;return start>=0&&line.substr(start,length)===string},lineahead:function(){return this._line.substring(this._index+1)},skipahead:function(){console.error("TODO")},_line:null,_index:-1,_runlines:function(compiler,lines,status,result){var stop=lines.length-1;lines.forEach(function(line,index){this.firstline=0===index,this.lastline=index===stop,this._runline(line,index,compiler,status,result)},this)},_runline:function(line,index,compiler,status,result){line=this._line=line.trim(),line.length&&(compiler.newline(line,this,status,result),this._runchars(compiler,line.split(""),status,result),compiler.endline(line,this,status,result))},_runchars:function(compiler,chars,status,result){var stop=chars.length-1;chars.forEach(function(c,i){this._index=i,this.firstchar=0===i,this.lastchar=i===stop,compiler.nextchar(c,this,status,result)},this)}},edb.Status=function(){this.conf=[]},edb.Status.MODE_JS="js",edb.Status.MODE_HTML="html",edb.Status.MODE_TAG="tag",edb.Status.prototype={mode:edb.Status.MODE_JS,peek:!1,poke:!1,cont:!1,adds:!1,func:null,conf:null,curl:null,skip:0,last:0,spot:0,indx:0,refs:!1,isjs:function(){return this.mode===edb.Status.MODE_JS},ishtml:function(){return this.mode===edb.Status.MODE_HTML},istag:function(){return this.mode===edb.Status.MODE_TAG},gojs:function(){this.mode=edb.Status.MODE_JS},gohtml:function(){this.mode=edb.Status.MODE_HTML},gotag:function(){this.mode=edb.Status.MODE_TAG}},edb.Result=function(body){this.body=body||""},edb.Result.prototype={body:null,temp:null,format:function(){return edb.Result.format(this.body)}},edb.Result.format=function(body){var result="",tabs="	",init=null,last=null,fixt=null,hack=null;return body.split("\n").forEach(function(line){line=line.trim(),init=line.charAt(0),last=line.charAt(line.length-1),fixt=line.split("//")[0].trim(),hack=fixt.charAt(fixt.length-1),"}"!==init&&"]"!==init||""===tabs||(tabs=tabs.slice(0,-1)),result+=tabs+line+"\n",("{"===last||"["===last||"{"===hack||"["===hack)&&(tabs+="	")}),result},edb.Storage=gui.Class.create(Object.prototype,{},{length:{getter:function(){throw Error("Not supported.")}},getItem:function(key){var then=new gui.Then,type=this[key];return type?then.now(type):this.$getItem(key,function(type){this[key]=type,gui.Tick.next(function(){then.now(type)})}),then},setItem:function(key,type){var then=new gui.Then;return edb.Storage.$typecheck(type)&&this.$setItem(key,type,function(){this[key]=type,then.now(type)}),then},removeItem:function(key){var then=new gui.Then;return delete this[key],this.$removeItem(key,function(){then.now()}),then},clear:function(){var then=new gui.Then;return this.$clear(function(){Object.keys(this).filter(function(key){return void 0===this.prototype[key]},this).forEach(function(key){delete this[key]},this),then.now()}),then},$getItem:function(){},$setItem:function(){},$removeItem:function(){},$clear:function(){}},{$typecheck:function(type){if(edb.Type.isInstance(type)){if(type.constructor.$classname!==gui.Class.ANONYMOUS)return!0;throw Error("Cannot persist ANONYMOUS Type")}throw new TypeError("Persist only models and collections")}}),edb.DOMStorage=edb.Storage.extend({},{onbroadcast:function(b){b.type===gui.BROADCAST_UNLOAD&&b.data===gui.$contextid&&this.$write(!0)},_domstorage:null,_storagekey:null,_storagemap:null,$getItem:function(key,callback){var json=null,type=null,Type=null,xxxx=this.$read();(json=xxxx[key])&&(json=JSON.parse(json),Type=gui.Object.lookup(key,self),type=Type?new Type(json):null),callback.call(this,type)},$setItem:function(key,item,callback){var xxxx=this.$read();xxxx[key]=item.$stringify(),this.$write(!1),callback.call(this)},$removeItem:function(key,callback){var xxxx=this.$read();delete xxxx[key],this.$write(!1),callback.call(this)},$clear:function(callback){this._domstorage.removeItem(this._storagekey),this._storagemap=null,callback.call(this)},$read:function(){if(!this._storagemap){var map=this._domstorage.getItem(this._storagekey);this._storagemap=map?JSON.parse(map):{}}return this._storagemap},$write:function(now){function write(){dom.setItem(key,JSON.stringify(map))}var map=this._storagemap,dom=this._domstorage,key=this._storagekey;map&&(now?write():setTimeout(function(){write()},50))}}),edb.SessionStorage=edb.DOMStorage.extend({},{_domstorage:sessionStorage,_storagekey:"MyVendor.MyApp.SessionStorage"}),function(){gui.Broadcast.addGlobal(gui.BROADCAST_UNLOAD,edb.SessionStorage)}(),edb.LocalStorage=edb.DOMStorage.extend({},{_domstorage:localStorage,_storagekey:"MyVendor.MyApp.LocalStorage"}),function(){gui.Broadcast.addGlobal(gui.BROADCAST_UNLOAD,edb.LocalStorage)}(),edb.Compiler=gui.Class.create(Object.prototype,{newline:function(line,runner,status){status.last=line.length-1,status.adds="+"===line[0],status.cont=status.cont||status.ishtml()&&status.adds},endline:function(line,runner,status,result){status.ishtml()?status.cont||(result.body+="';\n",status.gojs()):result.body+="\n",status.cont=!1},nextchar:function(c,runner,status,result){switch(status.mode){case edb.Status.MODE_JS:this._compilejs(c,runner,status,result);break;case edb.Status.MODE_HTML:this._compilehtml(c,runner,status,result);break;case edb.Status.MODE_TAG:this._compiletag(c,runner,status,result)}0>=status.skip--&&(status.poke?result.temp+=c:status.istag()||(result.body+=c))},_compile:function(script){var runner=new edb.Runner,status=new edb.Status,result=new edb.Result('"use strict";\n');return runner.run(this,script,status,result),result.body+=(status.ishtml()?"';":"")+"\nreturn out.write ();",result.format()},_compilejs:function(c,runner,status,result){switch(c){case"<":if(runner.firstchar){status.gohtml(),status.spot=result.body.length-1,result.body+="out.html += '"}break;case"@":this._scriptatt(runner,status,result)}},_compilehtml:function(c,runner,status,result){switch(c){case"{":(status.peek||status.poke)&&status.curl++;break;case"}":0===--status.curl&&(status.peek&&(status.peek=!1,status.skip=1,status.curl=0,result.body+=") + '"),status.poke&&(this._poke(status,result),status.poke=!1,result.temp=null,status.spot=-1,status.skip=1,status.curl=0));break;case"$":status.peek||status.poke||!runner.ahead("{")||(status.peek=!0,status.skip=2,status.curl=0,result.body+="' + (");break;case"#":status.peek||status.poke||!runner.ahead("{")||(status.poke=!0,status.skip=2,status.curl=0,result.temp="");break;case"+":runner.firstchar?status.skip=status.adds?1:0:runner.lastchar&&(status.cont=!0,status.skip=1);break;case"'":status.peek||status.poke||(result.body+="\\");break;case"@":this._htmlatt(runner,status,result)}},_compiletag:function(status,c,i,line){switch(c){case"$":this._ahead(line,i,"{")&&(status.refs=!0,status.skip=2);break;case">":status.gojs(),status.skip=1}},_scriptatt:function(runner,status,result){var rest,name,attr=edb.Compiler._ATTREXP;if(runner.behind("@"));else if(runner.ahead("@"))result.body+="var att = new edb.Att ();",status.skip=2;else{if(rest=runner.lineahead(),name=attr.exec(rest)[0],!name)throw"Bad @name: "+rest;result.body+=rest.replace(name,"att['"+name+"']"),status.skip=rest.length}},_htmlatt:function(runner,status,result){var rest,name,dels,what,attr=edb.Compiler._ATTREXP;runner.behind("@")||(runner.behind("#{")?console.error("todo"):runner.ahead("@")?(result.body+="' + att._all () + '",status.skip=2):(rest=runner.lineahead(),name=attr.exec(rest)[0],dels=runner.behind("-"),what=dels?"att._pop":"att._out",result.body=dels?result.body.substring(0,result.body.length-1):result.body,result.body+="' + "+what+" ( '"+name+"' ) + '",status.skip=name.length+1))},_poke:function(status,result){var sig=this._$contextid?", &quot;"+this._$contextid+"&quot;":"",body=result.body,temp=result.temp,spot=status.spot,prev=body.substring(0,spot),next=body.substring(spot),name=gui.KeyMaster.generateKey("poke");result.body=prev+"\n"+"var "+name+" = edb.set ( function ( value, checked ) { \n"+temp+";\n}, this );"+next+"edb.go(event,&quot;' + "+name+" + '&quot;"+sig+");"}},{},{_ATTREXP:/^[^\d][a-zA-Z0-9-_\.]+/}),edb.FunctionCompiler=edb.Compiler.extend({source:null,dependencies:null,directives:null,sequence:null,onconstruct:function(source,directives){this.directives=directives||Object.create(null),this.source=source,this.sequence=["_validate","_extract","_direct","_declare","_define","_compile"]},compile:function(context,url){var result=null;this.dependencies=[],this._params=[],this._context=context,this._url=url,this._vars=[];var head={declarations:Object.create(null),functiondefs:[]};this.sequence.forEach(function(step){this.source=this[step](this.source,head)},this);try{result=this._convert(this.source,this._params),this.source=this._source(this.source,this._params)
}catch(exception){result=this._fail(exception)}return result},sign:function(contextid){return this._$contextid=contextid,this},_context:null,_$contextid:null,_instructions:null,_params:null,_failed:!1,_validate:function(script){if(edb.FunctionCompiler._NESTEXP.test(script))throw"Nested EDBML dysfunction";return script},_direct:function(script){return script},_extract:function(script){return edb.Instruction.from(script).forEach(function(pi){this._instruct(pi)},this),edb.Instruction.clean(script)},_instruct:function(pi){var type=pi.type,atts=pi.atts,href=atts.src,name=atts.name,cont=this._context;switch(type){case"param":this._params.push(name);break;case"function":case"tag":if(type===edb.Import.TYPE_TAG){if(!href.contains("#"))throw Error("Missing tag #identifier: "+href);name=href.split("#")[1]}var base=this._basedocument();this.dependencies.push(new edb.Import(cont,base,type,href,name))}},_declare:function(script,head){var funcs=[];return this.dependencies.forEach(function(dep){head.declarations[dep.name]=!0,funcs.push(dep.name+" = get ( self, '"+dep.tempname()+"' );\n")},this),funcs[0]&&head.functiondefs.push("( function functions ( get ) {\n"+funcs.join("")+"}( edb.Function.get ));"),script},_define:function(script,head){var vars="",html="var ";return Object.keys(head.declarations).forEach(function(name){vars+=", "+name}),0>this._params.indexOf("out")&&(html+="Out = edb.Out, out = new Out (), "),0>this._params.indexOf("att")&&(html+="Att = edb.Att, att = new Att (), "),html+="Tag = edb.Tag "+vars+";\n",head.functiondefs.forEach(function(def){html+=def+"\n"}),html+script},_convert:function(script,params){var args="",context=this._context;return gui.Type.isArray(params)&&(args=params.join(",")),new context.Function(args,script)},_fail:function(exception){var context=this._context;if(this._failed)throw exception;return this._failed=!0,this._debug(edb.Result.format(this.source)),this.source='<p class="error">'+exception.message+"</p>",this.compile(context,!0)},_debug:function(source){var context=this._context;if(window.btoa){source=context.btoa("function debug () {\n"+source+"\n}");var script=context.document.createElement("script");script.src="data:text/javascript;base64,"+source,context.document.querySelector("head").appendChild(script),script.onload=function(){this.parentNode.removeChild(this)}}},_source:function(source,params){var lines=source.split("\n");lines.pop();var args=params.length?"( "+params.join(", ")+" )":"()";return"function "+args+" {\n"+lines.join("\n")+"\n}"},_basedocument:function(){return this._document||(this._document=function(href){var doc=document.implementation.createHTMLDocument("temp"),base=doc.createElement("base");return base.href=href,doc.querySelector("head").appendChild(base),doc}(this._url.href))}},{},{_NESTEXP:/<script.*type=["']?text\/edbml["']?.*>([\s\S]+?)/g}),edb.ScriptCompiler=edb.FunctionCompiler.extend({inputs:null,_instruct:function(pi){this._super._instruct(pi);var atts=pi.atts;switch(pi.type){case"input":this.inputs[atts.name]=atts.type}},compile:function(context,url){return this.inputs=Object.create(null),this._super.compile(context,url)},_declare:function(script,head){return this._super._declare(script,head),this._declareinputs(script,head)},_declareinputs:function(script,head){var defs=[];return gui.Object.each(this.inputs,function(name,type){head.declarations[name]=!0,defs.push(name+" = get ( "+type+" );\n")},this),defs[0]&&head.functiondefs.push("( function inputs ( get ) {\n"+defs.join("")+"})( this.script.inputs );"),script}}),edb.TagCompiler=edb.FunctionCompiler.extend({_direct:function(script){if(this.directives.tag){var content=edb.TagCompiler._CONTENT;this._params.push("content"),this._params.push("attribs"),this._params.push("COMPILED_AS_TAG"),script="att = new Att ( attribs );\n"+script,script=script.replace(content,"content ( out );")}return this._super._direct(script)}},{},{_CONTENT:/<content(.*)>(.*)<\/content>|<content(.*)(\/?)>/}),edb.Loader=gui.FileLoader.extend({directives:null,load:function(src,callback,thisp){var url=new gui.URL(this._document,src);this._cache.has(url.location)?this._cached(url,callback,thisp):url.external?this._request(url,callback,thisp):url.hash?this._lookup(url,callback,thisp):console.error("Now what?")},onload:function(text,url,callback,thisp){url.external&&(text=this._extract(text,url)),callback.call(thisp,text,this.directives,url),this.directives=null},_lookup:function(url,callback,thisp){var script=this._document.querySelector(url.hash);script?(this.directives=gui.AttPlugin.getmap(script),this.onload(script.textContent,url,callback,thisp)):console.error("No such script: "+url)},_extract:function(text,url){var doc=gui.HTMLParser.parseToDocument(text),script=doc.querySelector(url.hash||"script");return script?(this.directives=gui.AttPlugin.getmap(script),script.textContent):(console.error("No such script: "+url.location+url.hash||""),void 0)}}),edb.Function=gui.Class.create(Object.prototype,{executable:null,context:null,url:null,readyState:null,onreadystatechange:null,onconstruct:function(context,url,handler){this.context=context||null,this.url=url||null,this.onreadystatechange=handler||null,this._imports=Object.create(null)},compile:function(source,directives){if(null===this.executable){var Compiler=this._compiler(),compiler=new Compiler(source,directives);return this._$contextid&&compiler.sign(this._$contextid),this.executable=compiler.compile(this.context,this.url),this._source=compiler.source,this._dependencies(compiler),this._oncompiled(compiler,directives),this}throw Error("TODO: recompile the script :)")},debug:function(){console.debug(this._source)},_dependencies:function(compiler){compiler.dependencies.map(function(dep){return this._imports[dep.name]=null,dep},this).forEach(function(dep){dep.resolve().then(function(resolved){this._imports[dep.name]=resolved,this._maybeready()},this)},this)},sign:function($contextid){return this._$contextid=$contextid,this},execute:function(){var result=null;if(!this.executable)throw Error(this+" not compiled");try{this._subscribe(!0),result=this.executable.apply(this.pointer,arguments),this._subscribe(!1)}catch(exception){console.error(exception.message+":\n\n"+this._source)}return result},_$contextid:null,_imports:null,_compiler:function(){return edb.FunctionCompiler},_oncompiled:function(compiler,directives){directives.debug&&this.debug();try{this._useblob()?this._loadblob(compiler):this._maybeready()}catch(workerexception){this._maybeready()}},_useblob:function(){return this.context.edb.useblobs&&gui.Client.hasBlob&&!gui.Client.isExplorer&&!gui.Client.isOpera},_loadblob:function(compiler){var win=this.context,doc=win.document,key=gui.KeyMaster.generateKey(),src=compiler.source.replace("function","function "+key);this._gostate(edb.Function.LOADING),gui.BlobLoader.loadScript(doc,src,function(){this._gostate(edb.Function.WORKING),this.executable=win[key],this._maybeready()},this)},_gostate:function(state){state!==this.readyState&&(this.readyState=state,gui.Type.isFunction(this.onreadystatechange)&&this.onreadystatechange())},_maybeready:function(){this.readyState!==edb.Function.LOADING&&(this._gostate(edb.Function.WORKING),this._done()?this._gostate(edb.Function.READY):this._gostate(edb.Function.WAITING))},_done:function(){return Object.keys(this._imports).every(function(name){return null!==this._imports[name]},this)}},{get:function(context,src){var ex=this._executables,id=context.gui.$contextid;if(gui.URL.absolute(src))return ex[id]?ex[id][src]||null:null;throw Error("Absolute URL expected")},load:function(context,basedoc,src,callback,thisp){var exe=this._executablecontext(context);new edb.Loader(basedoc).load(src,function(source,directives,url){this.compile(context,url,source,directives,function(fun){exe[url.href]||fun.readyState!==edb.Function.READY||(exe[url.href]=fun.executable),callback.call(thisp,fun)})},this)},compile:function(context,url,source,directives,callback,thisp){var Fun=this;new Fun(context,url,function(){callback.call(thisp,this)}).compile(source,directives)},_executables:Object.create(null),_executablecontext:function(context){var exe=this._executables,id=context.gui.$contextid;return exe[id]||(exe[id]=Object.create(null))}},{LOADING:"loading",WAITING:"waiting",WORKING:"working",READY:"ready"}),function(){edb.Function.get=edb.Function.get.bind(edb.Function)}(),edb.Script=edb.Function.extend({input:null,pointer:null,onconstruct:function(context,url,handler){this._super.onconstruct(context,url,handler),this.input=new edb.InputPlugin,this.input.context=this.context,this.input.onconstruct(),console.warn("Bad: onconstruct should autoinvoke"),this._keys=new Set,gui.Broadcast.addGlobal(edb.BROADCAST_CHANGE,this)},onbroadcast:function(b){switch(b.type){case edb.BROADCAST_ACCESS:this._keys.add(b.data);break;case edb.BROADCAST_CHANGE:if(this._keys.has(b.data)&&this.readyState!==edb.Function.WAITING){var tick=edb.TICK_SCRIPT_UPDATE,sig=this.context.gui.$contextid;gui.Tick.one(tick,this,sig).dispatch(tick,0,sig),this._gostate(edb.Function.WAITING)}}},ontick:function(tick){switch(tick.type){case edb.TICK_SCRIPT_UPDATE:this._gostate(edb.Function.READY)}},oninput:function(){this._maybeready()},execute:function(){this._keys=new Set;var result=null;if(!this.input.done)throw Error("Script awaits input");return this._subscribe(!0),result=this._super.execute.apply(this,arguments),this._subscribe(!1),result},dispose:function(){this.onreadystatechange=null,this.input.ondestruct()},_Compiler:edb.ScriptCompiler,_keys:null,_inputresolved:!1,_compiler:function(){return edb.ScriptCompiler},_oncompiled:function(compiler,directives){gui.Object.each(compiler.inputs,function(name,type){this.input.add(type,this)},this),this._inputresolved=!0,this._super._oncompiled(compiler,directives)},_done:function(){return this._inputresolved&&this.input.done&&this._super._done()},_subscribe:function(isBuilding){gui.Broadcast[isBuilding?"addGlobal":"removeGlobal"](edb.BROADCAST_ACCESS,this),gui.Broadcast[isBuilding?"removeGlobal":"addGlobal"](edb.BROADCAST_CHANGE,this)}},{_invokables:new Map,_log:null,$assign:function(func,thisp){var key=gui.KeyMaster.generateKey();return edb.Script._invokables.set(key,function(value,checked){func.apply(thisp,[gui.Type.cast(value),checked])}),key},$invoke:function(key,sig,log){var func=null;if(log=log||this._log,sig)gui.Broadcast.dispatchGlobal(this,edb.BROADCAST_SCRIPT_INVOKE,{key:key,sig:sig,log:log});else{if(!(func=this._invokables.get(key)))throw Error("Invokable does not exist: "+key);"click"===log.type?setImmediate(function(){func(log.value,log.checked)}):func(log.value,log.checked)}},$register:function(e){return this._log={type:e.type,value:e.target.value,checked:e.target.checked},this}}),edb.Tag=edb.Function.extend({_compiler:function(){return edb.TagCompiler},compile:function(source,directives){return directives.tag=!0,this._super.compile(source,directives)}}),edb.Import=function(context,basedoc,type,href,name){this._context=context,this._document=basedoc,this.type=type,this.name=name,this.href=href},edb.Import.prototype={type:null,name:null,href:null,toString:function(){return"[object edb.Import]"},resolve:function(){var pool=this._functionpool(),func=pool.get(this._context,this.tempname()),then=new gui.Then;return func?then.now(func):pool.load(this._context,this._document,this.href,function(func){func.readyState===edb.Function.READY&&then.now(func)}),then},tempname:function(){return new gui.URL(this._document,this.href).href},_functionpool:function(){switch(this.type){case edb.Import.TYPE_FUNCTION:return edb.Function;case edb.Import.TYPE_TAG:return edb.Tag}},_context:null},edb.Import.TYPE_FUNCTION="function",edb.Import.TYPE_TAG="tag",edb.Att=function(atts){atts&&gui.Object.extend(this,atts)},edb.Att.prototype=gui.Object.create(null,{toString:function(){return"[object edb.Att]"},_out:function(att){var val=this[att],html="";switch(gui.Type.of(val)){case"null":case"undefined":break;default:val=edb.Att.encode(this[att]),html+=att+'="'+val+'" '}return html},_pop:function(att){var html=this._out(att);return delete this[att],html},_all:function(){var html="";return gui.Object.nonmethods(this).forEach(function(att){html+=this._out(att)},this),html}}),edb.Att.encode=function(data){var type=gui.Type.of(data);switch(type){case"string":break;case"number":case"boolean":data+="";break;case"object":case"array":try{data=encodeURIComponent(JSON.stringify(data))}catch(jsonex){throw Error("Could not create HTML attribute: "+jsonex)}break;case"date":throw Error("TODO: edb.Att.encode standard date format?");default:throw Error("Could not create HTML attribute for "+type)}return data},edb.Out=function(){this.html=""},edb.Out.prototype={html:null,write:function(){return this.html}},edb.UpdateAssistant={id:function(element){return gui.Type.isDefined(element.id)?element.id||null:element.getAttribute("id")||null},parse:function(doc,markup,id,element){return element=doc.createElement(element.localName),element.innerHTML=markup,element.id=id,Array.forEach(element.querySelectorAll("option"),function(option){switch(option.getAttribute("selected")){case"true":option.setAttribute("selected","selected");break;case"false":option.removeAttribute("selected")}}),Array.forEach(element.querySelectorAll("input[type=checkbox],input[type=radio]"),function(option){switch(option.getAttribute("checked")){case"true":option.setAttribute("checked","checked");break;case"false":option.removeAttribute("checked")}}),element},order:function(nodes){var order=new Map;return Array.forEach(nodes,function(node,index){node.nodeType===Node.ELEMENT_NODE&&order.set(this.id(node),index)},this),order},index:function(nodes){var result=Object.create(null);return Array.forEach(nodes,function(node){node.nodeType===Node.ELEMENT_NODE&&(result[this.id(node)]=node)},this),result}},edb.UpdateManager=function(spirit){this._keyid=spirit.dom.id()||spirit.$instanceid,this._spirit=spirit,this._doc=spirit.document},edb.UpdateManager.prototype={update:function(html){this._updates=new edb.UpdateCollector,this._olddom?this._next(html):this._first(html),this._updates.eachRelevant(function(update){update.update(),update.dispose()}),this._updates&&this._updates.dispose(),delete this._updates},_keyid:null,_doc:null,_spirit:null,_olddom:null,_nedwdom:null,_updates:null,_assistant:edb.UpdateAssistant,_first:function(html){this._olddom=this._parse(html),this._updates.collect(new edb.HardUpdate(this._doc).setup(this._keyid,this._olddom))},_next:function(html){this._newdom=this._parse(html),this._crawl(this._newdom,this._olddom,this._newdom,this._keyid,{},null),this._olddom=this._newdom},_parse:function(html){return this._assistant.parse(this._doc,html,this._keyid,this._spirit.element)},_crawl:function(newchild,oldchild,lastnode,id,ids,css){for(var result=!0,n=1;newchild&&oldchild&&!this._updates.hardupdates(id);){switch(newchild.nodeType){case Node.TEXT_NODE:result=this._check(newchild,oldchild,lastnode,id,ids,css,n);break;case Node.ELEMENT_NODE:result=this._scan(newchild,oldchild,lastnode,id,ids,css,n),n++}newchild=newchild.nextSibling,oldchild=oldchild.nextSibling}return result},_scan:function(newnode,oldnode,lastnode,id,ids,css,n){var result=!0,oldid=this._assistant.id(oldnode);return css=css?oldid?"#"+oldid:css+">"+oldnode.localName+":nth-child("+n+")":"this",(result=this._check(newnode,oldnode,lastnode,id,ids,css,n))&&(oldid&&(ids=gui.Object.copy(ids),lastnode=newnode,ids[oldid]=!0,id=oldid),result=this._crawl(newnode.firstChild,oldnode.firstChild,lastnode,id,ids,css)),result},_check:function(newnode,oldnode,lastnode,id,ids,css,n){var result=!0,isSoftUpdate=!1,isPluginUpdate=!1;if(newnode&&!oldnode||!newnode&&oldnode)result=!1;else if(result=newnode.nodeType===oldnode.nodeType)switch(oldnode.nodeType){case Node.TEXT_NODE:newnode.data!==oldnode.data&&(result=!1);break;case Node.ELEMENT_NODE:(result=this._familiar(newnode,oldnode))&&(result=this._checkatts(newnode,oldnode,ids,css))&&(this._maybesoft(newnode,oldnode)?(this._confirmsoft(newnode,oldnode)&&(this._updatesoft(newnode,oldnode,ids,css,n),isSoftUpdate=!0),result=!1):"textarea"!==oldnode.localName&&(result=newnode.childNodes.length===oldnode.childNodes.length))}return result||isSoftUpdate||isPluginUpdate||this._updates.collect(new edb.HardUpdate(this._doc).setup(id,lastnode)),result},_familiar:function(newnode,oldnode){return["namespaceURI","localName"].every(function(prop){return newnode[prop]===oldnode[prop]})},_checkatts:function(newnode,oldnode,ids,css){var result=!0,update=null;if(this._attschanged(newnode.attributes,oldnode.attributes,ids,css)){var newid=this._assistant.id(newnode),oldid=this._assistant.id(oldnode);newid&&newid===oldid?(update=new edb.AttsUpdate(this._doc).setup(oldid,newnode,oldnode),this._updates.collect(update,ids)):result=!1}return result},_attschanged:function(newatts,oldatts,ids,css){var changed=newatts.length!==oldatts.length;return changed||(changed=!Array.every(newatts,function(newatt){var oldatt=oldatts.getNamedItem(newatt.name);return oldatt&&oldatt.value===newatt.value}),changed&&(changed=!Array.every(newatts,function(newatt){var oldatt=oldatts.getNamedItem(newatt.name),fnkeys=this._functionchanged(newatt.value,oldatt.value);return fnkeys?(this._changefunction(ids,css,oldatt.name,fnkeys.newkey,fnkeys.oldkey),!0):newatt.value===oldatt.value},this))),changed},_functionchanged:function(newval,oldval){var newkeys=gui.KeyMaster.extractKey(newval),oldkeys=gui.KeyMaster.extractKey(oldval);return newkeys&&oldkeys?{newkey:newkeys[0],oldkey:oldkeys[0]}:null},_changefunction:function(ids,css,oldname,newkey,oldkey){this._updates.collect(new edb.FunctionUpdate(this._doc).setup(this._spirit,css,oldname,newkey,oldkey),ids)},_maybesoft:function(newnode,oldnode){return newnode&&oldnode?newnode.id&&newnode.id===oldnode.id&&this._maybesoft(newnode)&&this._maybesoft(oldnode):Array.every(newnode.childNodes,function(node){var res=!0;switch(node.nodeType){case Node.TEXT_NODE:res=""===node.data.trim();break;case Node.ELEMENT_NODE:res=null!==this._assistant.id(node)}return res},this)},_confirmsoft:function(newnode,oldnode){var res=!0,prev=null,oldorder=this._assistant.order(oldnode.childNodes);return Array.every(newnode.childNodes,function(node){if(node.nodeType===Node.ELEMENT_NODE){var id=this._assistant.id(node);oldorder.has(id)&&oldorder.has(prev)&&(res=oldorder.get(id)>oldorder.get(prev)),prev=id}return res},this)},_updatesoft:function(newnode,oldnode,ids,css,n){for(var updates=[],news=this._assistant.index(newnode.childNodes),olds=this._assistant.index(oldnode.childNodes),child=newnode.lastElementChild,topid=this._assistant.id(oldnode),oldid=null,newid=null;child;)newid=this._assistant.id(child),olds[newid]?oldid=newid:oldid?updates.push(new edb.InsertUpdate(this._doc).setup(oldid,child)):updates.push(new edb.AppendUpdate(this._doc).setup(topid,child)),child=child.previousElementSibling;Object.keys(olds).forEach(function(id){if(news[id]){var n1=news[id],n2=olds[id];this._scan(n1,n2,n1,id,ids,css,n)}else updates.push(new edb.RemoveUpdate(this._doc).setup(id))},this),updates.reverse().forEach(function(update){this._updates.collect(update,ids)},this)}},edb.UpdateCollector=function(){this._updates=[],this._hardupdates=new Set},edb.UpdateCollector.prototype={_updates:null,_hardupdates:null,toString:function(){return"[object edb.UpdateCollector]"},collect:function(update,ids){this._updates.push(update),update.type===edb.Update.TYPE_HARD?this._hardupdates.add(update.id):update.ids=ids},hardupdates:function(id){return this._hardupdates.has(id)},eachRelevant:function(action){this._updates.filter(function(update){return update.type===edb.Update.TYPE_HARD||Object.keys(update.ids).every(function(id){return!this.hardupdates(id)},this)},this).forEach(function(update){action(update)})},dispose:function(){delete this._hardupdates,delete this._updates}},edb.Update=gui.Class.create(Object.prototype,{type:null,id:null,window:null,document:null,onconstruct:function(doc){this.window=doc.defaultView,this.document=doc},setup:function(){return this},update:function(){},element:function(){var spirit,element=null;if(gui.KeyMaster.isKey(this.id)?(spirit=this.window.gui.get(this.id))&&(element=spirit.element):element=this.document.getElementById(this.id),!element){console.error("No element to match @id: "+this.id);var all=this.window.gui._spirits.inside;Object.keys(all).forEach(function(key){var elm=all[key].element;console.debug(key,elm.localName,elm.className)})}return element},dispose:function(){this.window=null,this.document=null},_beforeUpdate:function(element){var event="x-beforeupdate-"+this.type;return this._dispatch(element,event)},_afterUpdate:function(element){var event="x-aftrerupdate-"+this.type;return this._dispatch(element,event)},_dispatch:function(element,name){var event=this.document.createEvent("UIEvents");return event.initEvent(name,!0,!0),element.dispatchEvent(event)},_report:function(report){this.window.gui.debug&&(gui.KeyMaster.isKey(this.id)&&(report=report.replace(this.id,"(anonymous)")),console.debug(report))}},{},{TYPE_HARD:"hard",TYPE_ATTS:"atts",TYPE_INSERT:"insert",TYPE_APPEND:"append",TYPE_REMOVE:"remove",TYPE_FUNCTION:"function"}),edb.AttsUpdate=edb.Update.extend({type:edb.Update.TYPE_ATTS,_xold:null,_xnew:null,_summary:null,onconstruct:function(doc){this._super.onconstruct(doc),this._summary=[]},setup:function(id,xnew,xold){return this._super.setup(),this.id=id,this._xnew=xnew,this._xold=xold,this},update:function(){this._super.update();var element=this.element();this._beforeUpdate(element)&&(this._update(element),this._afterUpdate(element),this._report())},dispose:function(){this._super.dispose(),delete this._xold,delete this._xnew},_update:function(element){Array.forEach(this._xnew.attributes,function(newatt){var oldatt=this._xold.getAttribute(newatt.name);(null===oldatt||oldatt!==newatt.value)&&(this._set(element,newatt.name,newatt.value),this._summary.push("@"+newatt.name))},this),Array.forEach(this._xold.attributes,function(oldatt){this._xnew.hasAttribute(oldatt.name)||(this._del(element,oldatt.name,null),this._summary.push("@"+oldatt.value))},this)},_set:function(element,name,value){var spirit=element.spirit;if(spirit)spirit.att.set(name,value);else switch(element.setAttribute(name,value),name){case"checked":element.checked||(element.checked=!0);break;case"value":element.value!==value&&(element.value=value+"")}},_del:function(element,name){var spirit=element.spirit;if(spirit)spirit.att.del(name);else switch(name){case"checked":element.checked=!1;break;default:element.removeAttribute(name)}},_report:function(){this._super._report('edb.AttsUpdate "#'+this.id+'" '+this._summary.join(", "))}}),edb.HardUpdate=edb.Update.extend({type:edb.Update.TYPE_HARD,xelement:null,setup:function(id,xelement){return this._super.setup(),this.id=id,this.xelement=xelement,this},update:function(){this._super.update();var element=this.element();element&&this._beforeUpdate(element)&&(gui.DOMPlugin.html(element,this._serialize()),this._afterUpdate(element),this._report())},dispose:function(){this._super.dispose(),delete this.xelement},_serialize:function(){var xhtml=(new XMLSerializer).serializeToString(this.xelement);return xhtml.contains("</")&&(xhtml=xhtml.slice(xhtml.indexOf(">")+1,xhtml.lastIndexOf("<"))),xhtml},_report:function(){this._super._report("edb.HardUpdate #"+this.id)}}),edb.SoftUpdate=edb.Update.extend({xelement:null,type:null,dispose:function(){this._super.dispose(),delete this.xelement},_import:function(parent){var temp=this.document.createElement(parent.nodeName);return temp.innerHTML=(new XMLSerializer).serializeToString(this.xelement),temp.firstChild}}),edb.InsertUpdate=edb.SoftUpdate.extend({type:edb.Update.TYPE_INSERT,xelement:null,setup:function(id,xelement){return this.id=id,this.xelement=xelement,this},update:function(){var sibling=this.element(),parent=sibling.parentNode,child=this._import(parent);this._beforeUpdate(parent)&&(parent.insertBefore(child,sibling),this._afterUpdate(child),this._report())},_report:function(){this._super._report("edb.InsertUpdate #"+this.xelement.getAttribute("id"))}}),edb.AppendUpdate=edb.SoftUpdate.extend({type:edb.Update.TYPE_APPEND,setup:function(id,xelement){return this.id=id,this.xelement=xelement,this},update:function(){var parent=this.element(),child=this._import(parent);this._beforeUpdate(parent)&&(parent.appendChild(child),this._afterUpdate(child),this._report())},_report:function(){this._super._report("edb.AppendUpdate #"+this.xelement.getAttribute("id"))}}),edb.RemoveUpdate=edb.SoftUpdate.extend({type:edb.Update.TYPE_REMOVE,setup:function(id){return this.id=id,this},update:function(){var element=this.element(),parent=element.parentNode;this._beforeUpdate(element)&&(parent.removeChild(element),this._afterUpdate(parent),this._report())},_report:function(){this._super._report("edb.RemoveUpdate #"+this.id)}}),edb.FunctionUpdate=edb.Update.extend({type:"function",onconstruct:function(doc){this._super.onconstruct(doc),this._summary=[]},setup:function(spirit,selector,attname,newkey,oldkey){return this._super.setup(),this._spirit=spirit,this._selector=selector,this._attname=attname,this._newkey=newkey,this._oldkey=oldkey,this},update:function(){this._super.update();var element=null;try{element=this._spirit.dom.q(this._selector)}catch(domexception){throw Error("Bad selector: "+this._selector)}finally{if(!element)throw Error("No such element: "+this._selector);this._beforeUpdate(element)&&(this._update(element,this._attname,this._newkey,this._oldkey),this._afterUpdate(element),this._report())}},_spirit:null,_selector:null,_attname:null,_oldkey:null,_newkey:null,_update:function(element,attname,newkey,oldkey){var newval,oldval=element.getAttribute(attname);oldval&&oldval.contains(oldkey)?(newval=oldval.replace(oldkey,newkey),element.setAttribute(attname,newval)):console.warn("Softupdate dysfunction or what?")},_report:function(){this._super._report("edb.FunctionUpdate "+this._selector)}}),window.edb.EDBModule=gui.module("edb",{fieldselector:null,mixins:{oninput:function(){},onchange:function(){}},plugins:{script:edb.ScriptPlugin,input:edb.InputPlugin,output:edb.OutputPlugin},channels:[["script[type='text/edbml']","edb.ScriptSpirit"],["link[rel='service']","edb.ServiceSpirit"]],onafterspiritualize:function(context){var doc=context.document;gui.Client.isGecko?(doc.addEventListener("focus",this,!0),doc.addEventListener("blur",this,!0)):(doc.addEventListener("focusin",this,!0),doc.addEventListener("focusout",this,!0))},handleEvent:function(e){switch(e.type){case"focusin":case"focus":this.fieldselector=this._fieldselector(e.target);break;case"focusout":case"blur":this.fieldselector=null}},_fieldselector:function(elm){function hasid(elm){if(elm.id)try{return gui.DOMPlugin.q(elm.parentNode,elm.id),!0}catch(malformedexception){}return!1}for(var index=-1,parts=[];null!==elm;)hasid(elm)?(parts.push("#"+elm.id),elm=null):(index=gui.DOMPlugin.ordinal(elm)+1,parts.push(">"+elm.localName+":nth-child("+index+")"),elm=elm.parentNode);return parts.reverse().join("")}});