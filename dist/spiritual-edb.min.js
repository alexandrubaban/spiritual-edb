/**
 * Spiritual EDB
 * (c) 2013 Wunderbyte
 * Spiritual is freely distributable under the MIT license.
 */
!function(t){"use strict";t.edb=gui.namespace("edb",{debug:!1,useblobs:!1,BROADCAST_ACCESS:"edb-broadcast-access",BROADCAST_CHANGE:"edb-broadcast-change",BROADCAST_OUTPUT:"edb-broadcast-output",BROADCAST_SCRIPT_INVOKE:"edb-broadcast-script-invoke",TICK_SCRIPT_UPDATE:"edb-tick-script-update",TICK_COLLECT_INPUT:"edb-tick-collect-input",TICK_PUBLISH_CHANGES:"edb-tick-update-changes",set:function(t,e){return edb.Script.$assign(t,e)},get:function(t,e){return edb.Script.$tempname(t,e)},go:function(t,e,n){edb.Script.$register(t),edb.Script.$invoke(e,n)}}),edb.Relay=function(){return{synchronize:function(t){t.addObserver(this);var e={onbroadcast:function(e){var n=e.data;n.some(function(e){return e.$instanceid!==t.$instanceid})&&n.forEach(function(e){t[e.name]!==e.newValue&&(t.$synchronizing=!0,t[e.name]=e.newValue)})}};gui.Broadcast.add(t.$originalid||t.$instanceid,e)},onchange:function(t){var e={},n={};t.forEach(function(t){var i=t.object;if(i.$synchronizing)n[i.$instanceid]=i;else{var r=gui.Object.copy(t);delete r.object,r.$instanceid=i.$instanceid;var s=i.$originalid||i.$instanceid;e[s]=e[s]||[],e[s].push(r)}}),gui.Object.each(e,function(t,e){gui.Broadcast.dispatch(null,t,e)}),gui.Object.each(n,function(t,e){e.$synchronizing=!1})}}}(),edb.Type=function(){},edb.Type.prototype={$id:null,$originalid:null,_instanceid:null,onconstruct:function(){},ondestruct:function(){},output:function(t){return edb.Output.dispatch(this,t),this},dispose:function(){this.$ondestruct()},stringify:function(){console.log("Deprecated API is deprecated")},GET:function(){throw new Error("Not supported. Use "+this.constructor+".GET(optionalid)")},PUT:function(t){return this.constructor.PUT(this,t)},POST:function(t){return this.constructor.POST(this,t)},DELETE:function(t){return this.constructor.DELETE(this,t)},$onconstruct:function(){edb.Type.underscoreinstanceid(this)},$ondestruct:function(){}},gui.Object.each({$sync:!1,getter:gui.Combo.before(function(){gui.Broadcast.dispatch(this,edb.BROADCAST_ACCESS,this._instanceid)}),setter:gui.Combo.after(function(){gui.Broadcast.dispatch(this,edb.BROADCAST_CHANGE,this._instanceid)}),decorateGetters:function(t,e){return e.forEach(function(e){t[e]=edb.Type.getter(t[e])}),t},decorateSetters:function(t,e){return e.forEach(function(e){t[e]=edb.Type.setter(t[e])}),t},underscoreinstanceid:function(t){Object.defineProperty(t,"_instanceid",{value:t.$instanceid})},is:function(t){return edb.Object.is(t)||edb.Array.is(t)},isConstructor:function(t){return gui.Type.isConstructor(t)&&t.$classname&&gui.Class.ancestorsAndSelf(t).some(function(t){return t===edb.Object||t===edb.Array})},lookup:function(t,e){var n=null;switch(gui.Type.of(e)){case"function":n=e;break;case"string":n=gui.Object.lookup(e,t);break;case"object":console.error(this+": expected edb.Type constructor (not an object)")}if(!n)throw new TypeError('The type "'+e+'" does not exist');return n},cast:function(t){if(gui.Type.isComplex(t)&&!edb.Type.is(t))switch(gui.Type.of(t)){case"object":return new edb.Object(t);case"array":return new edb.Array(t)}return t},$observe:function(t,e){var n=t.$instanceid||t._instanceid,i=this._observers,r=i[n]||(i[n]=[]);return-1===r.indexOf(e)&&r.push(e),t},$unobserve:function(t,e){var n,i=t.$instanceid||t._instanceid,r=this._observers,s=r[i];return s&&(n=s.indexOf(e))>-1&&0===gui.Array.remove(s,n)&&delete r[i],t}},function(t,e){edb.Type[t]=e}),function(){var t={out:function(){return edb.Output.out(this)}},e={from:function(t){var e=this;return edb.Type.is(t)&&(t=t.toJSON()),new e(t)},sync:function(t){var e;return edb.Type.is(t)&&(t=(new edb.Serializer).serializeToString(t),t=(new edb.Parser).parseFromString(t,null)),edb.Relay.$sync=!0,e=this.from(t),edb.Relay.$sync=!1,e}},n={uri:null,primarykey:"_id",GET:function(){return this.$httpread.apply(this,arguments)},PUT:function(t,e){return this.$httpupdate("PUT",t,e)},POST:function(t,e){return this.$httpupdate("POST",t,e)},DELETE:function(t,e){return this.$httpupdate("DELETE",t,e)},$httpread:function(){var t,e,n,i=this,r=new gui.Then;return Array.forEach(arguments,function(t){switch(gui.Type.of(t)){case"string":e=t;break;case"object":n=t}}),t=gui.URL.parametrize(this.uri,n),this.$httprequest(t,"GET",null,function(t){r.now(i.$httpresponse(t))}),r},$httpupdate:function(t,e,n){var i=this,r=new gui.Then,s=gui.URL.parametrize(e.uri,n),u=gui.Type.isInstance(e)?e.toJSON():e;return this.$httprequest(s,t||"PUT",u,function(e){r.now(i.$httpresponse(e,n,t))}),r},$httprequest:function(t,e,n,i){var r=new gui.Request(t);e=e.toLowerCase(),r[e](n).then(function(t,e){i(e)})},$httpresponse:function(t){var e=this;switch(gui.Type.of(t)){case"object":case"array":t=new e(t)}return t}};[t,n,e].forEach(function(t){gui.Object.each(t,function(t,e){edb.Type[t]=e})}),edb.Type.$staticmixins=function(){var i={};return[n,t,e].forEach(function(t){Object.keys(t).forEach(function(e){i[e]=t[e]},this)},this),i}}(),edb.Object=function(t){return gui.Class.create(Object.prototype,{addObserver:t(function(t){edb.Object.observe(this,t)}),removeObserver:t(function(t){edb.Object.unobserve(this,t)}),$onconstruct:function(t){switch(edb.Type.prototype.$onconstruct.apply(this,arguments),gui.Type.of(t)){case"object":case"undefined":var e=gui.Object.copy(t||{}),n=edb.ObjectPopulator.populate(e,this);edb.ObjectProxy.approximate(e,this,n),edb.Relay.$sync&&edb.Type.synchronize(this);break;default:throw new TypeError("Unexpected edb.Object constructor argument of type "+gui.Type.of(t)+": "+String(t))}this.onconstruct(),this.oninit&&console.error("Deprecated API is deprecated: "+this+".oninit")},toJSON:function(){var t,e={};return gui.Object.each(this,function(n,i){t=n.charAt(0),"$"!==t&&"_"!==t&&(edb.Type.is(i)&&(i=i.toJSON()),e[n]=i)}),e}})}(gui.Combo.chained),edb.Object.mixin(null,edb.Type.$staticmixins(),{observe:edb.Type.$observe,unobserve:edb.Type.$unobserve,ontick:function(t){var e,n,i,r,s=this._observers;t.type===edb.TICK_PUBLISH_CHANGES&&(e=gui.Object.copy(this._changes),this._changes=Object.create(null),gui.Object.each(e,function(t){(r=s[t])&&(n=gui.Object.each(e,function(e,n){return i=n[Object.keys(n)[0]],e===t?i:null}).filter(function(t){return null!==t}),r.forEach(function(t){t.onchange(n)})),gui.Broadcast.dispatch(null,edb.BROADCAST_CHANGE,t)}))},$onaccess:function(t,e){var n=new edb.ObjectAccess(t,e);gui.Broadcast.dispatch(null,edb.BROADCAST_ACCESS,n.instanceid)},$onchange:function(t,e,n,i){var r=this._changes,s=t._instanceid,u=r[s]=r[s]||(r[s]=Object.create(null));u[e]=new edb.ObjectChange(t,e,edb.ObjectChange.TYPE_UPDATE,n,i),gui.Tick.dispatch(edb.TICK_PUBLISH_CHANGES)},_observers:Object.create(null),_changes:Object.create(null)}),function(){gui.Tick.add(edb.TICK_PUBLISH_CHANGES,edb.Object),gui.Object.extendmissing(edb.Object.prototype,edb.Type.prototype)}(),function(t,e){function n(t,e){return edb.ArrayPopulator.convert(t,e)}function i(t,e,n,i){edb.Array._onchange(t,e,n,i)}function r(t){var e=t.$instanceid||t._instanceid;return edb.Array._observers[e]?!0:!1}edb.Array=gui.Class.create(t,{push:function(){var e=this.length,s=n(this,arguments),u=t.push.apply(this,s);return r(this)&&i(this,e,null,s),u},pop:function(){var e=this.length-1,n=t.pop.apply(this);return r(this)&&i(this,e,[n],null),n},shift:function(){var e=t.shift.apply(this);return r(this)&&i(this,0,[e],null),e},unshift:function(){var e=n(this,arguments),s=t.unshift.apply(this,e);return r(this)&&i(this,0,null,e),s},splice:function(){var e=arguments,s=e[0],u=n(this,[].slice.call(e,2)),o=[s,e[1]].concat(u),c=t.splice.apply(this,o);return r(this)&&i(this,s,c,u),c},reverse:function(){if(r(this)){var e=this.toJSON(),n=t.reverse.apply(e.slice());i(this,0,e,n)}return t.reverse.apply(this)},onconstruct:function(){},addObserver:e(function(t){edb.Object.observe(this,t),edb.Array.observe(this,t)}),removeObserver:e(function(t){edb.Object.unobserve(this,t),edb.Array.unobserve(this,t)}),$of:null,$onconstruct:function(){var t,e;t=arguments.length?arguments[0].$object||{}:{},edb.Type.prototype.$onconstruct.apply(this,arguments),edb.ArrayPopulator.populate(this,arguments),e=edb.ObjectPopulator.populate(t,this),edb.ObjectProxy.approximate(t,this,e),this.onconstruct([].slice.call(this))},toJSON:function(){return Array.map(this,function(t){return edb.Type.is(t)?t.toJSON():t})}})}(Array.prototype,gui.Combo.chained),edb.Array.mixin(null,edb.Type.$staticmixins(),{observe:edb.Type.$observe,unobserve:edb.Type.$unobserve,isConstructor:function(t){return gui.Type.isConstructor(t)&&gui.Class.ancestorsAndSelf(t).indexOf(edb.Array)>-1},ontick:function(t){var e,n,i=this._observers;t.type===edb.TICK_PUBLISH_CHANGES&&(e=gui.Object.copy(this._changes),this._changes=Object.create(null),gui.Object.each(e,function(t,e){(n=i[t])&&n.forEach(function(t){t.onchange(e)})}))},_observers:Object.create(null),_changes:Object.create(null),_onaccess:function(){},_onchange:function(t,e,n,i){var r=t.$instanceid||t._instanceid,s=this._changes,u=s[r]||(s[r]=[]);u.push(new edb.ArrayChange(t,e,n,i)),gui.Tick.dispatch(edb.TICK_PUBLISH_CHANGES)}}),function(t){edb.Type.decorateGetters(t,["filter","forEach","every","map","some","indexOf","lastIndexOf"]),edb.Type.decorateSetters(t,["push","unshift","splice","pop","shift","reverse"])}(edb.Array.prototype),function(){gui.Tick.add(edb.TICK_PUBLISH_CHANGES,edb.Array),gui.Object.extendmissing(edb.Array.prototype,edb.Type.prototype)}(),edb.ObjectPopulator=function(t,e,n,i){function r(t){var e=edb.Object.is(t)?edb.Object:edb.Array,n=edb.Object.is(t)?Object:Array,i=[],r=[edb.Type,e,n];return gui.Object.all(t,function(t){a(t)&&r.every(function(e){return void 0===e.prototype[t]})&&i.push(t)}),i}function s(t,e,n){Object.defineProperty(t,e,gui.Property.nonenumerable({value:n}))}function u(t,e){var n=t.$instanceid;n&&(s(e,"$originalid",n),delete t.$instanceid)}function o(t,e){throw new TypeError(t+' declares "'+e+'" as something undefined')}function c(t,e){throw new TypeError(t+' "'+e+'" must resolve to a constructor')}function a(t){return t.match(/^[a-z]/i)}return{populate:function(s,d){var h,p,l,f,b=Object.create(null),_=d.constructor.prototype,g=d.constructor.$classname;return u(s,d),r(d).forEach(function(r){p=d[r],l=s[r],t(l)?t(p)?e(p)&&(n(p)?(i(p)||(p=p(l)),i(p)?(h=p,b[r]=new h(s[r])):c(g,r)):b[r]=edb.Type.cast(t(l)?l:p)):o(g,r):a(r)&&edb.Type.isConstructor(p)?(s[r]=edb.Array.isConstructor(p)?[]:null,h=p,b[r]=new h(s[r])):(f=Object.getOwnPropertyDescriptor(_,r))&&Object.defineProperty(s,r,f)}),gui.Object.nonmethods(s).forEach(function(t){var e=s[t];a(t)&&gui.Type.isComplex(e)&&(b[t]||(b[t]=edb.Type.cast(e)))}),b}}}(gui.Type.isDefined,gui.Type.isComplex,gui.Type.isFunction,gui.Type.isConstructor),edb.ArrayPopulator=function(){function t(t){return t.$of&&t.$of.prototype.reverse}function e(t){return Array.isArray(t)||edb.Array.is(t)}function n(t,e){var n=e,i=gui.Type.isConstructor(n);return t.map(function(t){if(void 0!==t&&!t._instanceid){if(n=i?n:e(t),!n.$classid)throw new TypeError;t=new n(t)}return t})}function i(t){return t.map(function(t){if(!edb.Type.is(t))switch(gui.Type.of(t)){case"object":return new edb.Object(t);case"array":return new edb.Array(t)}return t})}return{populate:function(n,i){var r=i[0];r&&(!t(n)&&e(r)&&(i=r),Array.prototype.push.apply(n,this.convert(n,i)))},convert:function(t,e){return e=gui.Array.from(e),gui.Type.isFunction(t.$of)?n(e,t.$of):i(e)}}}(),edb.ObjectProxy=function(){function t(t,e){return function(){var n=e.apply(this);return edb.Object.$onaccess(this,t),n}}function e(t,e){return function(n){var i=this[t];e.apply(this,arguments),n!==i&&(edb.Object.$onchange(this,t,i,n),i=n)}}return{approximate:function(n,i,r){gui.Object.nonmethods(n).forEach(function(s){var u=Object.getOwnPropertyDescriptor(n,s);u.configurable&&Object.defineProperty(i,s,{enumerable:u.enumerable,configurable:u.configurable,get:t(s,function(){return u.get?u.get.call(this):r[s]||n[s]}),set:e(s,function(t){var e,i;u.set?u.set.call(this,t):(i=r[s])?(e=i.constructor,r[s]=new e(t)):n[s]=edb.Type.cast(t)})})}),gui.Object.ownmethods(n).forEach(function(t){i[t]=n[t]})}}}(),edb.ObjectAccess=function(t,e){this.instanceid=t._instanceid,this.object=t,this.name=e},edb.ObjectAccess.prototype={instanceid:null,object:null,name:null},edb.ArrayAccess=function(t){this.array=t},edb.ArrayAccess.prototype={array:null},edb.Change=function(){},edb.Change.prototype={object:null,type:null},edb.ObjectChange=function(t,e,n,i,r){this.object=t,this.name=e,this.type=n,this.oldValue=i,this.newValue=r},edb.ObjectChange.prototype={name:null,oldValue:void 0,newValue:void 0},edb.ObjectChange.TYPE_UPDATE="update",edb.ArrayChange=function(t,e,n,i){this.type=edb.ArrayChange.TYPE_SPLICE,this.object=t,this.index=e,this.removed=n||[],this.added=i||[]},edb.ArrayChange.prototype=gui.Object.create(edb.Change.prototype,{index:-1,removed:null,added:null}),edb.ArrayChange.TYPE_SPLICE="splice",edb.Output={toString:function(){return"[object edb.Output]"},dispatch:function(t,e){var n,i=this._configure(t.constructor,t);e?(n=e.$oninput||e.oninput)&&n.call(e,i):gui.Broadcast.dispatch(null,edb.BROADCAST_OUTPUT,i)},out:function(t){var e=t.$classid,n=this._map[e];return n?!0:!1},onbroadcast:function(t){t.type===gui.BROADCAST_WILL_UNLOAD&&this._onunload()},_map:{},_configure:function(t,e){var n=t.$classid;return this._map[n]=e,new edb.Input(e)},_onunload:function(){gui.Object.each(this._map,function(t,e){e.$ondestruct()}),this._map=null},$get:function(t){var e=t.$classid,n=this._map[e];return n?new edb.Input(n):null}},edb.OutputPlugin=gui.Plugin.extend({dispatch:function(t,e){return console.error("edb.OutputPlugin is deprecated"),edb.Output.dispatch(this.context,t,e)},exists:function(t){return console.error("edb.OutputPlugin is deprecated"),edb.Output.out(t,this.context||self)}}),edb.Input=function(t){if(this.$instanceid=gui.KeyMaster.generateKey(),!edb.Type.is(t))throw new TypeError(t+" is not a Type");this.type=t.constructor,this.data=t},edb.Input.prototype={type:null,data:null,$instanceid:null,toString:function(){return"[object edb.Input]"}},edb.InputPlugin=gui.Tracker.extend({done:!0,onconstruct:function(){this._super.onconstruct(),this.context=self,this._watches=[],this._matches=[],this._needing=[]},ondestruct:function(){this._super.ondestruct(),this.remove(this._watches)},add:gui.Combo.chained(function(t,e,n){e=e?e:this.spirit,t=edb.InputPlugin._breakdown(t,this.context),t.length&&(this.done=this.done&&n===!1,this._add(t,e,n),this._subscribe(!0))}),remove:gui.Combo.chained(function(t,e){e=e?e:this.spirit,t=edb.InputPlugin._breakdown(t,this.context),t.length&&(this._remove(t,e),this.done=this._done())}),get:function(t){var e=this._matches.map(function(t){return t.data.constructor}),n=edb.InputPlugin._bestmatch(t,e),i=n?this._matches.filter(function(t){return t.type===n}).shift():null;return i?i.data:null},onbroadcast:function(t){t.type===edb.BROADCAST_OUTPUT&&this.match(t.data)},match:function(t){this._matches.every(function(e){return e.$instanceid!==t.$instanceid})&&this._maybeinput(t)},_watches:null,_matches:null,_needing:null,_add:function(t,e,n){t.forEach(function(t){if(!gui.Type.isDefined(t))throw new TypeError("Could not register input for undefined Type");this._addchecks(t.$classid,[e]),this._watches.push(t),n&&this._needing.push(t)},this),t.forEach(function(t){t.out(this.context)&&this._maybeinput(edb.Output.$get(t,this.context))},this)},_remove:function(t,e){t.forEach(function(t){gui.Array.remove(this._watches,t),gui.Array.remove(this._needing,t),this._removechecks(t.$classid,[e]),this._watches.length||this._subscribe(!1)},this)},_maybeinput:function(t){var e=edb.InputPlugin._bestmatch(t.type,this._watches);e&&(this._updatematch(t),this.done=this._done(),this._updatehandlers(t))},_updatematch:function(t){var e=this._matches,n=e.map(function(t){return t.type}),i=edb.InputPlugin._bestmatch(t.type,n);if(i){var r=e.filter(function(t){return t.type===i})[0],s=e.indexOf(r);e[s]=t}else e.push(t)},_updatehandlers:function(t){gui.Class.ancestorsAndSelf(t.type,function(e){var n=this._trackedtypes[e.$classid];n&&n.forEach(function(e){var n=e[0];n.oninput(t)})},this)},_done:function(){var t=this._needing,e=this._matches;return t.every(function(t){return e.some(function(e){return e.data instanceof t})})},_subscribe:function(t){gui.Broadcast[t?"add":"remove"](edb.BROADCAST_OUTPUT,this,this.context.gui.$contextid)}},{},{_breakdown:function(t,e){return gui.Type.isArray(t)?this._breakarray(t,e):this._breakother(t,e)},_breakarray:function(t,e){return t.map(function(t){switch(gui.Type.of(t)){case"function":return t;case"string":return gui.Object.lookup(t,e);case"object":console.error("Expected function. Got object.")}},this)},_breakother:function(t,e){switch(gui.Type.of(t)){case"function":return[t];case"string":return this._breakarray(t.split(" "),e);case"object":console.error("Expected function. Got object.")}},_bestmatch:function(t,e){var n=null,i=Number.MAX_VALUE;return this._rateall(t,e,function(t,e){e>-1&&i>e&&(n=t)}),n},_rateall:function(t,e,n){e.forEach(function(e){n(e,this._rateone(t,e))},this)},_rateone:function(t,e){if(t===e)return 0;var n=gui.Class.ancestorsAndSelf(t),i=gui.Class.descendantsAndSelf(t),r=n.indexOf(e),s=i.indexOf(e);return 0>r?s:r}}),edb.ScriptPlugin=function(t,e){return gui.Plugin.extend({loaded:!1,ran:!1,debug:!1,input:null,onconstruct:function(){this._super.onconstruct(),this.inputs=this.inputs.bind(this)},ondestruct:function(){this._super.ondestruct(),this.loaded&&(this.spirit.life.remove(gui.LIFE_ENTER,this),gui.Tick.remove(edb.TICK_SCRIPT_UPDATE,this),gui.Broadcast.remove([edb.BROADCAST_ACCESS,edb.BROADCAST_CHANGE],this),this.input&&this.input.ondestruct())},load:t(e("function|string")(function(t){(t=t.bind?t:gui.Object.lookup(t))&&(this.loaded=!0,this._script=t,this._updater=new edb.UpdateManager(this.spirit),this._process(t.$instructions),this.input||this.run())})),oninput:function(t){this.input.match(t),this.input.done&&this.run()},run:function(){this.loaded?this.spirit.life.entered?this.write(this._run.apply(this,arguments)):(this.spirit.life.add(gui.LIFE_ENTER,this),this._arguments=arguments):console.error(this.spirit,"No script loaded")},write:function(t){var e=this._html!==t;e&&(this._html=t,this._stayfocused(function(){this._updater.update(t)}),this.spirit.onrender({changed:e,first:!this.ran})),this.ran=!0},inputs:function(t){return this.input.get(t)},onbroadcast:function(t){var e=this._triggers;switch(t.type){case edb.BROADCAST_ACCESS:e[t.data]=!0;break;case edb.BROADCAST_CHANGE:if(e[t.data]){var n=edb.TICK_SCRIPT_UPDATE;gui.Tick.one(n,this).dispatch(n,0)}}},ontick:function(t){switch(t.type){case edb.TICK_SCRIPT_UPDATE:this.run()}},onlife:function(t){t.type===gui.LIFE_ENTER&&(this.spirit.life.remove(t.type,this),this._arguments&&this.run.apply(this,this._arguments))},_src:null,_script:null,_updater:null,_triggers:null,_arguments:null,_html:null,_process:function(t){if(t){var e=[],n=[];t.reduce(function(t,i){if("input"===i.type){var r=i.atts.required===!1?e:n;return r.push(gui.Object.lookup(i.atts.type)),!0}return t},!1)&&(this.input=new edb.InputPlugin,this.input.add(n,this,!0),this.input.add(e,this,!1))}},_subscribe:function(t){gui.Broadcast[t?"add":"remove"](edb.BROADCAST_ACCESS,this),gui.Broadcast[t?"remove":"add"](edb.BROADCAST_CHANGE,this)},_run:function(){this._triggers={},this._subscribe(!0);var t=this._script.apply(this.spirit,arguments);return this._subscribe(!1),t},_stayfocused:function(t){var e,n=edb.EDBModule.fieldselector;if(t.call(this),n&&(e=gui.DOMPlugin.q(this.spirit.document,n),e&&"#"+e.id!==n&&e&&gui.DOMPlugin.contains(this.spirit,e))){e.focus();var i="textarea,input:not([type=checkbox]):not([type=radio])";gui.CSSPlugin.matches(e,i)&&e.setSelectionRange(e.value.length,e.value.length),this._restorefocus(e)}},_restorefocus:function(t){var e="textarea,input:not([type=checkbox]):not([type=radio])";t.focus(),gui.CSSPlugin.matches(t,e)&&t.setSelectionRange(t.value.length,t.value.length)},_debugwarning:function(){var t=edb.ScriptPlugin;t._warning&&this.spirit.window.gui.debug&&(console.debug(t._warning),t._warning=null)}},{},{_warning:"Spiritual: Form elements with a unique @id may be updated without losing the undo-redo stack (now gone)."})}(gui.Combo.chained,gui.Arguments.confirmed),edb.ScriptSpirit=gui.Spirit.extend({id:null,onenter:function(){this._super.onenter();var t,e=this.dom.parent(gui.Spirit);e&&(t=this.id)&&e.script.load(gui.Object.lookup(t))}}),edb.Serializer=function(){function t(){}function e(t){return edb.Type.is(t)}function n(t){return edb.Array.is(t)}function i(t){return n(t)?s(t):r(t)}function r(t){var e=gui.Object.map(t,u,t);return{$object:gui.Object.extend(e,{$classname:t.$classname,$instanceid:t.$instanceid})}}function s(t){return gui.Object.extend(r(t),{$array:o(t)})}function u(t,r){return n(this)&&t.match(/^length|^\d+/)?void 0:e(r)?i(r):r}function o(t){return Array.map(t,function(t){return e(t)?i(t):t})}return t.prototype={serializeToString:function(t,n,r){if(e(t))return JSON.stringify(i(t),n,r);throw alert(t),new TypeError("Expected edb.Object|edb.Array")}},t}(),edb.Parser=function(){function t(){}function e(t,e){var n,i;if(null===e||(e?(i=e.$classname||i,n=i?e:gui.Object.lookup(i)):(i=t.$object.$classname,n=gui.Object.lookup(i))),t=u(t),null===e)return t;if(n)return n.from(t);throw new TypeError(i+" is not defined")}function n(t){return gui.Type.isComplex(t)&&t.$array||t.$object}function i(t){return gui.Object.map(t.$object,s)}function r(t){var e=t.$array.map(u);return e.$object=t.$object,e}function s(t,e){return u(e)}function u(t){return n(t)?t.$array?r(t):i(t):t}return t.prototype={parseFromString:function(t,i){if(t=JSON.parse(t),n(t))return e(t,i);throw new TypeError("Expected serialized edb.Object|edb.Array")}},t}(),edb.Att=function(t){t&&gui.Object.extend(this,t)},edb.Att.prototype=gui.Object.create(null,{toString:function(){return"[object edb.Att]"},_out:function(t){var e=this[t],n="";switch(gui.Type.of(e)){case"null":case"undefined":break;default:e=edb.Att.encode(this[t]),n+=t+'="'+e+'" '}return n},_pop:function(t){var e=this._out(t);return delete this[t],e},_all:function(){var t="";return gui.Object.nonmethods(this).forEach(function(e){t+=this._out(e)},this),t}}),edb.Att.encode=function(t){var e=gui.Type.of(t);switch(e){case"string":break;case"number":case"boolean":t=String(t);break;case"object":case"array":try{t=encodeURIComponent(JSON.stringify(t))}catch(n){throw new Error("Could not create HTML attribute: "+n)}break;case"date":throw new Error("TODO: edb.Att.encode standard date format?");default:throw new Error("Could not create HTML attribute for "+e)}return t},edb.Out=function(){},edb.Out.prototype={html:"",toString:function(){return"[object edb.Out]"},write:function(){return this.html}},edb.Script={$assign:function(t,e){var n=gui.KeyMaster.generateKey();return edb.Script._invokables[n]=function(n,i){return t.apply(e,[gui.Type.cast(n),i])},n},$revoke:function(t){edb.Script._invokables[t]=null,delete edb.Script._invokables[t]},$invoke:function(t,e,n){var i=null;if(n=n||this._log,e)gui.Broadcast.dispatchGlobal(this,edb.BROADCAST_SCRIPT_INVOKE,{key:t,sig:e,log:n});else{if(!(i=this._invokables[t]))throw new Error("Invokable does not exist: "+t);n?"click"===n.type?gui.Tick.next(function(){i(n.value,n.checked)}):i(n.value,n.checked):i()}},$register:function(t){return this._log=t?{type:t.type,value:t.target.value,checked:t.target.checked}:null,this},$tempname:function(t,e){var n;if(!e){if(n=this._invokables[t])return n();throw new Error("out of synch")}console.error("TODO")},_invokables:Object.create(null),_log:null},edb.UpdateAssistant={id:function(t){return gui.Type.isDefined(t.id)?t.id||null:t.getAttribute("id")||null},parse:function(t,e,n,i){return i=t.createElement(i.localName),i.innerHTML=e,i.id=n,Array.forEach(i.querySelectorAll("option"),function(t){switch(t.getAttribute("selected")){case"true":t.setAttribute("selected","selected");break;case"false":t.removeAttribute("selected")}}),Array.forEach(i.querySelectorAll("input[type=checkbox],input[type=radio]"),function(t){switch(t.getAttribute("checked")){case"true":t.setAttribute("checked","checked");break;case"false":t.removeAttribute("checked")}}),i},order:function(t){var e=new Map;return Array.forEach(t,function(t,n){t.nodeType===Node.ELEMENT_NODE&&e.set(this.id(t),n)},this),e},index:function(t){var e=Object.create(null);return Array.forEach(t,function(t){t.nodeType===Node.ELEMENT_NODE&&(e[this.id(t)]=t)},this),e}},edb.UpdateManager=function(t){this._keyid=t.dom.id()||t.$instanceid,this._spirit=t,this._doc=t.document},edb.UpdateManager.prototype={toString:function(){return"[object edb.UpdateManager]"},update:function(t){this._updates=new edb.UpdateCollector,this._functions={},this._olddom?(this._next(t),this._updates.collect(new edb.FunctionUpdate(this._doc).setup(this._keyid,this._functions))):this._first(t),this._updates.eachRelevant(function(t){t.update(),t.dispose()}),this._updates&&this._updates.dispose(),delete this._updates},_keyid:null,_doc:null,_spirit:null,_olddom:null,_nedwdom:null,_updates:null,_assistant:edb.UpdateAssistant,_first:function(t){this._olddom=this._parse(t),this._updates.collect(new edb.HardUpdate(this._doc).setup(this._keyid,this._olddom))},_next:function(t){this._newdom=this._parse(t),this._crawl(this._newdom,this._olddom,this._newdom,this._keyid,{}),this._olddom=this._newdom},_parse:function(t){return this._assistant.parse(this._doc,t,this._keyid,this._spirit.element)},_crawl:function(t,e,n,i,r){for(var s=!0;t&&e&&!this._updates.hardupdates(i);){switch(t.nodeType){case Node.TEXT_NODE:s=this._check(t,e,n,i,r);break;case Node.ELEMENT_NODE:s=this._scan(t,e,n,i,r)}t=t.nextSibling,e=e.nextSibling}return s},_scan:function(t,e,n,i,r){var s=!0,u=this._assistant.id(e);return(s=this._check(t,e,n,i,r))&&(u&&(r=gui.Object.copy(r),n=t,r[u]=!0,i=u),s=this._crawl(t.firstChild,e.firstChild,n,i,r)),s},_check:function(t,e,n,i,r){var s=!0,u=!1,o=!1;if(t&&!e||!t&&e)s=!1;else if(s=t.nodeType===e.nodeType)switch(e.nodeType){case Node.TEXT_NODE:t.data!==e.data&&(s=!1);break;case Node.ELEMENT_NODE:(s=this._familiar(t,e))&&(s=this._checkatts(t,e,r))&&(this._maybesoft(t,e)?(this._confirmsoft(t,e)&&(this._updatesoft(t,e,r),u=!0),s=!1):"textarea"!==e.localName&&(s=t.childNodes.length===e.childNodes.length,!s&&e.id&&(n=t,i=e.id)))}return s||u||o||(this._updates.collect(new edb.FunctionUpdate(this._doc).setup(i)),this._updates.collect(new edb.HardUpdate(this._doc).setup(i,n))),s},_familiar:function(t,e){return["namespaceURI","localName"].every(function(n){return t[n]===e[n]})},_checkatts:function(t,e,n){var i=!0,r=null;if(this._attschanged(t.attributes,e.attributes,n)){var s=this._assistant.id(t),u=this._assistant.id(e);s&&s===u?(r=new edb.AttsUpdate(this._doc).setup(u,t,e),this._updates.collect(r,n)):i=!1}return i},_attschanged:function(t,e){var n=t.length!==e.length;return n||(n=!Array.every(t,function(t){var n=e.getNamedItem(t.name);return n&&n.value===t.value}),n&&(n=!Array.every(t,function(t){var n=e.getNamedItem(t.name);return this._functionchanged(t.value,n.value)?!0:t.value===n.value},this))),n},_functionchanged:function(t,e){var n=gui.KeyMaster.extractKey(t),i=gui.KeyMaster.extractKey(e);return n&&i?(i.forEach(function(t,e){this._functions[t]=n[e]},this),!0):!1},_maybesoft:function(t,e){return t&&e?t.id&&t.id===e.id&&this._maybesoft(t)&&this._maybesoft(e):Array.every(t.childNodes,function(t){var e=!0;switch(t.nodeType){case Node.TEXT_NODE:e=""===t.data.trim();break;case Node.ELEMENT_NODE:e=null!==this._assistant.id(t)}return e},this)},_confirmsoft:function(t,e){var n=!0,i=null,r=this._assistant.order(e.childNodes);return Array.every(t.childNodes,function(t){if(t.nodeType===Node.ELEMENT_NODE){var e=this._assistant.id(t);r.has(e)&&r.has(i)&&(n=r.get(e)>r.get(i)),i=e}return n},this)},_updatesoft:function(t,e,n){for(var i=[],r=this._assistant.index(t.childNodes),s=this._assistant.index(e.childNodes),u=t.lastElementChild,o=this._assistant.id(e),c=null,a=null;u;)a=this._assistant.id(u),s[a]?c=a:c?i.push(new edb.InsertUpdate(this._doc).setup(c,u)):i.push(new edb.AppendUpdate(this._doc).setup(o,u)),u=u.previousElementSibling;Object.keys(s).forEach(function(t){if(r[t]){var e=r[t],u=s[t];this._scan(e,u,e,t,n)}else i.push(new edb.RemoveUpdate(this._doc).setup(t)),i.push(new edb.FunctionUpdate(this._doc).setup(t))},this),i.reverse().forEach(function(t){this._updates.collect(t,n)},this)}},edb.UpdateCollector=function(){this._updates=[],this._hardupdates=new Set},edb.UpdateCollector.prototype={_updates:null,_hardupdates:null,toString:function(){return"[object edb.UpdateCollector]"},collect:function(t,e){return this._updates.push(t),t.type===edb.Update.TYPE_HARD?this._hardupdates.add(t.id):t.ids=e||{},this},hardupdates:function(t){return this._hardupdates.has(t)},eachRelevant:function(t){this._updates.filter(function(t){return t.type===edb.Update.TYPE_HARD||Object.keys(t.ids).every(function(t){return!this.hardupdates(t)},this)},this).forEach(function(e){t(e)})},dispose:function(){delete this._hardupdates,delete this._updates}},edb.Update=gui.Class.create(Object.prototype,{type:null,id:null,ids:null,window:null,document:null,onconstruct:function(t){this.window=t.defaultView,this.document=t},setup:function(){return this},update:function(){},element:function(){var t,e=null;return gui.KeyMaster.isKey(this.id)&&(t=this.window.gui.get(this.id))&&(e=t.element),e=e||this.document.getElementById(this.id),e||console.error("No element to match @id: "+this.id),e},dispose:function(){this.window=null,this.document=null},_beforeUpdate:function(t){var e="x-beforeupdate-"+this.type;return this._dispatch(t,e)},_afterUpdate:function(t){var e="x-afterupdate-"+this.type;return this._dispatch(t,e)},_dispatch:function(t,e){var n=this.document.createEvent("UIEvents");return n.initEvent(e,!0,!0),t.dispatchEvent(n)},_report:function(t){edb.debug&&(gui.KeyMaster.isKey(this.id)&&(t=t.replace(this.id,"(anonymous)")),console.debug(t))}},{},{TYPE_HARD:"hard",TYPE_ATTS:"atts",TYPE_INSERT:"insert",TYPE_APPEND:"append",TYPE_REMOVE:"remove",TYPE_FUNCTION:"function"}),edb.AttsUpdate=edb.Update.extend({type:edb.Update.TYPE_ATTS,_xold:null,_xnew:null,_summary:null,onconstruct:function(t){this._super.onconstruct(t),this._summary=[]},setup:function(t,e,n){return this._super.setup(),this.id=t,this._xnew=e,this._xold=n,this},update:function(){this._super.update();var t=this.element();this._beforeUpdate(t)&&(this._update(t),this._afterUpdate(t),this._report())},dispose:function(){this._super.dispose(),delete this._xold,delete this._xnew},_update:function(t){Array.forEach(this._xnew.attributes,function(e){var n=this._xold.getAttribute(e.name);(null===n||n!==e.value)&&(this._set(t,e.name,e.value),this._summary.push("@"+e.name))},this),Array.forEach(this._xold.attributes,function(e){this._xnew.hasAttribute(e.name)||(this._del(t,e.name,null),this._summary.push("@"+e.value))},this)},_set:function(t,e,n){var i=t.spirit;if(i)i.att.set(e,n);else switch(t.setAttribute(e,n),e){case"checked":t.checked||(t.checked=!0);break;case"value":t.value!==n&&(t.value=String(n))}},_del:function(t,e){var n=t.spirit;if(n)n.att.del(e);else switch(e){case"checked":t.checked=!1;break;default:t.removeAttribute(e)}},_report:function(){this._super._report('edb.AttsUpdate "#'+this.id+'" '+this._summary.join(", "))}}),edb.HardUpdate=edb.Update.extend({type:edb.Update.TYPE_HARD,xelement:null,setup:function(t,e){return this._super.setup(),this.id=t,this.xelement=e,this},update:function(){this._super.update();var t=this.element();t&&this._beforeUpdate(t)&&(gui.DOMPlugin.html(t,this.xelement.innerHTML),this._afterUpdate(t),this._report())},dispose:function(){this._super.dispose(),delete this.xelement},_report:function(){this._super._report("edb.HardUpdate #"+this.id)}}),edb.SoftUpdate=edb.Update.extend({xelement:null,type:null,dispose:function(){this._super.dispose(),delete this.xelement},_import:function(t){var e=this.document.createElement(t.nodeName);return e.innerHTML=this.xelement.outerHTML,e.firstChild}}),edb.InsertUpdate=edb.SoftUpdate.extend({type:edb.Update.TYPE_INSERT,xelement:null,setup:function(t,e){return this.id=t,this.xelement=e,this
},update:function(){var t=this.element(),e=t.parentNode,n=this._import(e);this._beforeUpdate(e)&&(e.insertBefore(n,t),this._afterUpdate(n),this._report())},_report:function(){this._super._report("edb.InsertUpdate #"+this.xelement.getAttribute("id"))}}),edb.AppendUpdate=edb.SoftUpdate.extend({type:edb.Update.TYPE_APPEND,setup:function(t,e){return this.id=t,this.xelement=e,this},update:function(){var t=this.element(),e=this._import(t);this._beforeUpdate(t)&&(t.appendChild(e),this._afterUpdate(e),this._report())},_report:function(){this._super._report("edb.AppendUpdate #"+this.xelement.getAttribute("id"))}}),edb.RemoveUpdate=edb.SoftUpdate.extend({type:edb.Update.TYPE_REMOVE,setup:function(t){return this.id=t,this},update:function(){var t=this.element(),e=t.parentNode;this._beforeUpdate(t)&&(e.removeChild(t),this._afterUpdate(e),this._report())},_report:function(){this._super._report("edb.RemoveUpdate #"+this.id)}}),edb.FunctionUpdate=edb.Update.extend({type:edb.Update.TYPE_FUNCTION,setup:function(t,e){return this.id=t,this._map=e||null,this},update:function(){var t=0,e=this.element();this._map?(t=edb.FunctionUpdate._remap(e,this._map))&&this._report("remapped "+t+" keys"):(t=edb.FunctionUpdate._revoke(e))&&this._report("revoked "+t+" keys")},_report:function(t){this._super._report("edb.FunctionUpdate "+t)}},{_revoke:function(t){var e,n=0;return this._getatts(t).forEach(function(t){e=gui.KeyMaster.extractKey(t.value),e&&e.forEach(function(t){edb.Script.$revoke(t),n++})}),n},_remap:function(t,e){var n,i,r=0;return Object.keys(e).length&&this._getatts(t).forEach(function(t){(n=gui.KeyMaster.extractKey(t.value))&&n.forEach(function(n){(i=e[n])&&(t.value=t.value.replace(n,i),edb.Script.$revoke(n),r++)})}),r},_getatts:function(t){var e=[];return(new gui.Crawler).descend(t,{handleElement:function(t){Array.forEach(t.attributes,function(t){t.value.contains("edb.go")&&e.push(t)})}}),e}}),edb.EDBModule=gui.module("edb",{fieldselector:null,mixins:{src:function(t){if(gui.Type.isString(t)&&(t=gui.Object.lookup(t)),!gui.Type.isFunction(t))throw new TypeError;this.script.load(t)},onrender:function(){},onchange:function(){},oninput:function(){},$oninput:function(t){this.script.input.match(t)}},plugins:{script:edb.ScriptPlugin,input:edb.InputPlugin,output:edb.OutputPlugin},channels:[[".gui-script","edb.ScriptSpirit"]],oncontextinitialize:function(t){var e,n,i;if(!t.event)try{t.event=null}catch(r){}t.gui.portalled||(e=t.gui.AttConfigPlugin)&&(n=e.prototype,i=n.$evaluate,n.$evaluate=function(e,n,r){if(gui.Type.isString(n)&&n.startsWith("edb.get")){var s=gui.KeyMaster.extractKey(n)[0];n=s?t.edb.get(s):s}return i.call(this,e,n,r)})},onafterspiritualize:function(t){var e=t.document;gui.Client.isGecko?(e.addEventListener("focus",this,!0),e.addEventListener("blur",this,!0)):(e.addEventListener("focusin",this,!0),e.addEventListener("focusout",this,!0))},handleEvent:function(t){switch(t.type){case"focusin":case"focus":this.fieldselector=this._fieldselector(t.target);break;case"focusout":case"blur":this.fieldselector=null}},_fieldselector:function(t){function e(t){if(t.id)try{return gui.DOMPlugin.q(t.parentNode,t.id),!0}catch(e){}return!1}for(var n=-1,i=[];t&&t.nodeType===Node.ELEMENT_NODE;)e(t)?(i.push("#"+t.id),t=null):"body"===t.localName?(i.push("body"),t=null):(n=gui.DOMPlugin.ordinal(t)+1,i.push(">"+t.localName+":nth-child("+n+")"),t=t.parentNode);return i.reverse().join("")}})}(this);